<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>tools.plotting API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../tools.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;tools</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#saveplot">saveplot</a>
            </li>
            <li>
                    <a class="function" href="#get_color_list">get_color_list</a>
            </li>
            <li>
                    <a class="function" href="#plot_original_and_rebinned_example_spectrum">plot_original_and_rebinned_example_spectrum</a>
            </li>
            <li>
                    <a class="function" href="#plot_mean_spectra_by_isotope_and_detector">plot_mean_spectra_by_isotope_and_detector</a>
            </li>
            <li>
                    <a class="function" href="#plot_example_spectra_by_isotopes">plot_example_spectra_by_isotopes</a>
            </li>
            <li>
                    <a class="function" href="#plot_cos_sim_matrix_means">plot_cos_sim_matrix_means</a>
            </li>
            <li>
                    <a class="function" href="#plot_loadings_subplots">plot_loadings_subplots</a>
            </li>
            <li>
                    <a class="function" href="#plot_confusion_matrix">plot_confusion_matrix</a>
            </li>
            <li>
                    <a class="function" href="#plot_misclassified_spectra">plot_misclassified_spectra</a>
            </li>
            <li>
                    <a class="function" href="#plot_denoised_spectrum_example">plot_denoised_spectrum_example</a>
            </li>
            <li>
                    <a class="function" href="#plot_misclassification_statistics">plot_misclassification_statistics</a>
            </li>
            <li>
                    <a class="function" href="#plot_scores_scatter_matrix">plot_scores_scatter_matrix</a>
            </li>
            <li>
                    <a class="function" href="#plot_mean_scores_barplot">plot_mean_scores_barplot</a>
            </li>
            <li>
                    <a class="function" href="#identify_misclassifications">identify_misclassifications</a>
            </li>
            <li>
                    <a class="function" href="#plot_outlier_confusion">plot_outlier_confusion</a>
            </li>
            <li>
                    <a class="function" href="#plot_feature_importance">plot_feature_importance</a>
            </li>
            <li>
                    <a class="function" href="#plot_fitted_sigmoid">plot_fitted_sigmoid</a>
            </li>
            <li>
                    <a class="function" href="#plot_metrics_vs_threshold">plot_metrics_vs_threshold</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../tools.html">tools</a><wbr>.plotting    </h1>

                
                        <input id="mod-plotting-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-plotting-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlines</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpatches</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">confusion_matrix</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.tools_model</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="k">def</span><span class="w"> </span><span class="nf">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">    Saves open matplotlib figure in directory dir_saveplot.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">    :param save_plot: True if plot should be saved to folder, False if plot is displayed.</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">    :param name: includes information on isotope and (optionally) detector, e.g. &#39;Am241_right&#39;</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">    :type name: str</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">    :param title: title of the plot</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">    :type title: str</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>    <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>                <span class="s2">&quot;dir_plots&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>            <span class="p">):</span>  <span class="c1"># Check if dir_plots is defined in the global scope</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>                    <span class="s2">&quot;The directory for saving plots (&#39;dir_plots&#39;) is not defined.&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>                <span class="p">)</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>            <span class="c1"># convert &#39;Am241_right&#39; to &#39;Am241&#39; but leave &#39;Am241_Ba133_Co60&#39; unchanged</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>            <span class="n">isotope</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>                <span class="n">name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>                    <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">all_detectors</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>                <span class="p">)</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>                <span class="k">else</span> <span class="n">name</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>            <span class="p">)</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>            <span class="n">dir_saveplot</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dir_plots</span><span class="p">,</span> <span class="n">isotope</span><span class="p">)</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_saveplot</span><span class="p">):</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_saveplot</span><span class="p">)</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>            <span class="n">savename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dir_saveplot</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.svg&quot;</span><span class="p">)</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving figure to </span><span class="si">{</span><span class="n">savename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>        <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred while saving the plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_color_list</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">    Counts n_iso, the number of different (unique) isotopes in labels.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">    Builds dictionary that assigns each isotope to a color and applies this mapping to labels.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">    :param labels: list of labels, does not have to be unique (can be a flat or nested list)</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">    :type labels: List[str]</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">    :return: color_list: list of color (same length as labels), assigning each label to a color.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">            color_dict: dictionary where each (unique) isotope is assigned one color</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">    :rtype: Tuple[List, Dict[str, float]]</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>    <span class="n">nested</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="kc">True</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="p">)</span>  <span class="c1"># check if labels is a nested list</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>    <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="n">distinct_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>            <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">)</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="p">)</span>  <span class="c1"># create list of isotopes</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># for flat list</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="n">distinct_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>  <span class="c1"># create list of isotopes</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>    <span class="n">n_iso</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">distinct_labels</span><span class="p">)</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>    <span class="n">denomi</span> <span class="o">=</span> <span class="n">n_iso</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">n_iso</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">n_iso</span>  <span class="c1"># denominater</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>    <span class="n">distinct_colors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">denomi</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iso</span><span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>    <span class="p">]</span>  <span class="c1"># pick n_iso distinct colors</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>    <span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">distinct_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">distinct_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iso</span><span class="p">)}</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>    <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># for flat list</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>    <span class="k">return</span> <span class="n">color_list</span><span class="p">,</span> <span class="n">color_dict</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_original_and_rebinned_example_spectrum</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data_ori</span><span class="p">,</span> <span class="n">data_rebinned</span><span class="p">):</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>    <span class="k">if</span> <span class="s2">&quot;background&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="n">data_ori</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_ori</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]]</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="n">data_rebinned</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_rebinned</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]]</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>    <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_ori</span><span class="p">))</span>  <span class="c1"># pick random spectrum</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>    <span class="n">int_ori</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_ori</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">])))</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>    <span class="n">int_rebinned</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_rebinned</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">])))</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>    <span class="n">leg_ori</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Original </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> spectrum Nr. </span><span class="si">{</span><span class="n">kk</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">int_ori</span><span class="si">}</span><span class="s2"> counts)&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>    <span class="n">leg_rebinned</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Rebinned </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> spectrum Nr. </span><span class="si">{</span><span class="n">kk</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">int_rebinned</span><span class="si">}</span><span class="s2"> counts)&quot;</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_ori</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg_ori</span><span class="p">)</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_rebinned</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg_rebinned</span><span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Channel&quot;</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Counts&quot;</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_mean_spectra_by_isotope_and_detector</span><span class="p">(</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>    <span class="n">iso_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">zoom_in</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">save_plots</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="p">):</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">    Calculates mean spectra of all isotopes given in names_list, for each detector individually.</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">    Two subplots per isotope: 1. original mean spectra (with bg), 2. normalized mean spectra (bg subtracted).</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">    The cosine similarity (measure for similarity between spectra) between the means of different detectors is</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">    calculated and displayed in right subplot.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">    Only works for single-label spectra or spectra containing one isotope + background.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">    :param iso_list: list of isotopes to be shown, e.g. [&#39;Am241&#39;, &#39;Co60&#39;, &#39;Ir192&#39;]</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">    :type iso_list: List[str]</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="sd">    :param zoom_in: Option to zoom into the lower end of the spectra</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">    :type zoom_in: bool</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">    :param save_plots: Option to save the plots to folder.</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">    :type save_plots: bool</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>    <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">iso_list</span><span class="p">:</span>  <span class="c1"># iterates over isotopes</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Mean &amp; standard error of preprocessed spectra&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="n">means_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="c1"># create dictionary to assign colors to different detectors in plots</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">col_dict</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">all_detectors</span><span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>            <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">all_detectors</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="p">):</span>  <span class="c1"># iterates over all detectors (e.g. [&#39;left&#39;, &#39;right&#39;, &#39;simulated&#39;])</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>            <span class="c1"># mean and standard deviation of all spectra in &lt;name&gt;.npy, isotope and background spectra seperately</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>            <span class="n">mean_bg</span><span class="p">,</span> <span class="n">std_bg</span><span class="p">,</span> <span class="n">mean_iso</span><span class="p">,</span> <span class="n">std_iso</span> <span class="o">=</span> <span class="n">calc_mean</span><span class="p">(</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>                <span class="n">iso</span><span class="p">,</span> <span class="n">dir_numpy_ready</span><span class="p">,</span> <span class="p">[</span><span class="n">det</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>            <span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>            <span class="n">int_iso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mean_iso</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>            <span class="n">int_bg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mean_bg</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>            <span class="k">if</span> <span class="n">int_iso</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>                <span class="n">means_dict</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_iso</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mean_iso</span><span class="p">))</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>                <span class="c1"># left subplot: means (not normalized) with error margins, channels on x axis</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_iso</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">det</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>                    <span class="n">x</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>                    <span class="n">mean_iso</span> <span class="o">-</span> <span class="n">std_iso</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>                    <span class="n">mean_iso</span> <span class="o">+</span> <span class="n">std_iso</span><span class="p">,</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>                    <span class="n">color</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">det</span><span class="p">],</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>                <span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean spectra of </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> (original)&quot;</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;energy channels&quot;</span><span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_iso</span><span class="p">))</span>  <span class="c1"># default</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>                <span class="k">if</span> <span class="n">zoom_in</span><span class="p">:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>                    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>  <span class="c1"># option to zoom into lower channels</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>                <span class="c1"># Background subtraction and normalization</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>                    <span class="s2">&quot;background&quot;</span> <span class="ow">in</span> <span class="n">iso</span> <span class="ow">or</span> <span class="n">det</span> <span class="o">==</span> <span class="s2">&quot;simulated&quot;</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>                <span class="p">):</span>  <span class="c1"># no background subtraction</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>                    <span class="n">pure_iso</span> <span class="o">=</span> <span class="n">mean_iso</span> <span class="o">/</span> <span class="n">int_iso</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>                    <span class="n">std_bg</span> <span class="o">=</span> <span class="n">std_bg</span> <span class="o">/</span> <span class="n">int_bg</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># measured isotope spectra (containing background)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>                    <span class="n">pure_iso</span> <span class="o">=</span> <span class="n">mean_iso</span> <span class="o">-</span> <span class="n">mean_bg</span>  <span class="c1"># subtract background from mean</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>                    <span class="n">pure_iso_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pure_iso</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>                    <span class="n">pure_iso</span> <span class="o">=</span> <span class="n">pure_iso</span> <span class="o">/</span> <span class="n">pure_iso_int</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>                    <span class="n">std_bg</span> <span class="o">=</span> <span class="n">std_bg</span> <span class="o">/</span> <span class="n">pure_iso_int</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>                <span class="c1"># convert channels to energies</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">std_calib</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>                <span class="n">slope</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">std_calib</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>                <span class="n">quad</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">std_calib</span><span class="p">[</span><span class="s2">&quot;quad&quot;</span><span class="p">]</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>                <span class="n">energies</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">quad</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>                <span class="c1"># right subplot: means (normalized) with background subtracted, energies on x axis</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">pure_iso</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">det</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>                    <span class="n">energies</span><span class="p">,</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>                    <span class="n">pure_iso</span> <span class="o">-</span> <span class="n">std_bg</span><span class="p">,</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>                    <span class="n">pure_iso</span> <span class="o">+</span> <span class="n">std_bg</span><span class="p">,</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>                    <span class="n">color</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">det</span><span class="p">],</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>                <span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>                    <span class="sa">f</span><span class="s2">&quot;Mean spectra of </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> (background subtracted, normalized)&quot;</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>                <span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;energy / keV&quot;</span><span class="p">)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>                <span class="k">if</span> <span class="n">zoom_in</span><span class="p">:</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>                        <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>                    <span class="p">)</span>  <span class="c1"># option to zoom into lower channels</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;intensity / a.u.&quot;</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># no spectra found for isotope iso: delete figure</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">means_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="p">):</span>  <span class="c1"># multiple means per isotope / multiple detectors</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>            <span class="n">dets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">means_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="n">means</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">means_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="c1"># create list of all combinations between detectors (e.g. left&amp;right, left&amp;simulated, right&amp;simulated)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>            <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dets</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>            <span class="c1"># loop through all combinations and write cosine similarity in right subplot</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">):</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">means</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>                <span class="n">dettxt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">dets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>                    <span class="sa">f</span><span class="s2">&quot;Cos similarity betw. </span><span class="si">{</span><span class="n">dettxt</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2"> .2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.91</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>                    <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>                <span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;compare_means_of_different_detectors</span><span class="si">{</span><span class="s1">&#39;_zoom&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">zoom_in</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plots</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_example_spectra_by_isotopes</span><span class="p">(</span><span class="n">iso_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">n_spectra</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="sd">    Plots multiple example spectra (one plot per isotope).</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">    Only works for single-label spectra or spectra containing one isotope + background.</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="sd">    :param iso_list: list of isotopes to be shown, e.g. [&#39;Am241&#39;, &#39;Co60&#39;, &#39;Ir192&#39;]</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">    :type iso_list: List[str]</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">    :param n_spectra: &#39;all&#39; or number of maximum spectra plotted</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a><span class="sd">    :type n_spectra: int or str</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a><span class="sd">    :param save_plot: Option to save plot to folder</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>    <span class="n">_</span><span class="p">,</span> <span class="n">color_dict</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="n">iso_list</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>    <span class="p">)</span>  <span class="c1"># dictionary to assign colors to different isotopes in plots</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>    <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">iso_list</span><span class="p">:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_spectral_data</span><span class="p">(</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>            <span class="n">dir_numpy_ready</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">all_detectors</span><span class="p">,</span> <span class="n">include_files</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">.npy&quot;</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        <span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>        <span class="k">if</span> <span class="n">n_spectra</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)),</span> <span class="n">n_spectra</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>            <span class="p">)</span>  <span class="c1"># pick n_spectra spectra randomly</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>            <span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">spectra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>        <span class="n">iso_spectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>            <span class="p">[</span><span class="n">spec</span> <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">lab</span><span class="p">]</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="n">colore</span> <span class="o">=</span> <span class="n">color_dict</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span>  <span class="c1"># get color for isotope</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iso_spectra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iso_spectra</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colore</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;energy channel&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>            <span class="c1"># set up legend with patches</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>            <span class="n">patchy</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colore</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">iso</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">patchy</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>            <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="s2">&quot;example_spectra&quot;</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>                <span class="sa">f</span><span class="s2">&quot;No spectra labelled as </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> found in </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">.npy, cannot be plotted.&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>            <span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_cos_sim_matrix_means</span><span class="p">(</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>    <span class="n">cosine_similarity_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="p">):</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">    Visualizes the cosine similarity as triangular matrix between all isotope spectra means (detectors separately).</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">    Orange-rimmed: means of same isotope, different detector, that are not similar enough (cos_sim &lt; threshold)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">    Red-rimmed: means of different isotopes that are too similar (cos_sim &gt;= threshold)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">    Only works for single-label spectra or spectra containing one isotope + background.</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">    :param cosine_similarity_matrix: cosine similarity matrix between mean spectra of all isotopes and detectors</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">                                    (only lower triangle)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a><span class="sd">    :type cosine_similarity_matrix: np.ndarray</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="sd">    :param names: list of xticklabels</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="sd">    :type names: List[str]</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">    :param threshold: threshold for cosine similarity (minimum value for means of same isotope,</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a><span class="sd">                        maximum value for means of different isotopes)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="sd">    :type threshold: float</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="sa">f</span><span class="s2">&quot;The threshold was set to </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> but has to be a number between -1 and 1!&quot;</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="p">)</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>    <span class="n">n_names</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>    <span class="k">if</span> <span class="p">(</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="n">cosine_similarity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cosine_similarity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>        <span class="ow">or</span> <span class="n">cosine_similarity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_names</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>    <span class="p">):</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="s2">&quot;The cosine similarity matrix must be square and match the length of the names list.&quot;</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>    <span class="c1"># mask upper triangle (no background colors)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cosine_similarity_matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>    <span class="n">masked_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cosine_similarity_matrix</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>    <span class="c1"># plot masked cosine similarity matrix</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>    <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">masked_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_names</span><span class="p">):</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_names</span><span class="p">):</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>            <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">:</span>  <span class="c1"># only lower left triangle</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span> <span class="k">if</span> <span class="n">cosine_similarity_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>                    <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                <span class="p">)</span>  <span class="c1"># write value of cosine similarity into each square</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>                <span class="c1"># Draw orange box around values of same isotope, different detector that are too low (not similar enough)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>                    <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>                    <span class="ow">and</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>                <span class="p">):</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                    <span class="k">if</span> <span class="n">cos_sim</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                            <span class="sa">f</span><span class="s2">&quot;Not similar enough: </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">, cosine similarity=</span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2"> in row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, column </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                        <span class="p">)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>                            <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                                <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>                                <span class="mi">1</span><span class="p">,</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>                                <span class="mi">1</span><span class="p">,</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                                <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>                                <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>                                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>                                <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                            <span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                        <span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                <span class="c1"># Draw red box around values of different values that are too high (too similar)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                <span class="k">if</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                    <span class="k">if</span> <span class="n">cos_sim</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                            <span class="sa">f</span><span class="s2">&quot;Too similar: </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">, cosine similarity=</span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2">, in row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, column </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                        <span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                            <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                                <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                                <span class="mi">1</span><span class="p">,</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>                                <span class="mi">1</span><span class="p">,</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                                <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                                <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;darkred&quot;</span><span class="p">,</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>                                <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                            <span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                        <span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_names</span><span class="p">))</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_names</span><span class="p">))</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[:]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>    <span class="c1"># adjust colorbar</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>        <span class="n">cax</span><span class="p">,</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cosine similarity&quot;</span><span class="p">,</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="n">location</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="n">pad</span><span class="o">=</span><span class="mf">0.17</span><span class="p">,</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="n">aspect</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>    <span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>    <span class="n">cax</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_loadings_subplots</span><span class="p">(</span><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">    Visualize the loadings (transformation matrix from spectral into latent space, consists of stacked mean spectra).</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">    Each mean spectrum of an isotope is plotted in a subplot. In addition, the part of the spectrum considered in model</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">    inference (only channels &gt; min_channel_tr) is highlighted in red.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">    :param save_plot: Option to save the plot.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>    <span class="c1"># get isotopes, number of components and min_channel</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>    <span class="n">isotopes</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>    <span class="n">n_comp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">isotopes</span><span class="p">)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>    <span class="n">min_channel</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">min_channel_tr</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>    <span class="c1"># normalize loadings</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>    <span class="n">loadings_norm</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">loadings_tr</span><span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>    <span class="c1"># set up figure and define colors</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_comp</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">n_comp</span><span class="p">))</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>    <span class="n">color_list</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">isotopes</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">iso</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isotopes</span><span class="p">):</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="c1"># plot normalized loadings</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>            <span class="n">loadings_norm</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;PC </span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>        <span class="p">)</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>        <span class="c1"># plot normalized loadings (only channels &gt; min_channel_tr)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="n">x</span><span class="p">[</span><span class="n">min_channel</span><span class="p">:],</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="n">loadings_norm</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">min_channel</span><span class="p">:],</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="n">c</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;channels ≥ </span><span class="si">{</span><span class="n">min_channel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n_comp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># turn ticks off for all subplots but the last one</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># label for y axes</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>    <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="s2">&quot;Energy channel&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>    <span class="p">)</span>  <span class="c1"># label for x axis: lowest subplot only</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Loadings&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># set title</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>    <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">isotopes</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Loadings_subplots&quot;</span><span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">    Plots the classification results as confusion matrix (predicted vs. true labels) using seaborn.</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">    This reveals which labels were confused in model inference.</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">    Squares are framed in different colors according to correctness and completeness of the classification:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="sd">    - green frame: complete &amp; correct classification (for single-label and multi-label)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">    - golden frame: incomplete, correct classification (only for multi-label)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">    - orange frame: complete, partially incorrect classification (only for multi-label)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a><span class="sd">    - red frame: incomplete, partially incorrect classification (for single-label and multi-label)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">    :type class_type: str</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">    :param save_plot: option to save the plot</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;single-label&quot;</span><span class="p">,</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">]:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="sa">f</span><span class="s1">&#39;Invalid class_type: </span><span class="si">{</span><span class="n">class_type</span><span class="si">}</span><span class="s1">. Must be either &quot;single-label&quot; or &quot;multi-label&quot;.&#39;</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="p">)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;single-label&quot;</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>        <span class="n">labels_true</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>            <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>        <span class="p">]</span>  <span class="c1"># keep only first label (either isotope or pure background)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        <span class="n">labels_predict</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>            <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="p">]</span>  <span class="c1"># keep only first key of dictionary</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>    <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="n">labels_true</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="p">]</span>  <span class="c1"># converts [&#39;Am241&#39;, &#39;background&#39;] to &#39;Am241 background&#39;</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="n">labels_predict</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="p">]</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>    <span class="c1"># create list of class labels (serve as axes of the confusion matrix)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>    <span class="n">class_labels_true</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels_true</span><span class="p">))</span>  <span class="c1"># x axis of confusion matrix</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>    <span class="n">class_labels_predict</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels_predict</span><span class="p">))</span>  <span class="c1"># y axis of confusion matrix</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>    <span class="c1"># map labels to indices</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>    <span class="n">label_to_index_true</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_labels_true</span><span class="p">)}</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>    <span class="n">label_to_index_predict</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_labels_predict</span><span class="p">)}</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>    <span class="c1"># set up empty confusion matrix</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_labels_predict</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_labels_true</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>    <span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>    <span class="c1"># fill confusion matrix by looping over lists of predicted and true labels</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>    <span class="k">for</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels_true</span><span class="p">,</span> <span class="n">labels_predict</span><span class="p">):</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="n">confusion_matrix</span><span class="p">[</span><span class="n">label_to_index_predict</span><span class="p">[</span><span class="n">pred</span><span class="p">],</span> <span class="n">label_to_index_true</span><span class="p">[</span><span class="n">true</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>    <span class="c1"># set up figure &amp; plot confusion matrix as seaborn heatmap</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>    <span class="n">fig_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_labels_true</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>    <span class="n">fig_height</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_labels_predict</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_width</span><span class="p">,</span> <span class="n">fig_height</span><span class="p">))</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="n">confusion_matrix</span><span class="p">,</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;YlGnBu&quot;</span><span class="p">,</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>        <span class="n">xticklabels</span><span class="o">=</span><span class="n">class_labels_true</span><span class="p">,</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="n">yticklabels</span><span class="o">=</span><span class="n">class_labels_predict</span><span class="p">,</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>    <span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>    <span class="c1"># draw frames around the frames with their colors indicating the correctness &amp; completeness of the prediction</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>    <span class="k">for</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels_true</span><span class="p">,</span> <span class="n">labels_predict</span><span class="p">):</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="n">true_idx</span> <span class="o">=</span> <span class="n">label_to_index_true</span><span class="p">[</span><span class="n">true</span><span class="p">]</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="n">pred_idx</span> <span class="o">=</span> <span class="n">label_to_index_predict</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="c1"># green frame: complete &amp; correct classification</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">):</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="c1"># golden frame: incomplete, correct classification</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">)):</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;gold&quot;</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="c1"># orange frame: complete, partially incorrect classification</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)):</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;darkorange&quot;</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="c1"># red frame: incomplete, partially incorrect classification</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)):</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;darkred&quot;</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>            <span class="k">continue</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>                <span class="p">(</span><span class="n">true_idx</span><span class="p">,</span> <span class="n">pred_idx</span><span class="p">),</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="mf">0.93</span><span class="p">,</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                <span class="mf">0.93</span><span class="p">,</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>            <span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;true labels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;predicted labels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Confusion Matrix&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>    <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Confusion_matrix&quot;</span><span class="p">)</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_misclassified_spectra</span><span class="p">(</span><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">    Plots three misclassified spectra, each in one line, in two subplots.</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="sd">    Left side: In addition to the original spectrum, the mean spectrum of the correct and predicted label</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">    are plotted (in green and red) and the scores of the correct and predicted label are printed.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">    Right side: In addition to the original spectrum, the denoised spectrum is plotted and</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="sd">    their cosine similarity is calculated.</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="sd">    :type class_type: str</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">    :param save_plot: option to save the plot</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;single-label&quot;</span><span class="p">,</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">]:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>            <span class="sa">f</span><span class="s1">&#39;Invalid class_type: </span><span class="si">{</span><span class="n">class_type</span><span class="si">}</span><span class="s1">. Must be either &quot;single-label&quot; or &quot;multi-label&quot;.&#39;</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>    <span class="c1"># divide data into correct and erroneous predictions</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>    <span class="n">data_corr</span><span class="p">,</span> <span class="n">data_err</span> <span class="o">=</span> <span class="n">identify_misclassifications</span><span class="p">(</span><span class="n">data_te</span><span class="p">,</span> <span class="n">class_type</span><span class="p">)</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>    <span class="c1"># calculate error ratio over whole test dataset</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>    <span class="n">err_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_err</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_corr</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_err</span><span class="p">))</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>    <span class="c1"># Choose misclassified spectra to be shown</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>    <span class="n">n_show</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>    <span class="n">data_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">data_err</span><span class="p">,</span> <span class="n">n_show</span><span class="p">)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>    <span class="c1"># set up figure</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">2.4</span> <span class="o">*</span> <span class="n">n_show</span><span class="p">))</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Misclassified spectra (</span><span class="si">{</span><span class="n">err_ratio</span><span class="si">:</span><span class="s2"> .2%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_err</span><span class="p">):</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">])</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">/</span> <span class="n">counts</span>  <span class="c1"># normalize spectrum</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>        <span class="c1"># extract scores and map to isotopes in a dictionary</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">])</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="n">scores_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>            <span class="n">iso</span><span class="p">:</span> <span class="n">score</span> <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="p">}</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>        <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;single-label&quot;</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>            <span class="n">label_true</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># extract first true label</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>            <span class="n">label_pred</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                <span class="mi">0</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>            <span class="p">]</span>  <span class="c1"># extract dominant predicted label</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>            <span class="n">label_true</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                <span class="nb">sorted</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>            <span class="p">)</span>  <span class="c1"># converts [&#39;Am241&#39;, &#39;background&#39;] to &#39;Am241 background&#39;</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            <span class="n">label_pred</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>        <span class="c1"># left side: misclassified spectrum and means of true and predicted labels</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>        <span class="n">ax_left</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">n_show</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>        <span class="n">labeltext_left</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;counts: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2"> detector: </span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2"> absorber thickness: </span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;absorber thickness&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>        <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>            <span class="n">spectrum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labeltext_left</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="p">)</span>  <span class="c1"># plot misclassified spectrum</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>        <span class="n">ax_left</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>        <span class="c1"># set up dictionary to map isotopes to principal components (columns of loadings_tr)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="n">loadings_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>            <span class="n">iso</span><span class="p">:</span> <span class="n">pc</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>            <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">pc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">loadings_tr</span><span class="p">)</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>        <span class="p">}</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;single-label&quot;</span><span class="p">:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>            <span class="c1"># extract &amp; normalize mean of predicted isotope</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>            <span class="n">pc_predict</span> <span class="o">=</span> <span class="n">loadings_dict</span><span class="p">[</span><span class="n">label_pred</span><span class="p">]</span>  <span class="c1"># mean spectrum (predicted isotope)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>            <span class="n">pc_predict</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">pc_predict</span><span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>            <span class="c1"># extract &amp; normalize mean of true isotope</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>            <span class="n">pc_true</span> <span class="o">=</span> <span class="n">loadings_dict</span><span class="p">[</span><span class="n">label_true</span><span class="p">]</span>  <span class="c1"># mean spectrum (true isotope)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="n">pc_true</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">pc_true</span><span class="p">)</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>            <span class="c1"># plot both means in left subplot</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>                <span class="n">pc_predict</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;firebrick&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;predicted: </span><span class="si">{</span><span class="n">label_pred</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>            <span class="p">)</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>            <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                <span class="n">pc_true</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;correct label: </span><span class="si">{</span><span class="n">label_true</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>            <span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>            <span class="c1"># annotate predicted and true scores in left subplot</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>            <span class="n">annot_text_left0</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>                <span class="sa">f</span><span class="s2">&quot;scores predict (</span><span class="si">{</span><span class="n">label_pred</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">scores_dict</span><span class="p">[</span><span class="n">label_pred</span><span class="p">]</span><span class="si">:</span><span class="s2"> .3</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>            <span class="p">)</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>            <span class="n">annot_text_left1</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>                <span class="sa">f</span><span class="s2">&quot;scores true (</span><span class="si">{</span><span class="n">label_true</span><span class="si">}</span><span class="s2">) : </span><span class="si">{</span><span class="n">scores_dict</span><span class="p">[</span><span class="n">label_true</span><span class="p">]</span><span class="si">:</span><span class="s2"> .3</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>            <span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="n">annot_text_left</span> <span class="o">=</span> <span class="n">annot_text_left0</span> <span class="o">+</span> <span class="n">annot_text_left1</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>            <span class="n">ax_left</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">annot_text_left</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">)</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>                <span class="c1"># extract &amp; normalize means of predicted isotopes, plot them in left subplot</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>                <span class="n">pc_predict</span> <span class="o">=</span> <span class="n">loadings_dict</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>                <span class="n">pc_predict</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">pc_predict</span><span class="p">)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>                <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>                    <span class="n">pc_predict</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;firebrick&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;predicted: </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>                <span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]:</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>                <span class="k">if</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">loadings_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                    <span class="c1"># extract &amp; normalize means of true isotopes, plot them in left subplot</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                    <span class="n">pc_true</span> <span class="o">=</span> <span class="n">loadings_dict</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                    <span class="n">pc_true</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">pc_true</span><span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>                    <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>                        <span class="n">pc_true</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;correct label: </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                    <span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>                        <span class="sa">f</span><span class="s2">&quot;ERROR: No principal component found for </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">. Maybe </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> was not included in model training?&quot;</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>                    <span class="p">)</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>            <span class="c1"># annotate predicted scores</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_true</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;labels_pred_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>            <span class="n">annot_text_right0</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>                <span class="n">iso</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">sco</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">sco</span> <span class="ow">in</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="p">}</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>            <span class="k">if</span> <span class="n">label_true</span> <span class="ow">in</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                <span class="n">annot_text_right1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;scores true (</span><span class="si">{</span><span class="n">label_true</span><span class="si">}</span><span class="s2">):  </span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;labels_pred_dict&#39;</span><span class="p">][</span><span class="n">label_true</span><span class="p">]</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>                <span class="n">annot_text_right1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">wrap_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>                    <span class="p">[</span><span class="n">text</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">width</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">width</span><span class="p">)]</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                <span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="n">wrap_width</span> <span class="o">=</span> <span class="mi">45</span>  <span class="c1"># maximum width of annotation line</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>            <span class="n">annot_text_right</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>                <span class="sa">f</span><span class="s2">&quot;scores predict: </span><span class="si">{</span><span class="n">wrap_text</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">annot_text_right0</span><span class="p">),</span><span class="w"> </span><span class="n">wrap_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wrap_text</span><span class="p">(</span><span class="n">annot_text_right1</span><span class="p">,</span><span class="w"> </span><span class="n">wrap_width</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>            <span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="n">ax_left</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">annot_text_right</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">)</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>        <span class="n">ax_left</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="n">ax_left</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>        <span class="c1"># extract and normalize denoised spectrum</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>        <span class="n">denoised</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;denoised&quot;</span><span class="p">])</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>        <span class="n">denoised</span> <span class="o">=</span> <span class="n">denoised</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">denoised</span><span class="p">))</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>        <span class="c1"># calculate cosine similarity between origina</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>        <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">denoised</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="c1"># right subplot: original &amp; denoised spectrum</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="n">ax_right</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">n_show</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_true</span><span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">denoised</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;denoised spectrum&quot;</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>            <span class="sa">f</span><span class="s2">&quot;cosine similarity: </span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2"> .3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>        <span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>    <span class="n">saveplot</span><span class="p">(</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>        <span class="n">save_plot</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Misclassified_spectra&quot;</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>    <span class="p">)</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_denoised_spectrum_example</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">    The original and denoised spectrum are plotted for a random example spectrum and their cosine similarity is printed.</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">    :param data: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">    :type data: List[dict]</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>    <span class="n">cherry_picking</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>    <span class="k">if</span> <span class="n">cherry_picking</span><span class="p">:</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="s2">&quot;Cs137&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]]</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>            <span class="n">exp_var</span> <span class="o">=</span> <span class="n">explained_variance_score</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;denoised&quot;</span><span class="p">])</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;exp_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_var</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;exp_var&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.98</span><span class="p">]</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>            <span class="n">x</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">label</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>        <span class="p">]</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>    <span class="c1"># pick a random spectrum and extract original, denoised spectrum, true and predicted labels</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>    <span class="n">n_spectra</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>    <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_spectra</span><span class="p">))</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>    <span class="n">original_spectrum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">]</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>    <span class="n">denoised_spectrum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s2">&quot;denoised&quot;</span><span class="p">]</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>    <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="n">title_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Denoised spectrum (true label: </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="n">title_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Denoised spectrum (true labels: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>    <span class="c1"># labels = labels[0] if len(labels) == 1 else labels  # convert [&#39;Am241&#39;] to &#39;Am241&#39;</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>    <span class="n">labels_pred_dict</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>    <span class="n">labels_pred_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>        <span class="n">iso</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">sco</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">sco</span> <span class="ow">in</span> <span class="n">labels_pred_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>    <span class="p">}</span>  <span class="c1"># round scores</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>    <span class="n">annot_text</span> <span class="o">=</span> <span class="s2">&quot;Predicted isotopes: &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">,&quot;</span> <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">labels_pred_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>    <span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>    <span class="n">annot_text</span> <span class="o">=</span> <span class="n">annot_text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>    <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">original_spectrum</span><span class="p">,</span> <span class="n">denoised_spectrum</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>    <span class="n">exp_var</span> <span class="o">=</span> <span class="n">explained_variance_score</span><span class="p">(</span><span class="n">original_spectrum</span><span class="p">,</span> <span class="n">denoised_spectrum</span><span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title_text</span><span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">original_spectrum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;original spectrum&quot;</span><span class="p">)</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">denoised_spectrum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;denoised spectrum&quot;</span><span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        <span class="n">annot_text</span><span class="p">,</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">),</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>    <span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="sa">f</span><span class="s2">&quot;cosine similarity: </span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2"> .2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>    <span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>        <span class="sa">f</span><span class="s2">&quot;explained variance ratio: </span><span class="si">{</span><span class="n">exp_var</span><span class="si">:</span><span class="s2"> .2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.82</span><span class="p">),</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>    <span class="p">)</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>    <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">original_spectrum</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">denoised_spectrum</span><span class="p">)])</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">1.3</span> <span class="o">*</span> <span class="n">y_max</span><span class="p">)</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;energy channels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_misclassification_statistics</span><span class="p">(</span><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">    Plots histograms of correct (green) and wrong (red) classifications versus different quantities:</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">    - explained variance ratio (measure for the explained variance between original &amp; denoised spectrum)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">    - cosine similarity (measure for the similarity between original &amp; denoised spectrum)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">    - integral of the spectrum (number of counts), e.g. to reveal if spectra with too few counts are more likely to be misclassified</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">    In addition, a threshold can be adjusted for each subplot. It can serve as a decision boundary in a measurement and</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">    classification routine, deciding whether to trust a prediction or not. They can be altered below.</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">    As an example, if the accuracy improves significantly when only predictions with `cosine similarity &gt; 0.85` are considered,</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">    this rule can be applied in the measurement routine.</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="sd">    :type class_type: str</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>    <span class="c1"># divide data into correct and erroneous predictions</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>    <span class="n">data_corr</span><span class="p">,</span> <span class="n">data_err</span> <span class="o">=</span> <span class="n">identify_misclassifications</span><span class="p">(</span><span class="n">data_te</span><span class="p">,</span> <span class="n">class_type</span><span class="p">)</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>    <span class="c1"># set up empty arrays for all quantities (they will be filled in the loop below)</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>    <span class="n">exp_var_corr</span><span class="p">,</span> <span class="n">exp_var_err</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>    <span class="n">exp_var_both</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_var_corr</span><span class="p">,</span> <span class="n">exp_var_err</span><span class="p">]</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>    <span class="n">cos_sim_corr</span><span class="p">,</span> <span class="n">cos_sim_err</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>    <span class="n">cos_sim_both</span> <span class="o">=</span> <span class="p">[</span><span class="n">cos_sim_corr</span><span class="p">,</span> <span class="n">cos_sim_err</span><span class="p">]</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>    <span class="n">abs_corr</span><span class="p">,</span> <span class="n">abs_err</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>    <span class="n">abs_both</span> <span class="o">=</span> <span class="p">[</span><span class="n">abs_corr</span><span class="p">,</span> <span class="n">abs_err</span><span class="p">]</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>    <span class="n">int_corr</span><span class="p">,</span> <span class="n">int_err</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>    <span class="n">int_both</span> <span class="o">=</span> <span class="p">[</span><span class="n">int_corr</span><span class="p">,</span> <span class="n">int_err</span><span class="p">]</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="p">[</span><span class="n">data_corr</span><span class="p">,</span> <span class="n">data_err</span><span class="p">]</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>    <span class="p">):</span>  <span class="c1"># iterate over correct/incorrect data</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>            <span class="k">continue</span>  <span class="c1"># skip loop if list is empty</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>        <span class="c1"># extract original and denoised spectra</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="n">denoised_spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;denoised&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="c1"># calculate explained variance between original and denoised spectra, save to lists</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="n">exp_var_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="k">for</span> <span class="n">ori</span><span class="p">,</span> <span class="n">denoised</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">denoised_spectra</span><span class="p">):</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>            <span class="n">exp_var</span> <span class="o">=</span> <span class="n">calculate_explained_variance</span><span class="p">(</span><span class="n">ori</span><span class="p">,</span> <span class="n">denoised</span><span class="p">)</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>            <span class="n">exp_var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp_var</span><span class="p">)</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="n">exp_var_both</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">exp_var_list</span><span class="p">)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="c1"># calculate cosine similarity between original and denoised spectra, save to lists</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>        <span class="n">cos_sim_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>            <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">denoised_spectra</span><span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="p">]</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="n">cos_sim_both</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cos_sim_list</span><span class="p">)</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="c1"># calculate length of scores vector, save to lists</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="n">absolute_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="n">abs_both</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">absolute_values</span><span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="c1"># calculate integrals of spectra, save to lists</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="n">integrals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectra</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="n">int_both</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">integrals</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>    <span class="c1"># define thresholds / decision boundaries (can be altered)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>    <span class="n">thresh_expvar</span> <span class="o">=</span> <span class="mf">0.95</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>    <span class="n">thresh_cos</span> <span class="o">=</span> <span class="mf">0.95</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>    <span class="n">thresh_int</span> <span class="o">=</span> <span class="mi">2500</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>    <span class="n">thresh_abs</span> <span class="o">=</span> <span class="mf">0.9</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>    <span class="c1"># rearrange lists for plotting</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>    <span class="n">quantities_corr</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_var_corr</span><span class="p">,</span> <span class="n">cos_sim_corr</span><span class="p">,</span> <span class="n">abs_corr</span><span class="p">,</span> <span class="n">int_corr</span><span class="p">]</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>    <span class="n">quantities_err</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_var_err</span><span class="p">,</span> <span class="n">cos_sim_err</span><span class="p">,</span> <span class="n">abs_err</span><span class="p">,</span> <span class="n">int_err</span><span class="p">]</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>    <span class="n">threshs</span> <span class="o">=</span> <span class="p">[</span><span class="n">thresh_expvar</span><span class="p">,</span> <span class="n">thresh_cos</span><span class="p">,</span> <span class="n">thresh_abs</span><span class="p">,</span> <span class="n">thresh_int</span><span class="p">]</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>    <span class="c1"># set up figure with 3 subplots</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>    <span class="n">n_subplots</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_subplots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_subplots</span><span class="p">))</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>    <span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="s2">&quot;explained variance ratio between denoised &amp; original spectrum)&quot;</span><span class="p">,</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="s2">&quot;cosine similarity between denoised &amp; original spectrum&quot;</span><span class="p">,</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="s2">&quot;absolute value / length of scores vector&quot;</span><span class="p">,</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>        <span class="s2">&quot;integral of spectrum (total number of counts)&quot;</span><span class="p">,</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>    <span class="p">]</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>    <span class="c1"># iterate over correct / incorrect predictions</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_corr</span><span class="p">,</span> <span class="n">q_err</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">quantities_corr</span><span class="p">,</span> <span class="n">quantities_err</span><span class="p">)):</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="n">fig2</span><span class="p">,</span> <span class="n">axes2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># set up dummy figure to extract histogram data</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">q_corr</span> <span class="o">+</span> <span class="n">q_err</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">q_corr</span> <span class="o">+</span> <span class="n">q_err</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>        <span class="n">n_corr</span><span class="p">,</span> <span class="n">bins_corr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">axes2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>            <span class="n">q_corr</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>        <span class="p">)</span>  <span class="c1"># histogram data for correct predictions</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="n">n_err</span><span class="p">,</span> <span class="n">bins_err</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">axes2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>            <span class="n">q_err</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="p">)</span>  <span class="c1"># histogram data for incorrect predictions</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>  <span class="c1"># deletes current figure</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>        <span class="c1"># set color for bins below and above threshold</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>        <span class="n">c_corr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lightgrey&quot;</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;green&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">bins_corr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>        <span class="n">c_err</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lightgrey&quot;</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">bins_err</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="c1"># calculate number of correct &amp; incorrect predictions above threshold</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">n_corr_thresh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">q_corr</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="n">n_err_thresh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">q_err</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># first three subplots</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># cos sim and exp. var. are normalized values</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="k">if</span> <span class="n">n_corr_thresh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_err_thresh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>            <span class="n">acc_thresh</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># calculate accuracy in relevant part of histogram (above/below threshold)</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            <span class="n">acc_thresh</span> <span class="o">=</span> <span class="n">n_corr_thresh</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_corr_thresh</span> <span class="o">+</span> <span class="n">n_err_thresh</span><span class="p">)</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="n">ratio_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_corr_thresh</span> <span class="o">+</span> <span class="n">n_err_thresh</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_te</span><span class="p">)</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="c1"># plot histogram</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="n">bins_corr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>            <span class="n">n_corr</span><span class="p">,</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>            <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="n">bins_corr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins_corr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">c_corr</span><span class="p">,</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="p">)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="n">bins_err</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="o">-</span><span class="n">n_err</span><span class="p">,</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>            <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="n">bins_err</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins_err</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">c_err</span><span class="p">,</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="p">)</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>  <span class="c1"># horizontal line at y = 0</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>            <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="p">)</span>  <span class="c1"># vertical line for threshold</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For threshold </span><span class="si">{</span><span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="se">\n</span><span class="si">{</span><span class="n">ratio_thresh</span><span class="si">:</span><span class="s2"> .1%</span><span class="si">}</span><span class="s2"> of the data can be classified with accuracy </span><span class="si">{</span><span class="n">acc_thresh</span><span class="si">:</span><span class="s2"> .1%</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Misclassification statistics&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_scores_scatter_matrix</span><span class="p">(</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>    <span class="n">data_tr</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>    <span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>    <span class="n">class_type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>    <span class="n">n_dim_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>    <span class="n">only_errs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>    <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="p">):</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">    Plots n-dimensional scores as scatter matrix, in each subplot opposing two dimensions / principal components.</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">    Each training spectrum is displayed as scatter point, colored by its true label.</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">    Test data are framed in black and colored by their predicted label.</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">    Optionally, only misclassified test data can be displayed (for only_errs = True).</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">    :param data_tr:  training dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">    :type data_tr: List[Dict]</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">    :type data_te: List[dict]</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">    :type class_type: List[dict]</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">    :param n_dim_max: maximum number of dimension to be plotted. Default: n_dim = 6</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">    :type n_dim_max: int</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">    :param only_errs: option to plot only misclassified test data. Default: only_errs = True</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">    :type only_errs: bool</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">    :param save_plot: option to save the plot</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>    <span class="k">if</span> <span class="n">only_errs</span><span class="p">:</span>  <span class="c1"># option to show only misclassified test data</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">data_te</span> <span class="o">=</span> <span class="n">identify_misclassifications</span><span class="p">(</span><span class="n">data_te</span><span class="p">,</span> <span class="n">class_type</span><span class="p">)</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="s2">&quot;In plot_scores_scatter_matrix, only misclassified test data are displayed.&quot;</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>        <span class="p">)</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>    <span class="c1"># Choose which random training and test data are displayed</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>    <span class="n">n_spectra_tr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_tr</span><span class="p">)</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>    <span class="n">n_spectra_te</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_te</span><span class="p">)</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>    <span class="n">ind_tr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_spectra_tr</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_spectra_tr</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>    <span class="p">)</span>  <span class="c1"># limit displayed training data</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>    <span class="n">ind_te</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_spectra_te</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_spectra_te</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    <span class="p">)</span>  <span class="c1"># limit displayed test data</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>    <span class="n">data_tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_tr</span><span class="p">]</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>    <span class="n">data_te</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_te</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_te</span><span class="p">]</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>    <span class="c1"># extract scores of training and test data</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>    <span class="n">scores_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_tr</span><span class="p">])</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>    <span class="n">scores_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span><span class="p">])</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>    <span class="c1"># extract labels from training and test data, assign to colors</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>    <span class="n">labels_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_tr</span><span class="p">])</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>    <span class="n">labels_pred</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span><span class="p">]</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>    <span class="n">c_tr</span><span class="p">,</span> <span class="n">color_dict</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">labels_tr</span><span class="p">)</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>    <span class="n">c_pr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">labels_pred</span><span class="p">)</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>            <span class="s2">&quot;CAUTION: for the scores scatter matrix, colors only reflect the dominant component of multi-label spectra!&quot;</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>        <span class="p">)</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>    <span class="c1"># determine number of subplots and set up figure</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>    <span class="n">n_dim_real</span> <span class="o">=</span> <span class="n">scores_tr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>    <span class="n">n_rows</span> <span class="o">=</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="n">n_dim_real</span><span class="p">,</span> <span class="n">n_dim_max</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>    <span class="p">)</span>  <span class="c1"># limit number of displayed principal components</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>    <span class="p">)</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">):</span>  <span class="c1"># iterates over rows (dimensions in latent space)</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>            <span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>        <span class="p">):</span>  <span class="c1"># iterates over columns (dimensions in latent space)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">k</span><span class="p">:</span>  <span class="c1"># row &lt;= column</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>                    <span class="s2">&quot;off&quot;</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>                <span class="p">)</span>  <span class="c1"># show only lower left triangle of the figure</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># row &gt; column (lower left triangle): oppose dimension j and dimension k</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>                    <span class="n">scores_tr</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">scores_tr</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_tr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labels_tr</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>                <span class="p">)</span>  <span class="c1"># plot training data</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores_te</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># plot test data</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>                    <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>                        <span class="n">scores_te</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>                        <span class="n">scores_te</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>                        <span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>                        <span class="n">color</span><span class="o">=</span><span class="n">c_pr</span><span class="p">,</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>                    <span class="p">)</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># remove  legend</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>            <span class="c1"># set ticks and ticklabels of subplots</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># turn off ticks for all rows but the last one</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># labels &amp; ticklabels of last row</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># turn off ticks for all columns but the first one</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># labels &amp; ticklabels of first column</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>    <span class="c1"># set up legend</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>    <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">color_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>    <span class="n">tr_marker</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="p">[],</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>        <span class="p">[],</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training data&quot;</span><span class="p">,</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>    <span class="p">)</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>    <span class="n">te_marker</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="p">[],</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="p">[],</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>        <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test data&quot;</span><span class="p">,</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>    <span class="p">)</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>        <span class="n">handles</span><span class="o">=</span><span class="n">patches</span> <span class="o">+</span> <span class="p">[</span><span class="n">tr_marker</span><span class="p">,</span> <span class="n">te_marker</span><span class="p">],</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>    <span class="p">)</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Spectra in latent space: Scores as scatter matrix&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>    <span class="c1"># optionally: save plot to folder</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>    <span class="n">concatname</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>        <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>    <span class="p">)</span>  <span class="c1"># concatenate isotopes to one string as filename</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>    <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="n">concatname</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Scores_in_scatter_matrix&quot;</span><span class="p">)</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_mean_scores_barplot</span><span class="p">(</span><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">    Plots the mean of the predicted scores of each isotope as bar plot (x axes: isotopes_tr).</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">    For multi-label data containing more than one isotope are ignored, only the first label is taken into account.</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="sd">    Only single-label data (not containing background, e.g. simulated spectra) or the combination of one isotope + background are considered.</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">    For single-label classification of spectral data not containing background, this should lead to distinct bars,</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="sd">    each isotope having values close to 1 for its corresponding isotope axis in latent space.</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">    Reveals if the dimensionality reduction succeeds to map single-label spectra mainly to the correct isotope axis</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">    in latent space. This helps to identify which isotopes can be clearly distinguished and which may be mistaken.</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a><span class="sd">    :param class_type: classification type (can be &#39;single-label&#39; or &#39;multi-label&#39;)</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">    :type class_type: str</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a><span class="sd">    :param save_plot: option to save the plot</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean scores cannot be visualized as bar plot for </span><span class="si">{</span><span class="n">class_type</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>        <span class="c1"># extract scores and true labels of test data, assign colors</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>        <span class="n">scores_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span><span class="p">])</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>        <span class="n">labels_te</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span><span class="p">]</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">color_dict</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">labels_te</span><span class="p">)</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>        <span class="c1"># set up figure</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="n">n_iso_tr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>            <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>        <span class="p">)</span>  <span class="c1"># number of isotopes used in model training</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_iso_tr</span><span class="p">)</span>  <span class="c1"># set up x axis</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>        <span class="n">width</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_iso_tr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># calculate width for each x tick</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>        <span class="k">for</span> <span class="n">ll</span><span class="p">,</span> <span class="n">iso</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>        <span class="p">):</span>  <span class="c1"># iterates over isotopes used in model training</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>            <span class="c1"># find all scores labelled as iso or iso + background</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>            <span class="n">ind_iso</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>                <span class="n">ii</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels_te</span><span class="p">)</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>                <span class="k">if</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">lab</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">({</span><span class="n">iso</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">})</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>            <span class="p">]</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>            <span class="n">ind_iso</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels_te</span><span class="p">)</span> <span class="k">if</span> <span class="n">lab</span> <span class="o">==</span> <span class="n">iso</span><span class="p">]</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>            <span class="n">scores_iso</span> <span class="o">=</span> <span class="n">scores_te</span><span class="p">[</span><span class="n">ind_iso</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores_iso</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># test if any scores are found for isotope iso</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>                <span class="n">mean_score_iso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores_iso</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># calculate mean</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>                    <span class="sa">f</span><span class="s2">&quot;ratio of mean </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> scores on </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> axis: </span><span class="si">{</span><span class="n">mean_score_iso</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>                <span class="p">)</span>  <span class="c1"># print score of the correct axis</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>                <span class="c1"># normalize mean scores and standard deviation</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>                <span class="n">int_mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_score_iso</span><span class="p">))</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>                <span class="n">mean_score_iso</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>                    <span class="n">mean_score_iso</span> <span class="o">/</span> <span class="n">int_mean_score</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>                <span class="p">)</span>  <span class="c1"># normalize mean scores</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>                <span class="n">std_score_iso</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scores_iso</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">int_mean_score</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>                <span class="p">)</span>  <span class="c1"># normalize standard deviation</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>                <span class="c1"># plot as bar plot, including error bars</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>                    <span class="n">x</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>                    <span class="n">mean_score_iso</span><span class="p">,</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>                    <span class="n">yerr</span><span class="o">=</span><span class="n">std_score_iso</span><span class="p">,</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>                    <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>                    <span class="n">capsize</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>                    <span class="n">color</span><span class="o">=</span><span class="n">color_dict</span><span class="p">[</span><span class="n">iso</span><span class="p">],</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> spectra&quot;</span><span class="p">,</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>                <span class="p">)</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">)</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>                    <span class="s2">&quot;axis in latent space, corresponding to isotope&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>                <span class="p">)</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;share of scores&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>                    <span class="sa">f</span><span class="s2">&quot;Share of scores (mean value, aggregated by true labels)&quot;</span><span class="p">,</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>                <span class="p">)</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.13</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No spectra found labelled as </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>        <span class="n">concatname</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">)</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>        <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="n">concatname</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;mean_scores_barplot&quot;</span><span class="p">)</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a><span class="k">def</span><span class="w"> </span><span class="nf">identify_misclassifications</span><span class="p">(</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>    <span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a><span class="sd">    Divides test data into datasets with correct / incorrect predictions.</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a><span class="sd">    For class_type = &#39;single-label&#39;, only the first label is considered and background is ignored in labels containing</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a><span class="sd">    one isotope + background.</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a><span class="sd">    For class_type = &#39;multi-label&#39;, all labels are considered and any difference between true and predicted</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a><span class="sd">    labels is counted as error.</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a><span class="sd">    :type class_type: str</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a><span class="sd">    :return: data_corr: subset of data_te with correct predictions,</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a><span class="sd">            data_err: subset of data_te with incorrect predictions</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a><span class="sd">    :rtype: Tuple[List[Dict], List[Dict]]</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;single-label&quot;</span><span class="p">,</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">]:</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>            <span class="sa">f</span><span class="s1">&#39;Invalid class_type: </span><span class="si">{</span><span class="n">class_type</span><span class="si">}</span><span class="s1">. Must be either &quot;single-label&quot; or &quot;multi-label&quot;.&#39;</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="p">)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>    <span class="c1"># copy data_te (for safe alterations of the variable without affecting it outside of the function)</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data_te</span><span class="p">)</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;single-label&quot;</span><span class="p">:</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="n">labels_te</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>  <span class="c1"># extract true labels of test data</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">labels_te</span><span class="p">]</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>        <span class="p">):</span>  <span class="c1"># check if data_te contains multi-label data</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>                <span class="sa">f</span><span class="s2">&quot;You chose </span><span class="si">{</span><span class="n">class_type</span><span class="si">=}</span><span class="s2"> but your test data contain multi-label spectra!&quot;</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>            <span class="p">)</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>        <span class="c1"># filter out background from isotope spectra (convert [&#39;Am241&#39;, &#39;background&#39;] to [&#39;Am241&#39;])</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>        <span class="n">labels_te_without_bg</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>            <span class="n">l</span> <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels_te</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>        <span class="p">]</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>        <span class="c1"># overwrite property &#39;labels&#39; in data with background-filtered labels</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>        <span class="k">for</span> <span class="n">da</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_te_without_bg</span><span class="p">):</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>            <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lab</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>        <span class="c1"># subdivide data into datasets with correct / incorrect predictions (only first label counts)</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>        <span class="n">data_corr</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="p">]</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>        <span class="n">data_err</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="p">]</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>    <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>        <span class="c1"># concatenate list of true and predicted labels for each spectrum: [&#39;Am241&#39;, &#39;Co60&#39;] -&gt; &#39;Am241 Co60&#39;</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>        <span class="n">labels_te</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>        <span class="n">labels_pred</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>        <span class="c1"># subdivide data into datasets with only-correct / incorrect predictions</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>        <span class="n">data_corr</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_te</span><span class="p">,</span> <span class="n">labels_pred</span><span class="p">)</span> <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">true</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>        <span class="p">]</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="n">data_err</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_te</span><span class="p">,</span> <span class="n">labels_pred</span><span class="p">)</span> <span class="k">if</span> <span class="n">pred</span> <span class="o">!=</span> <span class="n">true</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>        <span class="p">]</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>    <span class="k">return</span> <span class="n">data_corr</span><span class="p">,</span> <span class="n">data_err</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_outlier_confusion</span><span class="p">(</span><span class="n">test_targets</span><span class="p">,</span> <span class="n">prediction</span><span class="p">):</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a><span class="sd">    Plot a confusion matrix to compare actual vs predicted outlier labels.</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="sd">    Parameters:</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="sd">    - test_targets (array-like): True labels of test data (0 for known, 1 for unknown).</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">    - prediction (array-like): Predicted labels from the model (0 for known, 1 for unknown).</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">test_targets</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>    <span class="c1"># Plot the confusion matrix using seaborn heatmap</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>        <span class="n">cm</span><span class="p">,</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>        <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>        <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>        <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Known </span><span class="se">\n</span><span class="s2">isotope&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown </span><span class="se">\n</span><span class="s2">isotope&quot;</span><span class="p">],</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>        <span class="n">yticklabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Known </span><span class="se">\n</span><span class="s2">isotope&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown </span><span class="se">\n</span><span class="s2">isotope&quot;</span><span class="p">],</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>    <span class="p">)</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Predicted Labels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Actual Labels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Confusion Matrix&quot;</span><span class="p">)</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_feature_importance</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a><span class="sd">    Visualize feature importance using a scatter plot.</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a><span class="sd">    Parameters:</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a><span class="sd">    - feature_names (list of str): Names of the features used in the model.</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="sd">    - y (array-like): Importance scores for each feature.</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>    <span class="n">fig_featureimportance</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;feature importance / a.u.&quot;</span><span class="p">)</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_fitted_sigmoid</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">x_fit</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">):</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a><span class="sd">    Plot the data points and fitted sigmoid curve for logistic regression on cosine similarity.</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a><span class="sd">    Parameters:</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a><span class="sd">    - x_data (array-like): X-axis data points (cosine similarity scores).</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a><span class="sd">    - y_data (array-like): Y-axis data points (outlier labels).</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a><span class="sd">    - x_fit (array-like): X values for the fitted sigmoid curve.</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a><span class="sd">    - y_fit (array-like): Y values for the fitted sigmoid curve.</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Data Points&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>    <span class="c1"># Plot the fitted sigmoid curve (bounded between 0 and 1)</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fitted Sigmoid Curve&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Cosine Similarity&quot;</span><span class="p">)</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Outlier Score&quot;</span><span class="p">)</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_metrics_vs_threshold</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">):</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">    Plot accuracy, precision, and recall scores as a function of cosine similarity threshold.</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">    Parameters:</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">    - cuts (array-like): Threshold values for cosine similarity.</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">    - accuracies (array-like): Accuracy scores for each threshold.</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="sd">    - precisions (array-like): Precision scores for each threshold.</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a><span class="sd">    - recalls (array-like): Recall scores for each threshold.</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">)</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Precision&quot;</span><span class="p">)</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Recall&quot;</span><span class="p">)</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>    <span class="c1"># Adding labels and title</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;threshold for cosine similarity&quot;</span><span class="p">)</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Score&quot;</span><span class="p">)</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Choose the desired threshold (here for 10% Outliers in training)&quot;</span><span class="p">)</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">thresholds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">thresholds</span><span class="p">))</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="saveplot">
                            <input id="saveplot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">saveplot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">title</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="saveplot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#saveplot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="saveplot-12"><a href="#saveplot-12"><span class="linenos">12</span></a><span class="k">def</span><span class="w"> </span><span class="nf">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="saveplot-13"><a href="#saveplot-13"><span class="linenos">13</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="saveplot-14"><a href="#saveplot-14"><span class="linenos">14</span></a><span class="sd">    Saves open matplotlib figure in directory dir_saveplot.</span>
</span><span id="saveplot-15"><a href="#saveplot-15"><span class="linenos">15</span></a>
</span><span id="saveplot-16"><a href="#saveplot-16"><span class="linenos">16</span></a><span class="sd">    :param save_plot: True if plot should be saved to folder, False if plot is displayed.</span>
</span><span id="saveplot-17"><a href="#saveplot-17"><span class="linenos">17</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="saveplot-18"><a href="#saveplot-18"><span class="linenos">18</span></a><span class="sd">    :param name: includes information on isotope and (optionally) detector, e.g. &#39;Am241_right&#39;</span>
</span><span id="saveplot-19"><a href="#saveplot-19"><span class="linenos">19</span></a><span class="sd">    :type name: str</span>
</span><span id="saveplot-20"><a href="#saveplot-20"><span class="linenos">20</span></a><span class="sd">    :param title: title of the plot</span>
</span><span id="saveplot-21"><a href="#saveplot-21"><span class="linenos">21</span></a><span class="sd">    :type title: str</span>
</span><span id="saveplot-22"><a href="#saveplot-22"><span class="linenos">22</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="saveplot-23"><a href="#saveplot-23"><span class="linenos">23</span></a>
</span><span id="saveplot-24"><a href="#saveplot-24"><span class="linenos">24</span></a>    <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
</span><span id="saveplot-25"><a href="#saveplot-25"><span class="linenos">25</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="saveplot-26"><a href="#saveplot-26"><span class="linenos">26</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="saveplot-27"><a href="#saveplot-27"><span class="linenos">27</span></a>                <span class="s2">&quot;dir_plots&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span>
</span><span id="saveplot-28"><a href="#saveplot-28"><span class="linenos">28</span></a>            <span class="p">):</span>  <span class="c1"># Check if dir_plots is defined in the global scope</span>
</span><span id="saveplot-29"><a href="#saveplot-29"><span class="linenos">29</span></a>                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
</span><span id="saveplot-30"><a href="#saveplot-30"><span class="linenos">30</span></a>                    <span class="s2">&quot;The directory for saving plots (&#39;dir_plots&#39;) is not defined.&quot;</span>
</span><span id="saveplot-31"><a href="#saveplot-31"><span class="linenos">31</span></a>                <span class="p">)</span>
</span><span id="saveplot-32"><a href="#saveplot-32"><span class="linenos">32</span></a>
</span><span id="saveplot-33"><a href="#saveplot-33"><span class="linenos">33</span></a>            <span class="c1"># convert &#39;Am241_right&#39; to &#39;Am241&#39; but leave &#39;Am241_Ba133_Co60&#39; unchanged</span>
</span><span id="saveplot-34"><a href="#saveplot-34"><span class="linenos">34</span></a>            <span class="n">isotope</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="saveplot-35"><a href="#saveplot-35"><span class="linenos">35</span></a>                <span class="n">name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="saveplot-36"><a href="#saveplot-36"><span class="linenos">36</span></a>                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="saveplot-37"><a href="#saveplot-37"><span class="linenos">37</span></a>                    <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">all_detectors</span>
</span><span id="saveplot-38"><a href="#saveplot-38"><span class="linenos">38</span></a>                <span class="p">)</span>
</span><span id="saveplot-39"><a href="#saveplot-39"><span class="linenos">39</span></a>                <span class="k">else</span> <span class="n">name</span>
</span><span id="saveplot-40"><a href="#saveplot-40"><span class="linenos">40</span></a>            <span class="p">)</span>
</span><span id="saveplot-41"><a href="#saveplot-41"><span class="linenos">41</span></a>
</span><span id="saveplot-42"><a href="#saveplot-42"><span class="linenos">42</span></a>            <span class="n">dir_saveplot</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dir_plots</span><span class="p">,</span> <span class="n">isotope</span><span class="p">)</span>
</span><span id="saveplot-43"><a href="#saveplot-43"><span class="linenos">43</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_saveplot</span><span class="p">):</span>
</span><span id="saveplot-44"><a href="#saveplot-44"><span class="linenos">44</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_saveplot</span><span class="p">)</span>
</span><span id="saveplot-45"><a href="#saveplot-45"><span class="linenos">45</span></a>
</span><span id="saveplot-46"><a href="#saveplot-46"><span class="linenos">46</span></a>            <span class="n">savename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dir_saveplot</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.svg&quot;</span><span class="p">)</span>
</span><span id="saveplot-47"><a href="#saveplot-47"><span class="linenos">47</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</span><span id="saveplot-48"><a href="#saveplot-48"><span class="linenos">48</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving figure to </span><span class="si">{</span><span class="n">savename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="saveplot-49"><a href="#saveplot-49"><span class="linenos">49</span></a>
</span><span id="saveplot-50"><a href="#saveplot-50"><span class="linenos">50</span></a>        <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="saveplot-51"><a href="#saveplot-51"><span class="linenos">51</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="saveplot-52"><a href="#saveplot-52"><span class="linenos">52</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="saveplot-53"><a href="#saveplot-53"><span class="linenos">53</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred while saving the plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="saveplot-54"><a href="#saveplot-54"><span class="linenos">54</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="saveplot-55"><a href="#saveplot-55"><span class="linenos">55</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Saves open matplotlib figure in directory dir_saveplot.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>save_plot</strong>:  True if plot should be saved to folder, False if plot is displayed.</li>
<li><strong>name</strong>:  includes information on isotope and (optionally) detector, e.g. 'Am241_right'</li>
<li><strong>title</strong>:  title of the plot</li>
</ul>
</div>


                </section>
                <section id="get_color_list">
                            <input id="get_color_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_color_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="get_color_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_color_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_color_list-58"><a href="#get_color_list-58"><span class="linenos">58</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_color_list</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span><span id="get_color_list-59"><a href="#get_color_list-59"><span class="linenos">59</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_color_list-60"><a href="#get_color_list-60"><span class="linenos">60</span></a><span class="sd">    Counts n_iso, the number of different (unique) isotopes in labels.</span>
</span><span id="get_color_list-61"><a href="#get_color_list-61"><span class="linenos">61</span></a><span class="sd">    Builds dictionary that assigns each isotope to a color and applies this mapping to labels.</span>
</span><span id="get_color_list-62"><a href="#get_color_list-62"><span class="linenos">62</span></a>
</span><span id="get_color_list-63"><a href="#get_color_list-63"><span class="linenos">63</span></a><span class="sd">    :param labels: list of labels, does not have to be unique (can be a flat or nested list)</span>
</span><span id="get_color_list-64"><a href="#get_color_list-64"><span class="linenos">64</span></a><span class="sd">    :type labels: List[str]</span>
</span><span id="get_color_list-65"><a href="#get_color_list-65"><span class="linenos">65</span></a>
</span><span id="get_color_list-66"><a href="#get_color_list-66"><span class="linenos">66</span></a><span class="sd">    :return: color_list: list of color (same length as labels), assigning each label to a color.</span>
</span><span id="get_color_list-67"><a href="#get_color_list-67"><span class="linenos">67</span></a><span class="sd">            color_dict: dictionary where each (unique) isotope is assigned one color</span>
</span><span id="get_color_list-68"><a href="#get_color_list-68"><span class="linenos">68</span></a><span class="sd">    :rtype: Tuple[List, Dict[str, float]]</span>
</span><span id="get_color_list-69"><a href="#get_color_list-69"><span class="linenos">69</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_color_list-70"><a href="#get_color_list-70"><span class="linenos">70</span></a>
</span><span id="get_color_list-71"><a href="#get_color_list-71"><span class="linenos">71</span></a>    <span class="n">nested</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="get_color_list-72"><a href="#get_color_list-72"><span class="linenos">72</span></a>        <span class="kc">True</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="get_color_list-73"><a href="#get_color_list-73"><span class="linenos">73</span></a>    <span class="p">)</span>  <span class="c1"># check if labels is a nested list</span>
</span><span id="get_color_list-74"><a href="#get_color_list-74"><span class="linenos">74</span></a>    <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
</span><span id="get_color_list-75"><a href="#get_color_list-75"><span class="linenos">75</span></a>        <span class="n">distinct_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="get_color_list-76"><a href="#get_color_list-76"><span class="linenos">76</span></a>            <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">)</span>
</span><span id="get_color_list-77"><a href="#get_color_list-77"><span class="linenos">77</span></a>        <span class="p">)</span>  <span class="c1"># create list of isotopes</span>
</span><span id="get_color_list-78"><a href="#get_color_list-78"><span class="linenos">78</span></a>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># for flat list</span>
</span><span id="get_color_list-79"><a href="#get_color_list-79"><span class="linenos">79</span></a>        <span class="n">distinct_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>  <span class="c1"># create list of isotopes</span>
</span><span id="get_color_list-80"><a href="#get_color_list-80"><span class="linenos">80</span></a>    <span class="n">n_iso</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">distinct_labels</span><span class="p">)</span>
</span><span id="get_color_list-81"><a href="#get_color_list-81"><span class="linenos">81</span></a>    <span class="n">denomi</span> <span class="o">=</span> <span class="n">n_iso</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">n_iso</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">n_iso</span>  <span class="c1"># denominater</span>
</span><span id="get_color_list-82"><a href="#get_color_list-82"><span class="linenos">82</span></a>    <span class="n">distinct_colors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="get_color_list-83"><a href="#get_color_list-83"><span class="linenos">83</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">denomi</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iso</span><span class="p">)</span>
</span><span id="get_color_list-84"><a href="#get_color_list-84"><span class="linenos">84</span></a>    <span class="p">]</span>  <span class="c1"># pick n_iso distinct colors</span>
</span><span id="get_color_list-85"><a href="#get_color_list-85"><span class="linenos">85</span></a>    <span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">distinct_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">distinct_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iso</span><span class="p">)}</span>
</span><span id="get_color_list-86"><a href="#get_color_list-86"><span class="linenos">86</span></a>    <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
</span><span id="get_color_list-87"><a href="#get_color_list-87"><span class="linenos">87</span></a>        <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
</span><span id="get_color_list-88"><a href="#get_color_list-88"><span class="linenos">88</span></a>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># for flat list</span>
</span><span id="get_color_list-89"><a href="#get_color_list-89"><span class="linenos">89</span></a>        <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
</span><span id="get_color_list-90"><a href="#get_color_list-90"><span class="linenos">90</span></a>    <span class="k">return</span> <span class="n">color_list</span><span class="p">,</span> <span class="n">color_dict</span>
</span></pre></div>


            <div class="docstring"><p>Counts n_iso, the number of different (unique) isotopes in labels.
Builds dictionary that assigns each isotope to a color and applies this mapping to labels.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>labels</strong>:  list of labels, does not have to be unique (can be a flat or nested list)</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>color_list: list of color (same length as labels), assigning each label to a color.
          color_dict: dictionary where each (unique) isotope is assigned one color</p>
</blockquote>
</div>


                </section>
                <section id="plot_original_and_rebinned_example_spectrum">
                            <input id="plot_original_and_rebinned_example_spectrum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_original_and_rebinned_example_spectrum</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filename</span>, </span><span class="param"><span class="n">data_ori</span>, </span><span class="param"><span class="n">data_rebinned</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_original_and_rebinned_example_spectrum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_original_and_rebinned_example_spectrum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_original_and_rebinned_example_spectrum-93"><a href="#plot_original_and_rebinned_example_spectrum-93"><span class="linenos"> 93</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_original_and_rebinned_example_spectrum</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data_ori</span><span class="p">,</span> <span class="n">data_rebinned</span><span class="p">):</span>
</span><span id="plot_original_and_rebinned_example_spectrum-94"><a href="#plot_original_and_rebinned_example_spectrum-94"><span class="linenos"> 94</span></a>    <span class="k">if</span> <span class="s2">&quot;background&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
</span><span id="plot_original_and_rebinned_example_spectrum-95"><a href="#plot_original_and_rebinned_example_spectrum-95"><span class="linenos"> 95</span></a>        <span class="n">data_ori</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_ori</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]]</span>
</span><span id="plot_original_and_rebinned_example_spectrum-96"><a href="#plot_original_and_rebinned_example_spectrum-96"><span class="linenos"> 96</span></a>        <span class="n">data_rebinned</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_rebinned</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]]</span>
</span><span id="plot_original_and_rebinned_example_spectrum-97"><a href="#plot_original_and_rebinned_example_spectrum-97"><span class="linenos"> 97</span></a>    <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_ori</span><span class="p">))</span>  <span class="c1"># pick random spectrum</span>
</span><span id="plot_original_and_rebinned_example_spectrum-98"><a href="#plot_original_and_rebinned_example_spectrum-98"><span class="linenos"> 98</span></a>
</span><span id="plot_original_and_rebinned_example_spectrum-99"><a href="#plot_original_and_rebinned_example_spectrum-99"><span class="linenos"> 99</span></a>    <span class="n">int_ori</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_ori</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">])))</span>
</span><span id="plot_original_and_rebinned_example_spectrum-100"><a href="#plot_original_and_rebinned_example_spectrum-100"><span class="linenos">100</span></a>    <span class="n">int_rebinned</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_rebinned</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">])))</span>
</span><span id="plot_original_and_rebinned_example_spectrum-101"><a href="#plot_original_and_rebinned_example_spectrum-101"><span class="linenos">101</span></a>
</span><span id="plot_original_and_rebinned_example_spectrum-102"><a href="#plot_original_and_rebinned_example_spectrum-102"><span class="linenos">102</span></a>    <span class="n">leg_ori</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Original </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> spectrum Nr. </span><span class="si">{</span><span class="n">kk</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">int_ori</span><span class="si">}</span><span class="s2"> counts)&quot;</span>
</span><span id="plot_original_and_rebinned_example_spectrum-103"><a href="#plot_original_and_rebinned_example_spectrum-103"><span class="linenos">103</span></a>    <span class="n">leg_rebinned</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Rebinned </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> spectrum Nr. </span><span class="si">{</span><span class="n">kk</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">int_rebinned</span><span class="si">}</span><span class="s2"> counts)&quot;</span>
</span><span id="plot_original_and_rebinned_example_spectrum-104"><a href="#plot_original_and_rebinned_example_spectrum-104"><span class="linenos">104</span></a>
</span><span id="plot_original_and_rebinned_example_spectrum-105"><a href="#plot_original_and_rebinned_example_spectrum-105"><span class="linenos">105</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="plot_original_and_rebinned_example_spectrum-106"><a href="#plot_original_and_rebinned_example_spectrum-106"><span class="linenos">106</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_ori</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg_ori</span><span class="p">)</span>
</span><span id="plot_original_and_rebinned_example_spectrum-107"><a href="#plot_original_and_rebinned_example_spectrum-107"><span class="linenos">107</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_rebinned</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg_rebinned</span><span class="p">)</span>
</span><span id="plot_original_and_rebinned_example_spectrum-108"><a href="#plot_original_and_rebinned_example_spectrum-108"><span class="linenos">108</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Channel&quot;</span><span class="p">)</span>
</span><span id="plot_original_and_rebinned_example_spectrum-109"><a href="#plot_original_and_rebinned_example_spectrum-109"><span class="linenos">109</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Counts&quot;</span><span class="p">)</span>
</span><span id="plot_original_and_rebinned_example_spectrum-110"><a href="#plot_original_and_rebinned_example_spectrum-110"><span class="linenos">110</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="plot_original_and_rebinned_example_spectrum-111"><a href="#plot_original_and_rebinned_example_spectrum-111"><span class="linenos">111</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
</span><span id="plot_original_and_rebinned_example_spectrum-112"><a href="#plot_original_and_rebinned_example_spectrum-112"><span class="linenos">112</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


    

                </section>
                <section id="plot_mean_spectra_by_isotope_and_detector">
                            <input id="plot_mean_spectra_by_isotope_and_detector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_mean_spectra_by_isotope_and_detector</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">iso_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>, </span><span class="param"><span class="n">zoom_in</span><span class="p">:</span> <span class="nb">bool</span>, </span><span class="param"><span class="n">save_plots</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_mean_spectra_by_isotope_and_detector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_mean_spectra_by_isotope_and_detector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_mean_spectra_by_isotope_and_detector-115"><a href="#plot_mean_spectra_by_isotope_and_detector-115"><span class="linenos">115</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_mean_spectra_by_isotope_and_detector</span><span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-116"><a href="#plot_mean_spectra_by_isotope_and_detector-116"><span class="linenos">116</span></a>    <span class="n">iso_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">zoom_in</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">save_plots</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-117"><a href="#plot_mean_spectra_by_isotope_and_detector-117"><span class="linenos">117</span></a><span class="p">):</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-118"><a href="#plot_mean_spectra_by_isotope_and_detector-118"><span class="linenos">118</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-119"><a href="#plot_mean_spectra_by_isotope_and_detector-119"><span class="linenos">119</span></a><span class="sd">    Calculates mean spectra of all isotopes given in names_list, for each detector individually.</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-120"><a href="#plot_mean_spectra_by_isotope_and_detector-120"><span class="linenos">120</span></a><span class="sd">    Two subplots per isotope: 1. original mean spectra (with bg), 2. normalized mean spectra (bg subtracted).</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-121"><a href="#plot_mean_spectra_by_isotope_and_detector-121"><span class="linenos">121</span></a><span class="sd">    The cosine similarity (measure for similarity between spectra) between the means of different detectors is</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-122"><a href="#plot_mean_spectra_by_isotope_and_detector-122"><span class="linenos">122</span></a><span class="sd">    calculated and displayed in right subplot.</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-123"><a href="#plot_mean_spectra_by_isotope_and_detector-123"><span class="linenos">123</span></a><span class="sd">    Only works for single-label spectra or spectra containing one isotope + background.</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-124"><a href="#plot_mean_spectra_by_isotope_and_detector-124"><span class="linenos">124</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-125"><a href="#plot_mean_spectra_by_isotope_and_detector-125"><span class="linenos">125</span></a><span class="sd">    :param iso_list: list of isotopes to be shown, e.g. [&#39;Am241&#39;, &#39;Co60&#39;, &#39;Ir192&#39;]</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-126"><a href="#plot_mean_spectra_by_isotope_and_detector-126"><span class="linenos">126</span></a><span class="sd">    :type iso_list: List[str]</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-127"><a href="#plot_mean_spectra_by_isotope_and_detector-127"><span class="linenos">127</span></a><span class="sd">    :param zoom_in: Option to zoom into the lower end of the spectra</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-128"><a href="#plot_mean_spectra_by_isotope_and_detector-128"><span class="linenos">128</span></a><span class="sd">    :type zoom_in: bool</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-129"><a href="#plot_mean_spectra_by_isotope_and_detector-129"><span class="linenos">129</span></a><span class="sd">    :param save_plots: Option to save the plots to folder.</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-130"><a href="#plot_mean_spectra_by_isotope_and_detector-130"><span class="linenos">130</span></a><span class="sd">    :type save_plots: bool</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-131"><a href="#plot_mean_spectra_by_isotope_and_detector-131"><span class="linenos">131</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-132"><a href="#plot_mean_spectra_by_isotope_and_detector-132"><span class="linenos">132</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-133"><a href="#plot_mean_spectra_by_isotope_and_detector-133"><span class="linenos">133</span></a>    <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">iso_list</span><span class="p">:</span>  <span class="c1"># iterates over isotopes</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-134"><a href="#plot_mean_spectra_by_isotope_and_detector-134"><span class="linenos">134</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-135"><a href="#plot_mean_spectra_by_isotope_and_detector-135"><span class="linenos">135</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Mean &amp; standard error of preprocessed spectra&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-136"><a href="#plot_mean_spectra_by_isotope_and_detector-136"><span class="linenos">136</span></a>        <span class="n">means_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-137"><a href="#plot_mean_spectra_by_isotope_and_detector-137"><span class="linenos">137</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-138"><a href="#plot_mean_spectra_by_isotope_and_detector-138"><span class="linenos">138</span></a>        <span class="c1"># create dictionary to assign colors to different detectors in plots</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-139"><a href="#plot_mean_spectra_by_isotope_and_detector-139"><span class="linenos">139</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">col_dict</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">all_detectors</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-140"><a href="#plot_mean_spectra_by_isotope_and_detector-140"><span class="linenos">140</span></a>        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-141"><a href="#plot_mean_spectra_by_isotope_and_detector-141"><span class="linenos">141</span></a>            <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">all_detectors</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-142"><a href="#plot_mean_spectra_by_isotope_and_detector-142"><span class="linenos">142</span></a>        <span class="p">):</span>  <span class="c1"># iterates over all detectors (e.g. [&#39;left&#39;, &#39;right&#39;, &#39;simulated&#39;])</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-143"><a href="#plot_mean_spectra_by_isotope_and_detector-143"><span class="linenos">143</span></a>            <span class="c1"># mean and standard deviation of all spectra in &lt;name&gt;.npy, isotope and background spectra seperately</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-144"><a href="#plot_mean_spectra_by_isotope_and_detector-144"><span class="linenos">144</span></a>            <span class="n">mean_bg</span><span class="p">,</span> <span class="n">std_bg</span><span class="p">,</span> <span class="n">mean_iso</span><span class="p">,</span> <span class="n">std_iso</span> <span class="o">=</span> <span class="n">calc_mean</span><span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-145"><a href="#plot_mean_spectra_by_isotope_and_detector-145"><span class="linenos">145</span></a>                <span class="n">iso</span><span class="p">,</span> <span class="n">dir_numpy_ready</span><span class="p">,</span> <span class="p">[</span><span class="n">det</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-146"><a href="#plot_mean_spectra_by_isotope_and_detector-146"><span class="linenos">146</span></a>            <span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-147"><a href="#plot_mean_spectra_by_isotope_and_detector-147"><span class="linenos">147</span></a>            <span class="n">int_iso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mean_iso</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-148"><a href="#plot_mean_spectra_by_isotope_and_detector-148"><span class="linenos">148</span></a>            <span class="n">int_bg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mean_bg</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-149"><a href="#plot_mean_spectra_by_isotope_and_detector-149"><span class="linenos">149</span></a>            <span class="k">if</span> <span class="n">int_iso</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-150"><a href="#plot_mean_spectra_by_isotope_and_detector-150"><span class="linenos">150</span></a>                <span class="n">means_dict</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_iso</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-151"><a href="#plot_mean_spectra_by_isotope_and_detector-151"><span class="linenos">151</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mean_iso</span><span class="p">))</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-152"><a href="#plot_mean_spectra_by_isotope_and_detector-152"><span class="linenos">152</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-153"><a href="#plot_mean_spectra_by_isotope_and_detector-153"><span class="linenos">153</span></a>                <span class="c1"># left subplot: means (not normalized) with error margins, channels on x axis</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-154"><a href="#plot_mean_spectra_by_isotope_and_detector-154"><span class="linenos">154</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_iso</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">det</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-155"><a href="#plot_mean_spectra_by_isotope_and_detector-155"><span class="linenos">155</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-156"><a href="#plot_mean_spectra_by_isotope_and_detector-156"><span class="linenos">156</span></a>                    <span class="n">x</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-157"><a href="#plot_mean_spectra_by_isotope_and_detector-157"><span class="linenos">157</span></a>                    <span class="n">mean_iso</span> <span class="o">-</span> <span class="n">std_iso</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-158"><a href="#plot_mean_spectra_by_isotope_and_detector-158"><span class="linenos">158</span></a>                    <span class="n">mean_iso</span> <span class="o">+</span> <span class="n">std_iso</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-159"><a href="#plot_mean_spectra_by_isotope_and_detector-159"><span class="linenos">159</span></a>                    <span class="n">color</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">det</span><span class="p">],</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-160"><a href="#plot_mean_spectra_by_isotope_and_detector-160"><span class="linenos">160</span></a>                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-161"><a href="#plot_mean_spectra_by_isotope_and_detector-161"><span class="linenos">161</span></a>                <span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-162"><a href="#plot_mean_spectra_by_isotope_and_detector-162"><span class="linenos">162</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean spectra of </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> (original)&quot;</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-163"><a href="#plot_mean_spectra_by_isotope_and_detector-163"><span class="linenos">163</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;energy channels&quot;</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-164"><a href="#plot_mean_spectra_by_isotope_and_detector-164"><span class="linenos">164</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_iso</span><span class="p">))</span>  <span class="c1"># default</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-165"><a href="#plot_mean_spectra_by_isotope_and_detector-165"><span class="linenos">165</span></a>                <span class="k">if</span> <span class="n">zoom_in</span><span class="p">:</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-166"><a href="#plot_mean_spectra_by_isotope_and_detector-166"><span class="linenos">166</span></a>                    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>  <span class="c1"># option to zoom into lower channels</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-167"><a href="#plot_mean_spectra_by_isotope_and_detector-167"><span class="linenos">167</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-168"><a href="#plot_mean_spectra_by_isotope_and_detector-168"><span class="linenos">168</span></a>                <span class="c1"># Background subtraction and normalization</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-169"><a href="#plot_mean_spectra_by_isotope_and_detector-169"><span class="linenos">169</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-170"><a href="#plot_mean_spectra_by_isotope_and_detector-170"><span class="linenos">170</span></a>                    <span class="s2">&quot;background&quot;</span> <span class="ow">in</span> <span class="n">iso</span> <span class="ow">or</span> <span class="n">det</span> <span class="o">==</span> <span class="s2">&quot;simulated&quot;</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-171"><a href="#plot_mean_spectra_by_isotope_and_detector-171"><span class="linenos">171</span></a>                <span class="p">):</span>  <span class="c1"># no background subtraction</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-172"><a href="#plot_mean_spectra_by_isotope_and_detector-172"><span class="linenos">172</span></a>                    <span class="n">pure_iso</span> <span class="o">=</span> <span class="n">mean_iso</span> <span class="o">/</span> <span class="n">int_iso</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-173"><a href="#plot_mean_spectra_by_isotope_and_detector-173"><span class="linenos">173</span></a>                    <span class="n">std_bg</span> <span class="o">=</span> <span class="n">std_bg</span> <span class="o">/</span> <span class="n">int_bg</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-174"><a href="#plot_mean_spectra_by_isotope_and_detector-174"><span class="linenos">174</span></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># measured isotope spectra (containing background)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-175"><a href="#plot_mean_spectra_by_isotope_and_detector-175"><span class="linenos">175</span></a>                    <span class="n">pure_iso</span> <span class="o">=</span> <span class="n">mean_iso</span> <span class="o">-</span> <span class="n">mean_bg</span>  <span class="c1"># subtract background from mean</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-176"><a href="#plot_mean_spectra_by_isotope_and_detector-176"><span class="linenos">176</span></a>                    <span class="n">pure_iso_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pure_iso</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-177"><a href="#plot_mean_spectra_by_isotope_and_detector-177"><span class="linenos">177</span></a>                    <span class="n">pure_iso</span> <span class="o">=</span> <span class="n">pure_iso</span> <span class="o">/</span> <span class="n">pure_iso_int</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-178"><a href="#plot_mean_spectra_by_isotope_and_detector-178"><span class="linenos">178</span></a>                    <span class="n">std_bg</span> <span class="o">=</span> <span class="n">std_bg</span> <span class="o">/</span> <span class="n">pure_iso_int</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-179"><a href="#plot_mean_spectra_by_isotope_and_detector-179"><span class="linenos">179</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-180"><a href="#plot_mean_spectra_by_isotope_and_detector-180"><span class="linenos">180</span></a>                <span class="c1"># convert channels to energies</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-181"><a href="#plot_mean_spectra_by_isotope_and_detector-181"><span class="linenos">181</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">std_calib</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-182"><a href="#plot_mean_spectra_by_isotope_and_detector-182"><span class="linenos">182</span></a>                <span class="n">slope</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">std_calib</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-183"><a href="#plot_mean_spectra_by_isotope_and_detector-183"><span class="linenos">183</span></a>                <span class="n">quad</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">std_calib</span><span class="p">[</span><span class="s2">&quot;quad&quot;</span><span class="p">]</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-184"><a href="#plot_mean_spectra_by_isotope_and_detector-184"><span class="linenos">184</span></a>                <span class="n">energies</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">quad</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-185"><a href="#plot_mean_spectra_by_isotope_and_detector-185"><span class="linenos">185</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-186"><a href="#plot_mean_spectra_by_isotope_and_detector-186"><span class="linenos">186</span></a>                <span class="c1"># right subplot: means (normalized) with background subtracted, energies on x axis</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-187"><a href="#plot_mean_spectra_by_isotope_and_detector-187"><span class="linenos">187</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">pure_iso</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">det</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-188"><a href="#plot_mean_spectra_by_isotope_and_detector-188"><span class="linenos">188</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-189"><a href="#plot_mean_spectra_by_isotope_and_detector-189"><span class="linenos">189</span></a>                    <span class="n">energies</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-190"><a href="#plot_mean_spectra_by_isotope_and_detector-190"><span class="linenos">190</span></a>                    <span class="n">pure_iso</span> <span class="o">-</span> <span class="n">std_bg</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-191"><a href="#plot_mean_spectra_by_isotope_and_detector-191"><span class="linenos">191</span></a>                    <span class="n">pure_iso</span> <span class="o">+</span> <span class="n">std_bg</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-192"><a href="#plot_mean_spectra_by_isotope_and_detector-192"><span class="linenos">192</span></a>                    <span class="n">color</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">det</span><span class="p">],</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-193"><a href="#plot_mean_spectra_by_isotope_and_detector-193"><span class="linenos">193</span></a>                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-194"><a href="#plot_mean_spectra_by_isotope_and_detector-194"><span class="linenos">194</span></a>                <span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-195"><a href="#plot_mean_spectra_by_isotope_and_detector-195"><span class="linenos">195</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-196"><a href="#plot_mean_spectra_by_isotope_and_detector-196"><span class="linenos">196</span></a>                    <span class="sa">f</span><span class="s2">&quot;Mean spectra of </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> (background subtracted, normalized)&quot;</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-197"><a href="#plot_mean_spectra_by_isotope_and_detector-197"><span class="linenos">197</span></a>                <span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-198"><a href="#plot_mean_spectra_by_isotope_and_detector-198"><span class="linenos">198</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;energy / keV&quot;</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-199"><a href="#plot_mean_spectra_by_isotope_and_detector-199"><span class="linenos">199</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-200"><a href="#plot_mean_spectra_by_isotope_and_detector-200"><span class="linenos">200</span></a>                <span class="k">if</span> <span class="n">zoom_in</span><span class="p">:</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-201"><a href="#plot_mean_spectra_by_isotope_and_detector-201"><span class="linenos">201</span></a>                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-202"><a href="#plot_mean_spectra_by_isotope_and_detector-202"><span class="linenos">202</span></a>                        <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-203"><a href="#plot_mean_spectra_by_isotope_and_detector-203"><span class="linenos">203</span></a>                    <span class="p">)</span>  <span class="c1"># option to zoom into lower channels</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-204"><a href="#plot_mean_spectra_by_isotope_and_detector-204"><span class="linenos">204</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-205"><a href="#plot_mean_spectra_by_isotope_and_detector-205"><span class="linenos">205</span></a>                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-206"><a href="#plot_mean_spectra_by_isotope_and_detector-206"><span class="linenos">206</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-207"><a href="#plot_mean_spectra_by_isotope_and_detector-207"><span class="linenos">207</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;intensity / a.u.&quot;</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-208"><a href="#plot_mean_spectra_by_isotope_and_detector-208"><span class="linenos">208</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-209"><a href="#plot_mean_spectra_by_isotope_and_detector-209"><span class="linenos">209</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># no spectra found for isotope iso: delete figure</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-210"><a href="#plot_mean_spectra_by_isotope_and_detector-210"><span class="linenos">210</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-211"><a href="#plot_mean_spectra_by_isotope_and_detector-211"><span class="linenos">211</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-212"><a href="#plot_mean_spectra_by_isotope_and_detector-212"><span class="linenos">212</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-213"><a href="#plot_mean_spectra_by_isotope_and_detector-213"><span class="linenos">213</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-214"><a href="#plot_mean_spectra_by_isotope_and_detector-214"><span class="linenos">214</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">means_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-215"><a href="#plot_mean_spectra_by_isotope_and_detector-215"><span class="linenos">215</span></a>        <span class="p">):</span>  <span class="c1"># multiple means per isotope / multiple detectors</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-216"><a href="#plot_mean_spectra_by_isotope_and_detector-216"><span class="linenos">216</span></a>            <span class="n">dets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">means_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-217"><a href="#plot_mean_spectra_by_isotope_and_detector-217"><span class="linenos">217</span></a>            <span class="n">means</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">means_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-218"><a href="#plot_mean_spectra_by_isotope_and_detector-218"><span class="linenos">218</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-219"><a href="#plot_mean_spectra_by_isotope_and_detector-219"><span class="linenos">219</span></a>            <span class="c1"># create list of all combinations between detectors (e.g. left&amp;right, left&amp;simulated, right&amp;simulated)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-220"><a href="#plot_mean_spectra_by_isotope_and_detector-220"><span class="linenos">220</span></a>            <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dets</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-221"><a href="#plot_mean_spectra_by_isotope_and_detector-221"><span class="linenos">221</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-222"><a href="#plot_mean_spectra_by_isotope_and_detector-222"><span class="linenos">222</span></a>            <span class="c1"># loop through all combinations and write cosine similarity in right subplot</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-223"><a href="#plot_mean_spectra_by_isotope_and_detector-223"><span class="linenos">223</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">):</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-224"><a href="#plot_mean_spectra_by_isotope_and_detector-224"><span class="linenos">224</span></a>                <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">means</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-225"><a href="#plot_mean_spectra_by_isotope_and_detector-225"><span class="linenos">225</span></a>                <span class="n">dettxt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">dets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-226"><a href="#plot_mean_spectra_by_isotope_and_detector-226"><span class="linenos">226</span></a>                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-227"><a href="#plot_mean_spectra_by_isotope_and_detector-227"><span class="linenos">227</span></a>                    <span class="sa">f</span><span class="s2">&quot;Cos similarity betw. </span><span class="si">{</span><span class="n">dettxt</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2"> .2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-228"><a href="#plot_mean_spectra_by_isotope_and_detector-228"><span class="linenos">228</span></a>                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.91</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-229"><a href="#plot_mean_spectra_by_isotope_and_detector-229"><span class="linenos">229</span></a>                    <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-230"><a href="#plot_mean_spectra_by_isotope_and_detector-230"><span class="linenos">230</span></a>                <span class="p">)</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-231"><a href="#plot_mean_spectra_by_isotope_and_detector-231"><span class="linenos">231</span></a>
</span><span id="plot_mean_spectra_by_isotope_and_detector-232"><a href="#plot_mean_spectra_by_isotope_and_detector-232"><span class="linenos">232</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-233"><a href="#plot_mean_spectra_by_isotope_and_detector-233"><span class="linenos">233</span></a>        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;compare_means_of_different_detectors</span><span class="si">{</span><span class="s1">&#39;_zoom&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">zoom_in</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_mean_spectra_by_isotope_and_detector-234"><a href="#plot_mean_spectra_by_isotope_and_detector-234"><span class="linenos">234</span></a>        <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plots</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Calculates mean spectra of all isotopes given in names_list, for each detector individually.
Two subplots per isotope: 1. original mean spectra (with bg), 2. normalized mean spectra (bg subtracted).
The cosine similarity (measure for similarity between spectra) between the means of different detectors is
calculated and displayed in right subplot.
Only works for single-label spectra or spectra containing one isotope + background.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>iso_list</strong>:  list of isotopes to be shown, e.g. ['Am241', 'Co60', 'Ir192']</li>
<li><strong>zoom_in</strong>:  Option to zoom into the lower end of the spectra</li>
<li><strong>save_plots</strong>:  Option to save the plots to folder.</li>
</ul>
</div>


                </section>
                <section id="plot_example_spectra_by_isotopes">
                            <input id="plot_example_spectra_by_isotopes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_example_spectra_by_isotopes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">iso_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>, </span><span class="param"><span class="n">n_spectra</span>, </span><span class="param"><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_example_spectra_by_isotopes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_example_spectra_by_isotopes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_example_spectra_by_isotopes-237"><a href="#plot_example_spectra_by_isotopes-237"><span class="linenos">237</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_example_spectra_by_isotopes</span><span class="p">(</span><span class="n">iso_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">n_spectra</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="plot_example_spectra_by_isotopes-238"><a href="#plot_example_spectra_by_isotopes-238"><span class="linenos">238</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_example_spectra_by_isotopes-239"><a href="#plot_example_spectra_by_isotopes-239"><span class="linenos">239</span></a><span class="sd">    Plots multiple example spectra (one plot per isotope).</span>
</span><span id="plot_example_spectra_by_isotopes-240"><a href="#plot_example_spectra_by_isotopes-240"><span class="linenos">240</span></a><span class="sd">    Only works for single-label spectra or spectra containing one isotope + background.</span>
</span><span id="plot_example_spectra_by_isotopes-241"><a href="#plot_example_spectra_by_isotopes-241"><span class="linenos">241</span></a>
</span><span id="plot_example_spectra_by_isotopes-242"><a href="#plot_example_spectra_by_isotopes-242"><span class="linenos">242</span></a><span class="sd">    :param iso_list: list of isotopes to be shown, e.g. [&#39;Am241&#39;, &#39;Co60&#39;, &#39;Ir192&#39;]</span>
</span><span id="plot_example_spectra_by_isotopes-243"><a href="#plot_example_spectra_by_isotopes-243"><span class="linenos">243</span></a><span class="sd">    :type iso_list: List[str]</span>
</span><span id="plot_example_spectra_by_isotopes-244"><a href="#plot_example_spectra_by_isotopes-244"><span class="linenos">244</span></a><span class="sd">    :param n_spectra: &#39;all&#39; or number of maximum spectra plotted</span>
</span><span id="plot_example_spectra_by_isotopes-245"><a href="#plot_example_spectra_by_isotopes-245"><span class="linenos">245</span></a><span class="sd">    :type n_spectra: int or str</span>
</span><span id="plot_example_spectra_by_isotopes-246"><a href="#plot_example_spectra_by_isotopes-246"><span class="linenos">246</span></a><span class="sd">    :param save_plot: Option to save plot to folder</span>
</span><span id="plot_example_spectra_by_isotopes-247"><a href="#plot_example_spectra_by_isotopes-247"><span class="linenos">247</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="plot_example_spectra_by_isotopes-248"><a href="#plot_example_spectra_by_isotopes-248"><span class="linenos">248</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_example_spectra_by_isotopes-249"><a href="#plot_example_spectra_by_isotopes-249"><span class="linenos">249</span></a>
</span><span id="plot_example_spectra_by_isotopes-250"><a href="#plot_example_spectra_by_isotopes-250"><span class="linenos">250</span></a>    <span class="n">_</span><span class="p">,</span> <span class="n">color_dict</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span>
</span><span id="plot_example_spectra_by_isotopes-251"><a href="#plot_example_spectra_by_isotopes-251"><span class="linenos">251</span></a>        <span class="n">iso_list</span>
</span><span id="plot_example_spectra_by_isotopes-252"><a href="#plot_example_spectra_by_isotopes-252"><span class="linenos">252</span></a>    <span class="p">)</span>  <span class="c1"># dictionary to assign colors to different isotopes in plots</span>
</span><span id="plot_example_spectra_by_isotopes-253"><a href="#plot_example_spectra_by_isotopes-253"><span class="linenos">253</span></a>
</span><span id="plot_example_spectra_by_isotopes-254"><a href="#plot_example_spectra_by_isotopes-254"><span class="linenos">254</span></a>    <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">iso_list</span><span class="p">:</span>
</span><span id="plot_example_spectra_by_isotopes-255"><a href="#plot_example_spectra_by_isotopes-255"><span class="linenos">255</span></a>        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_spectral_data</span><span class="p">(</span>
</span><span id="plot_example_spectra_by_isotopes-256"><a href="#plot_example_spectra_by_isotopes-256"><span class="linenos">256</span></a>            <span class="n">dir_numpy_ready</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">all_detectors</span><span class="p">,</span> <span class="n">include_files</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">.npy&quot;</span>
</span><span id="plot_example_spectra_by_isotopes-257"><a href="#plot_example_spectra_by_isotopes-257"><span class="linenos">257</span></a>        <span class="p">)</span>
</span><span id="plot_example_spectra_by_isotopes-258"><a href="#plot_example_spectra_by_isotopes-258"><span class="linenos">258</span></a>        <span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="plot_example_spectra_by_isotopes-259"><a href="#plot_example_spectra_by_isotopes-259"><span class="linenos">259</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="plot_example_spectra_by_isotopes-260"><a href="#plot_example_spectra_by_isotopes-260"><span class="linenos">260</span></a>        <span class="k">if</span> <span class="n">n_spectra</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
</span><span id="plot_example_spectra_by_isotopes-261"><a href="#plot_example_spectra_by_isotopes-261"><span class="linenos">261</span></a>            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
</span><span id="plot_example_spectra_by_isotopes-262"><a href="#plot_example_spectra_by_isotopes-262"><span class="linenos">262</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)),</span> <span class="n">n_spectra</span>
</span><span id="plot_example_spectra_by_isotopes-263"><a href="#plot_example_spectra_by_isotopes-263"><span class="linenos">263</span></a>            <span class="p">)</span>  <span class="c1"># pick n_spectra spectra randomly</span>
</span><span id="plot_example_spectra_by_isotopes-264"><a href="#plot_example_spectra_by_isotopes-264"><span class="linenos">264</span></a>            <span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">spectra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
</span><span id="plot_example_spectra_by_isotopes-265"><a href="#plot_example_spectra_by_isotopes-265"><span class="linenos">265</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
</span><span id="plot_example_spectra_by_isotopes-266"><a href="#plot_example_spectra_by_isotopes-266"><span class="linenos">266</span></a>        <span class="n">iso_spectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="plot_example_spectra_by_isotopes-267"><a href="#plot_example_spectra_by_isotopes-267"><span class="linenos">267</span></a>            <span class="p">[</span><span class="n">spec</span> <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">lab</span><span class="p">]</span>
</span><span id="plot_example_spectra_by_isotopes-268"><a href="#plot_example_spectra_by_isotopes-268"><span class="linenos">268</span></a>        <span class="p">)</span>
</span><span id="plot_example_spectra_by_isotopes-269"><a href="#plot_example_spectra_by_isotopes-269"><span class="linenos">269</span></a>        <span class="n">colore</span> <span class="o">=</span> <span class="n">color_dict</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span>  <span class="c1"># get color for isotope</span>
</span><span id="plot_example_spectra_by_isotopes-270"><a href="#plot_example_spectra_by_isotopes-270"><span class="linenos">270</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iso_spectra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="plot_example_spectra_by_isotopes-271"><a href="#plot_example_spectra_by_isotopes-271"><span class="linenos">271</span></a>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="plot_example_spectra_by_isotopes-272"><a href="#plot_example_spectra_by_isotopes-272"><span class="linenos">272</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iso_spectra</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colore</span><span class="p">)</span>
</span><span id="plot_example_spectra_by_isotopes-273"><a href="#plot_example_spectra_by_isotopes-273"><span class="linenos">273</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;energy channel&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="plot_example_spectra_by_isotopes-274"><a href="#plot_example_spectra_by_isotopes-274"><span class="linenos">274</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="plot_example_spectra_by_isotopes-275"><a href="#plot_example_spectra_by_isotopes-275"><span class="linenos">275</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="plot_example_spectra_by_isotopes-276"><a href="#plot_example_spectra_by_isotopes-276"><span class="linenos">276</span></a>
</span><span id="plot_example_spectra_by_isotopes-277"><a href="#plot_example_spectra_by_isotopes-277"><span class="linenos">277</span></a>            <span class="c1"># set up legend with patches</span>
</span><span id="plot_example_spectra_by_isotopes-278"><a href="#plot_example_spectra_by_isotopes-278"><span class="linenos">278</span></a>            <span class="n">patchy</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colore</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">iso</span><span class="p">)</span>
</span><span id="plot_example_spectra_by_isotopes-279"><a href="#plot_example_spectra_by_isotopes-279"><span class="linenos">279</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">patchy</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="plot_example_spectra_by_isotopes-280"><a href="#plot_example_spectra_by_isotopes-280"><span class="linenos">280</span></a>            <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="s2">&quot;example_spectra&quot;</span><span class="p">)</span>
</span><span id="plot_example_spectra_by_isotopes-281"><a href="#plot_example_spectra_by_isotopes-281"><span class="linenos">281</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="plot_example_spectra_by_isotopes-282"><a href="#plot_example_spectra_by_isotopes-282"><span class="linenos">282</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="plot_example_spectra_by_isotopes-283"><a href="#plot_example_spectra_by_isotopes-283"><span class="linenos">283</span></a>                <span class="sa">f</span><span class="s2">&quot;No spectra labelled as </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> found in </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">.npy, cannot be plotted.&quot;</span>
</span><span id="plot_example_spectra_by_isotopes-284"><a href="#plot_example_spectra_by_isotopes-284"><span class="linenos">284</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plots multiple example spectra (one plot per isotope).
Only works for single-label spectra or spectra containing one isotope + background.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>iso_list</strong>:  list of isotopes to be shown, e.g. ['Am241', 'Co60', 'Ir192']</li>
<li><strong>n_spectra</strong>:  'all' or number of maximum spectra plotted</li>
<li><strong>save_plot</strong>:  Option to save plot to folder</li>
</ul>
</div>


                </section>
                <section id="plot_cos_sim_matrix_means">
                            <input id="plot_cos_sim_matrix_means-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_cos_sim_matrix_means</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">cosine_similarity_matrix</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>,</span><span class="param">	<span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_cos_sim_matrix_means-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_cos_sim_matrix_means"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_cos_sim_matrix_means-287"><a href="#plot_cos_sim_matrix_means-287"><span class="linenos">287</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_cos_sim_matrix_means</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-288"><a href="#plot_cos_sim_matrix_means-288"><span class="linenos">288</span></a>    <span class="n">cosine_similarity_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="plot_cos_sim_matrix_means-289"><a href="#plot_cos_sim_matrix_means-289"><span class="linenos">289</span></a><span class="p">):</span>
</span><span id="plot_cos_sim_matrix_means-290"><a href="#plot_cos_sim_matrix_means-290"><span class="linenos">290</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_cos_sim_matrix_means-291"><a href="#plot_cos_sim_matrix_means-291"><span class="linenos">291</span></a><span class="sd">    Visualizes the cosine similarity as triangular matrix between all isotope spectra means (detectors separately).</span>
</span><span id="plot_cos_sim_matrix_means-292"><a href="#plot_cos_sim_matrix_means-292"><span class="linenos">292</span></a><span class="sd">    Orange-rimmed: means of same isotope, different detector, that are not similar enough (cos_sim &lt; threshold)</span>
</span><span id="plot_cos_sim_matrix_means-293"><a href="#plot_cos_sim_matrix_means-293"><span class="linenos">293</span></a><span class="sd">    Red-rimmed: means of different isotopes that are too similar (cos_sim &gt;= threshold)</span>
</span><span id="plot_cos_sim_matrix_means-294"><a href="#plot_cos_sim_matrix_means-294"><span class="linenos">294</span></a>
</span><span id="plot_cos_sim_matrix_means-295"><a href="#plot_cos_sim_matrix_means-295"><span class="linenos">295</span></a><span class="sd">    Only works for single-label spectra or spectra containing one isotope + background.</span>
</span><span id="plot_cos_sim_matrix_means-296"><a href="#plot_cos_sim_matrix_means-296"><span class="linenos">296</span></a>
</span><span id="plot_cos_sim_matrix_means-297"><a href="#plot_cos_sim_matrix_means-297"><span class="linenos">297</span></a><span class="sd">    :param cosine_similarity_matrix: cosine similarity matrix between mean spectra of all isotopes and detectors</span>
</span><span id="plot_cos_sim_matrix_means-298"><a href="#plot_cos_sim_matrix_means-298"><span class="linenos">298</span></a><span class="sd">                                    (only lower triangle)</span>
</span><span id="plot_cos_sim_matrix_means-299"><a href="#plot_cos_sim_matrix_means-299"><span class="linenos">299</span></a><span class="sd">    :type cosine_similarity_matrix: np.ndarray</span>
</span><span id="plot_cos_sim_matrix_means-300"><a href="#plot_cos_sim_matrix_means-300"><span class="linenos">300</span></a><span class="sd">    :param names: list of xticklabels</span>
</span><span id="plot_cos_sim_matrix_means-301"><a href="#plot_cos_sim_matrix_means-301"><span class="linenos">301</span></a><span class="sd">    :type names: List[str]</span>
</span><span id="plot_cos_sim_matrix_means-302"><a href="#plot_cos_sim_matrix_means-302"><span class="linenos">302</span></a><span class="sd">    :param threshold: threshold for cosine similarity (minimum value for means of same isotope,</span>
</span><span id="plot_cos_sim_matrix_means-303"><a href="#plot_cos_sim_matrix_means-303"><span class="linenos">303</span></a><span class="sd">                        maximum value for means of different isotopes)</span>
</span><span id="plot_cos_sim_matrix_means-304"><a href="#plot_cos_sim_matrix_means-304"><span class="linenos">304</span></a><span class="sd">    :type threshold: float</span>
</span><span id="plot_cos_sim_matrix_means-305"><a href="#plot_cos_sim_matrix_means-305"><span class="linenos">305</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_cos_sim_matrix_means-306"><a href="#plot_cos_sim_matrix_means-306"><span class="linenos">306</span></a>
</span><span id="plot_cos_sim_matrix_means-307"><a href="#plot_cos_sim_matrix_means-307"><span class="linenos">307</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
</span><span id="plot_cos_sim_matrix_means-308"><a href="#plot_cos_sim_matrix_means-308"><span class="linenos">308</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-309"><a href="#plot_cos_sim_matrix_means-309"><span class="linenos">309</span></a>            <span class="sa">f</span><span class="s2">&quot;The threshold was set to </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> but has to be a number between -1 and 1!&quot;</span>
</span><span id="plot_cos_sim_matrix_means-310"><a href="#plot_cos_sim_matrix_means-310"><span class="linenos">310</span></a>        <span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-311"><a href="#plot_cos_sim_matrix_means-311"><span class="linenos">311</span></a>
</span><span id="plot_cos_sim_matrix_means-312"><a href="#plot_cos_sim_matrix_means-312"><span class="linenos">312</span></a>    <span class="n">n_names</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-313"><a href="#plot_cos_sim_matrix_means-313"><span class="linenos">313</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="plot_cos_sim_matrix_means-314"><a href="#plot_cos_sim_matrix_means-314"><span class="linenos">314</span></a>
</span><span id="plot_cos_sim_matrix_means-315"><a href="#plot_cos_sim_matrix_means-315"><span class="linenos">315</span></a>    <span class="k">if</span> <span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-316"><a href="#plot_cos_sim_matrix_means-316"><span class="linenos">316</span></a>        <span class="n">cosine_similarity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cosine_similarity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="plot_cos_sim_matrix_means-317"><a href="#plot_cos_sim_matrix_means-317"><span class="linenos">317</span></a>        <span class="ow">or</span> <span class="n">cosine_similarity_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_names</span>
</span><span id="plot_cos_sim_matrix_means-318"><a href="#plot_cos_sim_matrix_means-318"><span class="linenos">318</span></a>    <span class="p">):</span>
</span><span id="plot_cos_sim_matrix_means-319"><a href="#plot_cos_sim_matrix_means-319"><span class="linenos">319</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-320"><a href="#plot_cos_sim_matrix_means-320"><span class="linenos">320</span></a>            <span class="s2">&quot;The cosine similarity matrix must be square and match the length of the names list.&quot;</span>
</span><span id="plot_cos_sim_matrix_means-321"><a href="#plot_cos_sim_matrix_means-321"><span class="linenos">321</span></a>        <span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-322"><a href="#plot_cos_sim_matrix_means-322"><span class="linenos">322</span></a>
</span><span id="plot_cos_sim_matrix_means-323"><a href="#plot_cos_sim_matrix_means-323"><span class="linenos">323</span></a>    <span class="c1"># mask upper triangle (no background colors)</span>
</span><span id="plot_cos_sim_matrix_means-324"><a href="#plot_cos_sim_matrix_means-324"><span class="linenos">324</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cosine_similarity_matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-325"><a href="#plot_cos_sim_matrix_means-325"><span class="linenos">325</span></a>    <span class="n">masked_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cosine_similarity_matrix</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-326"><a href="#plot_cos_sim_matrix_means-326"><span class="linenos">326</span></a>
</span><span id="plot_cos_sim_matrix_means-327"><a href="#plot_cos_sim_matrix_means-327"><span class="linenos">327</span></a>    <span class="c1"># plot masked cosine similarity matrix</span>
</span><span id="plot_cos_sim_matrix_means-328"><a href="#plot_cos_sim_matrix_means-328"><span class="linenos">328</span></a>    <span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">masked_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-329"><a href="#plot_cos_sim_matrix_means-329"><span class="linenos">329</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_names</span><span class="p">):</span>
</span><span id="plot_cos_sim_matrix_means-330"><a href="#plot_cos_sim_matrix_means-330"><span class="linenos">330</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_names</span><span class="p">):</span>
</span><span id="plot_cos_sim_matrix_means-331"><a href="#plot_cos_sim_matrix_means-331"><span class="linenos">331</span></a>            <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
</span><span id="plot_cos_sim_matrix_means-332"><a href="#plot_cos_sim_matrix_means-332"><span class="linenos">332</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">:</span>  <span class="c1"># only lower left triangle</span>
</span><span id="plot_cos_sim_matrix_means-333"><a href="#plot_cos_sim_matrix_means-333"><span class="linenos">333</span></a>                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_cos_sim_matrix_means-334"><a href="#plot_cos_sim_matrix_means-334"><span class="linenos">334</span></a>                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span> <span class="k">if</span> <span class="n">cosine_similarity_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span>
</span><span id="plot_cos_sim_matrix_means-335"><a href="#plot_cos_sim_matrix_means-335"><span class="linenos">335</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-336"><a href="#plot_cos_sim_matrix_means-336"><span class="linenos">336</span></a>                    <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span>
</span><span id="plot_cos_sim_matrix_means-337"><a href="#plot_cos_sim_matrix_means-337"><span class="linenos">337</span></a>                <span class="p">)</span>  <span class="c1"># write value of cosine similarity into each square</span>
</span><span id="plot_cos_sim_matrix_means-338"><a href="#plot_cos_sim_matrix_means-338"><span class="linenos">338</span></a>
</span><span id="plot_cos_sim_matrix_means-339"><a href="#plot_cos_sim_matrix_means-339"><span class="linenos">339</span></a>                <span class="c1"># Draw orange box around values of same isotope, different detector that are too low (not similar enough)</span>
</span><span id="plot_cos_sim_matrix_means-340"><a href="#plot_cos_sim_matrix_means-340"><span class="linenos">340</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-341"><a href="#plot_cos_sim_matrix_means-341"><span class="linenos">341</span></a>                    <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="plot_cos_sim_matrix_means-342"><a href="#plot_cos_sim_matrix_means-342"><span class="linenos">342</span></a>                    <span class="ow">and</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="plot_cos_sim_matrix_means-343"><a href="#plot_cos_sim_matrix_means-343"><span class="linenos">343</span></a>                <span class="p">):</span>
</span><span id="plot_cos_sim_matrix_means-344"><a href="#plot_cos_sim_matrix_means-344"><span class="linenos">344</span></a>                    <span class="k">if</span> <span class="n">cos_sim</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="plot_cos_sim_matrix_means-345"><a href="#plot_cos_sim_matrix_means-345"><span class="linenos">345</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-346"><a href="#plot_cos_sim_matrix_means-346"><span class="linenos">346</span></a>                            <span class="sa">f</span><span class="s2">&quot;Not similar enough: </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">, cosine similarity=</span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2"> in row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, column </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_cos_sim_matrix_means-347"><a href="#plot_cos_sim_matrix_means-347"><span class="linenos">347</span></a>                        <span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-348"><a href="#plot_cos_sim_matrix_means-348"><span class="linenos">348</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-349"><a href="#plot_cos_sim_matrix_means-349"><span class="linenos">349</span></a>                            <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-350"><a href="#plot_cos_sim_matrix_means-350"><span class="linenos">350</span></a>                                <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span id="plot_cos_sim_matrix_means-351"><a href="#plot_cos_sim_matrix_means-351"><span class="linenos">351</span></a>                                <span class="mi">1</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-352"><a href="#plot_cos_sim_matrix_means-352"><span class="linenos">352</span></a>                                <span class="mi">1</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-353"><a href="#plot_cos_sim_matrix_means-353"><span class="linenos">353</span></a>                                <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-354"><a href="#plot_cos_sim_matrix_means-354"><span class="linenos">354</span></a>                                <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-355"><a href="#plot_cos_sim_matrix_means-355"><span class="linenos">355</span></a>                                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-356"><a href="#plot_cos_sim_matrix_means-356"><span class="linenos">356</span></a>                                <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-357"><a href="#plot_cos_sim_matrix_means-357"><span class="linenos">357</span></a>                            <span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-358"><a href="#plot_cos_sim_matrix_means-358"><span class="linenos">358</span></a>                        <span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-359"><a href="#plot_cos_sim_matrix_means-359"><span class="linenos">359</span></a>
</span><span id="plot_cos_sim_matrix_means-360"><a href="#plot_cos_sim_matrix_means-360"><span class="linenos">360</span></a>                <span class="c1"># Draw red box around values of different values that are too high (too similar)</span>
</span><span id="plot_cos_sim_matrix_means-361"><a href="#plot_cos_sim_matrix_means-361"><span class="linenos">361</span></a>                <span class="k">if</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="plot_cos_sim_matrix_means-362"><a href="#plot_cos_sim_matrix_means-362"><span class="linenos">362</span></a>                    <span class="k">if</span> <span class="n">cos_sim</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="plot_cos_sim_matrix_means-363"><a href="#plot_cos_sim_matrix_means-363"><span class="linenos">363</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-364"><a href="#plot_cos_sim_matrix_means-364"><span class="linenos">364</span></a>                            <span class="sa">f</span><span class="s2">&quot;Too similar: </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">, cosine similarity=</span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2">, in row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, column </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_cos_sim_matrix_means-365"><a href="#plot_cos_sim_matrix_means-365"><span class="linenos">365</span></a>                        <span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-366"><a href="#plot_cos_sim_matrix_means-366"><span class="linenos">366</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-367"><a href="#plot_cos_sim_matrix_means-367"><span class="linenos">367</span></a>                            <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-368"><a href="#plot_cos_sim_matrix_means-368"><span class="linenos">368</span></a>                                <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span id="plot_cos_sim_matrix_means-369"><a href="#plot_cos_sim_matrix_means-369"><span class="linenos">369</span></a>                                <span class="mi">1</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-370"><a href="#plot_cos_sim_matrix_means-370"><span class="linenos">370</span></a>                                <span class="mi">1</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-371"><a href="#plot_cos_sim_matrix_means-371"><span class="linenos">371</span></a>                                <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-372"><a href="#plot_cos_sim_matrix_means-372"><span class="linenos">372</span></a>                                <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;darkred&quot;</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-373"><a href="#plot_cos_sim_matrix_means-373"><span class="linenos">373</span></a>                                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-374"><a href="#plot_cos_sim_matrix_means-374"><span class="linenos">374</span></a>                                <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-375"><a href="#plot_cos_sim_matrix_means-375"><span class="linenos">375</span></a>                            <span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-376"><a href="#plot_cos_sim_matrix_means-376"><span class="linenos">376</span></a>                        <span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-377"><a href="#plot_cos_sim_matrix_means-377"><span class="linenos">377</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_names</span><span class="p">))</span>
</span><span id="plot_cos_sim_matrix_means-378"><a href="#plot_cos_sim_matrix_means-378"><span class="linenos">378</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_names</span><span class="p">))</span>
</span><span id="plot_cos_sim_matrix_means-379"><a href="#plot_cos_sim_matrix_means-379"><span class="linenos">379</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-380"><a href="#plot_cos_sim_matrix_means-380"><span class="linenos">380</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-381"><a href="#plot_cos_sim_matrix_means-381"><span class="linenos">381</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-382"><a href="#plot_cos_sim_matrix_means-382"><span class="linenos">382</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-383"><a href="#plot_cos_sim_matrix_means-383"><span class="linenos">383</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-384"><a href="#plot_cos_sim_matrix_means-384"><span class="linenos">384</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-385"><a href="#plot_cos_sim_matrix_means-385"><span class="linenos">385</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[:]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-386"><a href="#plot_cos_sim_matrix_means-386"><span class="linenos">386</span></a>
</span><span id="plot_cos_sim_matrix_means-387"><a href="#plot_cos_sim_matrix_means-387"><span class="linenos">387</span></a>    <span class="c1"># adjust colorbar</span>
</span><span id="plot_cos_sim_matrix_means-388"><a href="#plot_cos_sim_matrix_means-388"><span class="linenos">388</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
</span><span id="plot_cos_sim_matrix_means-389"><a href="#plot_cos_sim_matrix_means-389"><span class="linenos">389</span></a>        <span class="n">cax</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-390"><a href="#plot_cos_sim_matrix_means-390"><span class="linenos">390</span></a>        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-391"><a href="#plot_cos_sim_matrix_means-391"><span class="linenos">391</span></a>        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cosine similarity&quot;</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-392"><a href="#plot_cos_sim_matrix_means-392"><span class="linenos">392</span></a>        <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-393"><a href="#plot_cos_sim_matrix_means-393"><span class="linenos">393</span></a>        <span class="n">location</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-394"><a href="#plot_cos_sim_matrix_means-394"><span class="linenos">394</span></a>        <span class="n">pad</span><span class="o">=</span><span class="mf">0.17</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-395"><a href="#plot_cos_sim_matrix_means-395"><span class="linenos">395</span></a>        <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-396"><a href="#plot_cos_sim_matrix_means-396"><span class="linenos">396</span></a>        <span class="n">aspect</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="plot_cos_sim_matrix_means-397"><a href="#plot_cos_sim_matrix_means-397"><span class="linenos">397</span></a>    <span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-398"><a href="#plot_cos_sim_matrix_means-398"><span class="linenos">398</span></a>    <span class="n">cax</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="plot_cos_sim_matrix_means-399"><a href="#plot_cos_sim_matrix_means-399"><span class="linenos">399</span></a>
</span><span id="plot_cos_sim_matrix_means-400"><a href="#plot_cos_sim_matrix_means-400"><span class="linenos">400</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Visualizes the cosine similarity as triangular matrix between all isotope spectra means (detectors separately).
Orange-rimmed: means of same isotope, different detector, that are not similar enough (cos_sim &lt; threshold)
Red-rimmed: means of different isotopes that are too similar (cos_sim &gt;= threshold)</p>

<p>Only works for single-label spectra or spectra containing one isotope + background.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>cosine_similarity_matrix</strong>:  cosine similarity matrix between mean spectra of all isotopes and detectors
(only lower triangle)</li>
<li><strong>names</strong>:  list of xticklabels</li>
<li><strong>threshold</strong>:  threshold for cosine similarity (minimum value for means of same isotope,
maximum value for means of different isotopes)</li>
</ul>
</div>


                </section>
                <section id="plot_loadings_subplots">
                            <input id="plot_loadings_subplots-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_loadings_subplots</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_loadings_subplots-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_loadings_subplots"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_loadings_subplots-403"><a href="#plot_loadings_subplots-403"><span class="linenos">403</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_loadings_subplots</span><span class="p">(</span><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="plot_loadings_subplots-404"><a href="#plot_loadings_subplots-404"><span class="linenos">404</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_loadings_subplots-405"><a href="#plot_loadings_subplots-405"><span class="linenos">405</span></a><span class="sd">    Visualize the loadings (transformation matrix from spectral into latent space, consists of stacked mean spectra).</span>
</span><span id="plot_loadings_subplots-406"><a href="#plot_loadings_subplots-406"><span class="linenos">406</span></a><span class="sd">    Each mean spectrum of an isotope is plotted in a subplot. In addition, the part of the spectrum considered in model</span>
</span><span id="plot_loadings_subplots-407"><a href="#plot_loadings_subplots-407"><span class="linenos">407</span></a><span class="sd">    inference (only channels &gt; min_channel_tr) is highlighted in red.</span>
</span><span id="plot_loadings_subplots-408"><a href="#plot_loadings_subplots-408"><span class="linenos">408</span></a>
</span><span id="plot_loadings_subplots-409"><a href="#plot_loadings_subplots-409"><span class="linenos">409</span></a><span class="sd">    :param save_plot: Option to save the plot.</span>
</span><span id="plot_loadings_subplots-410"><a href="#plot_loadings_subplots-410"><span class="linenos">410</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="plot_loadings_subplots-411"><a href="#plot_loadings_subplots-411"><span class="linenos">411</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_loadings_subplots-412"><a href="#plot_loadings_subplots-412"><span class="linenos">412</span></a>
</span><span id="plot_loadings_subplots-413"><a href="#plot_loadings_subplots-413"><span class="linenos">413</span></a>    <span class="c1"># get isotopes, number of components and min_channel</span>
</span><span id="plot_loadings_subplots-414"><a href="#plot_loadings_subplots-414"><span class="linenos">414</span></a>    <span class="n">isotopes</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span>
</span><span id="plot_loadings_subplots-415"><a href="#plot_loadings_subplots-415"><span class="linenos">415</span></a>    <span class="n">n_comp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">isotopes</span><span class="p">)</span>
</span><span id="plot_loadings_subplots-416"><a href="#plot_loadings_subplots-416"><span class="linenos">416</span></a>    <span class="n">min_channel</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">min_channel_tr</span>
</span><span id="plot_loadings_subplots-417"><a href="#plot_loadings_subplots-417"><span class="linenos">417</span></a>
</span><span id="plot_loadings_subplots-418"><a href="#plot_loadings_subplots-418"><span class="linenos">418</span></a>    <span class="c1"># normalize loadings</span>
</span><span id="plot_loadings_subplots-419"><a href="#plot_loadings_subplots-419"><span class="linenos">419</span></a>    <span class="n">loadings_norm</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">loadings_tr</span><span class="p">)</span>
</span><span id="plot_loadings_subplots-420"><a href="#plot_loadings_subplots-420"><span class="linenos">420</span></a>
</span><span id="plot_loadings_subplots-421"><a href="#plot_loadings_subplots-421"><span class="linenos">421</span></a>    <span class="c1"># set up figure and define colors</span>
</span><span id="plot_loadings_subplots-422"><a href="#plot_loadings_subplots-422"><span class="linenos">422</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_comp</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">n_comp</span><span class="p">))</span>
</span><span id="plot_loadings_subplots-423"><a href="#plot_loadings_subplots-423"><span class="linenos">423</span></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="plot_loadings_subplots-424"><a href="#plot_loadings_subplots-424"><span class="linenos">424</span></a>    <span class="n">color_list</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">isotopes</span><span class="p">)</span>
</span><span id="plot_loadings_subplots-425"><a href="#plot_loadings_subplots-425"><span class="linenos">425</span></a>
</span><span id="plot_loadings_subplots-426"><a href="#plot_loadings_subplots-426"><span class="linenos">426</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">iso</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isotopes</span><span class="p">):</span>
</span><span id="plot_loadings_subplots-427"><a href="#plot_loadings_subplots-427"><span class="linenos">427</span></a>        <span class="c1"># plot normalized loadings</span>
</span><span id="plot_loadings_subplots-428"><a href="#plot_loadings_subplots-428"><span class="linenos">428</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="plot_loadings_subplots-429"><a href="#plot_loadings_subplots-429"><span class="linenos">429</span></a>            <span class="n">loadings_norm</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;PC </span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_loadings_subplots-430"><a href="#plot_loadings_subplots-430"><span class="linenos">430</span></a>        <span class="p">)</span>
</span><span id="plot_loadings_subplots-431"><a href="#plot_loadings_subplots-431"><span class="linenos">431</span></a>
</span><span id="plot_loadings_subplots-432"><a href="#plot_loadings_subplots-432"><span class="linenos">432</span></a>        <span class="c1"># plot normalized loadings (only channels &gt; min_channel_tr)</span>
</span><span id="plot_loadings_subplots-433"><a href="#plot_loadings_subplots-433"><span class="linenos">433</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="plot_loadings_subplots-434"><a href="#plot_loadings_subplots-434"><span class="linenos">434</span></a>            <span class="n">x</span><span class="p">[</span><span class="n">min_channel</span><span class="p">:],</span>
</span><span id="plot_loadings_subplots-435"><a href="#plot_loadings_subplots-435"><span class="linenos">435</span></a>            <span class="n">loadings_norm</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">min_channel</span><span class="p">:],</span>
</span><span id="plot_loadings_subplots-436"><a href="#plot_loadings_subplots-436"><span class="linenos">436</span></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="plot_loadings_subplots-437"><a href="#plot_loadings_subplots-437"><span class="linenos">437</span></a>            <span class="n">c</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
</span><span id="plot_loadings_subplots-438"><a href="#plot_loadings_subplots-438"><span class="linenos">438</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="plot_loadings_subplots-439"><a href="#plot_loadings_subplots-439"><span class="linenos">439</span></a>            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;channels ≥ </span><span class="si">{</span><span class="n">min_channel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="plot_loadings_subplots-440"><a href="#plot_loadings_subplots-440"><span class="linenos">440</span></a>        <span class="p">)</span>
</span><span id="plot_loadings_subplots-441"><a href="#plot_loadings_subplots-441"><span class="linenos">441</span></a>
</span><span id="plot_loadings_subplots-442"><a href="#plot_loadings_subplots-442"><span class="linenos">442</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="plot_loadings_subplots-443"><a href="#plot_loadings_subplots-443"><span class="linenos">443</span></a>
</span><span id="plot_loadings_subplots-444"><a href="#plot_loadings_subplots-444"><span class="linenos">444</span></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n_comp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># turn ticks off for all subplots but the last one</span>
</span><span id="plot_loadings_subplots-445"><a href="#plot_loadings_subplots-445"><span class="linenos">445</span></a>            <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_loadings_subplots-446"><a href="#plot_loadings_subplots-446"><span class="linenos">446</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># label for y axes</span>
</span><span id="plot_loadings_subplots-447"><a href="#plot_loadings_subplots-447"><span class="linenos">447</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
</span><span id="plot_loadings_subplots-448"><a href="#plot_loadings_subplots-448"><span class="linenos">448</span></a>
</span><span id="plot_loadings_subplots-449"><a href="#plot_loadings_subplots-449"><span class="linenos">449</span></a>    <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
</span><span id="plot_loadings_subplots-450"><a href="#plot_loadings_subplots-450"><span class="linenos">450</span></a>        <span class="s2">&quot;Energy channel&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span>
</span><span id="plot_loadings_subplots-451"><a href="#plot_loadings_subplots-451"><span class="linenos">451</span></a>    <span class="p">)</span>  <span class="c1"># label for x axis: lowest subplot only</span>
</span><span id="plot_loadings_subplots-452"><a href="#plot_loadings_subplots-452"><span class="linenos">452</span></a>
</span><span id="plot_loadings_subplots-453"><a href="#plot_loadings_subplots-453"><span class="linenos">453</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Loadings&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># set title</span>
</span><span id="plot_loadings_subplots-454"><a href="#plot_loadings_subplots-454"><span class="linenos">454</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_loadings_subplots-455"><a href="#plot_loadings_subplots-455"><span class="linenos">455</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="plot_loadings_subplots-456"><a href="#plot_loadings_subplots-456"><span class="linenos">456</span></a>
</span><span id="plot_loadings_subplots-457"><a href="#plot_loadings_subplots-457"><span class="linenos">457</span></a>    <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">isotopes</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Loadings_subplots&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize the loadings (transformation matrix from spectral into latent space, consists of stacked mean spectra).
Each mean spectrum of an isotope is plotted in a subplot. In addition, the part of the spectrum considered in model
inference (only channels &gt; min_channel_tr) is highlighted in red.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>save_plot</strong>:  Option to save the plot.</li>
</ul>
</div>


                </section>
                <section id="plot_confusion_matrix">
                            <input id="plot_confusion_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_confusion_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>, </span><span class="param"><span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_confusion_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_confusion_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_confusion_matrix-460"><a href="#plot_confusion_matrix-460"><span class="linenos">460</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="plot_confusion_matrix-461"><a href="#plot_confusion_matrix-461"><span class="linenos">461</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_confusion_matrix-462"><a href="#plot_confusion_matrix-462"><span class="linenos">462</span></a><span class="sd">    Plots the classification results as confusion matrix (predicted vs. true labels) using seaborn.</span>
</span><span id="plot_confusion_matrix-463"><a href="#plot_confusion_matrix-463"><span class="linenos">463</span></a><span class="sd">    This reveals which labels were confused in model inference.</span>
</span><span id="plot_confusion_matrix-464"><a href="#plot_confusion_matrix-464"><span class="linenos">464</span></a><span class="sd">    Squares are framed in different colors according to correctness and completeness of the classification:</span>
</span><span id="plot_confusion_matrix-465"><a href="#plot_confusion_matrix-465"><span class="linenos">465</span></a><span class="sd">    - green frame: complete &amp; correct classification (for single-label and multi-label)</span>
</span><span id="plot_confusion_matrix-466"><a href="#plot_confusion_matrix-466"><span class="linenos">466</span></a><span class="sd">    - golden frame: incomplete, correct classification (only for multi-label)</span>
</span><span id="plot_confusion_matrix-467"><a href="#plot_confusion_matrix-467"><span class="linenos">467</span></a><span class="sd">    - orange frame: complete, partially incorrect classification (only for multi-label)</span>
</span><span id="plot_confusion_matrix-468"><a href="#plot_confusion_matrix-468"><span class="linenos">468</span></a><span class="sd">    - red frame: incomplete, partially incorrect classification (for single-label and multi-label)</span>
</span><span id="plot_confusion_matrix-469"><a href="#plot_confusion_matrix-469"><span class="linenos">469</span></a>
</span><span id="plot_confusion_matrix-470"><a href="#plot_confusion_matrix-470"><span class="linenos">470</span></a>
</span><span id="plot_confusion_matrix-471"><a href="#plot_confusion_matrix-471"><span class="linenos">471</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="plot_confusion_matrix-472"><a href="#plot_confusion_matrix-472"><span class="linenos">472</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="plot_confusion_matrix-473"><a href="#plot_confusion_matrix-473"><span class="linenos">473</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="plot_confusion_matrix-474"><a href="#plot_confusion_matrix-474"><span class="linenos">474</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="plot_confusion_matrix-475"><a href="#plot_confusion_matrix-475"><span class="linenos">475</span></a><span class="sd">    :type class_type: str</span>
</span><span id="plot_confusion_matrix-476"><a href="#plot_confusion_matrix-476"><span class="linenos">476</span></a><span class="sd">    :param save_plot: option to save the plot</span>
</span><span id="plot_confusion_matrix-477"><a href="#plot_confusion_matrix-477"><span class="linenos">477</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="plot_confusion_matrix-478"><a href="#plot_confusion_matrix-478"><span class="linenos">478</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_confusion_matrix-479"><a href="#plot_confusion_matrix-479"><span class="linenos">479</span></a>
</span><span id="plot_confusion_matrix-480"><a href="#plot_confusion_matrix-480"><span class="linenos">480</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;single-label&quot;</span><span class="p">,</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">]:</span>
</span><span id="plot_confusion_matrix-481"><a href="#plot_confusion_matrix-481"><span class="linenos">481</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="plot_confusion_matrix-482"><a href="#plot_confusion_matrix-482"><span class="linenos">482</span></a>            <span class="sa">f</span><span class="s1">&#39;Invalid class_type: </span><span class="si">{</span><span class="n">class_type</span><span class="si">}</span><span class="s1">. Must be either &quot;single-label&quot; or &quot;multi-label&quot;.&#39;</span>
</span><span id="plot_confusion_matrix-483"><a href="#plot_confusion_matrix-483"><span class="linenos">483</span></a>        <span class="p">)</span>
</span><span id="plot_confusion_matrix-484"><a href="#plot_confusion_matrix-484"><span class="linenos">484</span></a>
</span><span id="plot_confusion_matrix-485"><a href="#plot_confusion_matrix-485"><span class="linenos">485</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;single-label&quot;</span><span class="p">:</span>
</span><span id="plot_confusion_matrix-486"><a href="#plot_confusion_matrix-486"><span class="linenos">486</span></a>        <span class="n">labels_true</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="plot_confusion_matrix-487"><a href="#plot_confusion_matrix-487"><span class="linenos">487</span></a>            <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span>
</span><span id="plot_confusion_matrix-488"><a href="#plot_confusion_matrix-488"><span class="linenos">488</span></a>        <span class="p">]</span>  <span class="c1"># keep only first label (either isotope or pure background)</span>
</span><span id="plot_confusion_matrix-489"><a href="#plot_confusion_matrix-489"><span class="linenos">489</span></a>        <span class="n">labels_predict</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="plot_confusion_matrix-490"><a href="#plot_confusion_matrix-490"><span class="linenos">490</span></a>            <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span>
</span><span id="plot_confusion_matrix-491"><a href="#plot_confusion_matrix-491"><span class="linenos">491</span></a>        <span class="p">]</span>  <span class="c1"># keep only first key of dictionary</span>
</span><span id="plot_confusion_matrix-492"><a href="#plot_confusion_matrix-492"><span class="linenos">492</span></a>    <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="plot_confusion_matrix-493"><a href="#plot_confusion_matrix-493"><span class="linenos">493</span></a>        <span class="n">labels_true</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="plot_confusion_matrix-494"><a href="#plot_confusion_matrix-494"><span class="linenos">494</span></a>            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span>
</span><span id="plot_confusion_matrix-495"><a href="#plot_confusion_matrix-495"><span class="linenos">495</span></a>        <span class="p">]</span>  <span class="c1"># converts [&#39;Am241&#39;, &#39;background&#39;] to &#39;Am241 background&#39;</span>
</span><span id="plot_confusion_matrix-496"><a href="#plot_confusion_matrix-496"><span class="linenos">496</span></a>        <span class="n">labels_predict</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="plot_confusion_matrix-497"><a href="#plot_confusion_matrix-497"><span class="linenos">497</span></a>            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span>
</span><span id="plot_confusion_matrix-498"><a href="#plot_confusion_matrix-498"><span class="linenos">498</span></a>        <span class="p">]</span>
</span><span id="plot_confusion_matrix-499"><a href="#plot_confusion_matrix-499"><span class="linenos">499</span></a>
</span><span id="plot_confusion_matrix-500"><a href="#plot_confusion_matrix-500"><span class="linenos">500</span></a>    <span class="c1"># create list of class labels (serve as axes of the confusion matrix)</span>
</span><span id="plot_confusion_matrix-501"><a href="#plot_confusion_matrix-501"><span class="linenos">501</span></a>    <span class="n">class_labels_true</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels_true</span><span class="p">))</span>  <span class="c1"># x axis of confusion matrix</span>
</span><span id="plot_confusion_matrix-502"><a href="#plot_confusion_matrix-502"><span class="linenos">502</span></a>    <span class="n">class_labels_predict</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels_predict</span><span class="p">))</span>  <span class="c1"># y axis of confusion matrix</span>
</span><span id="plot_confusion_matrix-503"><a href="#plot_confusion_matrix-503"><span class="linenos">503</span></a>
</span><span id="plot_confusion_matrix-504"><a href="#plot_confusion_matrix-504"><span class="linenos">504</span></a>    <span class="c1"># map labels to indices</span>
</span><span id="plot_confusion_matrix-505"><a href="#plot_confusion_matrix-505"><span class="linenos">505</span></a>    <span class="n">label_to_index_true</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_labels_true</span><span class="p">)}</span>
</span><span id="plot_confusion_matrix-506"><a href="#plot_confusion_matrix-506"><span class="linenos">506</span></a>    <span class="n">label_to_index_predict</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_labels_predict</span><span class="p">)}</span>
</span><span id="plot_confusion_matrix-507"><a href="#plot_confusion_matrix-507"><span class="linenos">507</span></a>
</span><span id="plot_confusion_matrix-508"><a href="#plot_confusion_matrix-508"><span class="linenos">508</span></a>    <span class="c1"># set up empty confusion matrix</span>
</span><span id="plot_confusion_matrix-509"><a href="#plot_confusion_matrix-509"><span class="linenos">509</span></a>    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="plot_confusion_matrix-510"><a href="#plot_confusion_matrix-510"><span class="linenos">510</span></a>        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_labels_predict</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_labels_true</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span>
</span><span id="plot_confusion_matrix-511"><a href="#plot_confusion_matrix-511"><span class="linenos">511</span></a>    <span class="p">)</span>
</span><span id="plot_confusion_matrix-512"><a href="#plot_confusion_matrix-512"><span class="linenos">512</span></a>
</span><span id="plot_confusion_matrix-513"><a href="#plot_confusion_matrix-513"><span class="linenos">513</span></a>    <span class="c1"># fill confusion matrix by looping over lists of predicted and true labels</span>
</span><span id="plot_confusion_matrix-514"><a href="#plot_confusion_matrix-514"><span class="linenos">514</span></a>    <span class="k">for</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels_true</span><span class="p">,</span> <span class="n">labels_predict</span><span class="p">):</span>
</span><span id="plot_confusion_matrix-515"><a href="#plot_confusion_matrix-515"><span class="linenos">515</span></a>        <span class="n">confusion_matrix</span><span class="p">[</span><span class="n">label_to_index_predict</span><span class="p">[</span><span class="n">pred</span><span class="p">],</span> <span class="n">label_to_index_true</span><span class="p">[</span><span class="n">true</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="plot_confusion_matrix-516"><a href="#plot_confusion_matrix-516"><span class="linenos">516</span></a>
</span><span id="plot_confusion_matrix-517"><a href="#plot_confusion_matrix-517"><span class="linenos">517</span></a>    <span class="c1"># set up figure &amp; plot confusion matrix as seaborn heatmap</span>
</span><span id="plot_confusion_matrix-518"><a href="#plot_confusion_matrix-518"><span class="linenos">518</span></a>    <span class="n">fig_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_labels_true</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span>
</span><span id="plot_confusion_matrix-519"><a href="#plot_confusion_matrix-519"><span class="linenos">519</span></a>    <span class="n">fig_height</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_labels_predict</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
</span><span id="plot_confusion_matrix-520"><a href="#plot_confusion_matrix-520"><span class="linenos">520</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_width</span><span class="p">,</span> <span class="n">fig_height</span><span class="p">))</span>
</span><span id="plot_confusion_matrix-521"><a href="#plot_confusion_matrix-521"><span class="linenos">521</span></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
</span><span id="plot_confusion_matrix-522"><a href="#plot_confusion_matrix-522"><span class="linenos">522</span></a>        <span class="n">confusion_matrix</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-523"><a href="#plot_confusion_matrix-523"><span class="linenos">523</span></a>        <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-524"><a href="#plot_confusion_matrix-524"><span class="linenos">524</span></a>        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-525"><a href="#plot_confusion_matrix-525"><span class="linenos">525</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;YlGnBu&quot;</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-526"><a href="#plot_confusion_matrix-526"><span class="linenos">526</span></a>        <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
</span><span id="plot_confusion_matrix-527"><a href="#plot_confusion_matrix-527"><span class="linenos">527</span></a>        <span class="n">xticklabels</span><span class="o">=</span><span class="n">class_labels_true</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-528"><a href="#plot_confusion_matrix-528"><span class="linenos">528</span></a>        <span class="n">yticklabels</span><span class="o">=</span><span class="n">class_labels_predict</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-529"><a href="#plot_confusion_matrix-529"><span class="linenos">529</span></a>    <span class="p">)</span>
</span><span id="plot_confusion_matrix-530"><a href="#plot_confusion_matrix-530"><span class="linenos">530</span></a>
</span><span id="plot_confusion_matrix-531"><a href="#plot_confusion_matrix-531"><span class="linenos">531</span></a>    <span class="c1"># draw frames around the frames with their colors indicating the correctness &amp; completeness of the prediction</span>
</span><span id="plot_confusion_matrix-532"><a href="#plot_confusion_matrix-532"><span class="linenos">532</span></a>    <span class="k">for</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels_true</span><span class="p">,</span> <span class="n">labels_predict</span><span class="p">):</span>
</span><span id="plot_confusion_matrix-533"><a href="#plot_confusion_matrix-533"><span class="linenos">533</span></a>        <span class="n">true_idx</span> <span class="o">=</span> <span class="n">label_to_index_true</span><span class="p">[</span><span class="n">true</span><span class="p">]</span>
</span><span id="plot_confusion_matrix-534"><a href="#plot_confusion_matrix-534"><span class="linenos">534</span></a>        <span class="n">pred_idx</span> <span class="o">=</span> <span class="n">label_to_index_predict</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span>
</span><span id="plot_confusion_matrix-535"><a href="#plot_confusion_matrix-535"><span class="linenos">535</span></a>
</span><span id="plot_confusion_matrix-536"><a href="#plot_confusion_matrix-536"><span class="linenos">536</span></a>        <span class="c1"># green frame: complete &amp; correct classification</span>
</span><span id="plot_confusion_matrix-537"><a href="#plot_confusion_matrix-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">):</span>
</span><span id="plot_confusion_matrix-538"><a href="#plot_confusion_matrix-538"><span class="linenos">538</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>
</span><span id="plot_confusion_matrix-539"><a href="#plot_confusion_matrix-539"><span class="linenos">539</span></a>        <span class="c1"># golden frame: incomplete, correct classification</span>
</span><span id="plot_confusion_matrix-540"><a href="#plot_confusion_matrix-540"><span class="linenos">540</span></a>        <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">)):</span>
</span><span id="plot_confusion_matrix-541"><a href="#plot_confusion_matrix-541"><span class="linenos">541</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;gold&quot;</span>
</span><span id="plot_confusion_matrix-542"><a href="#plot_confusion_matrix-542"><span class="linenos">542</span></a>        <span class="c1"># orange frame: complete, partially incorrect classification</span>
</span><span id="plot_confusion_matrix-543"><a href="#plot_confusion_matrix-543"><span class="linenos">543</span></a>        <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)):</span>
</span><span id="plot_confusion_matrix-544"><a href="#plot_confusion_matrix-544"><span class="linenos">544</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;darkorange&quot;</span>
</span><span id="plot_confusion_matrix-545"><a href="#plot_confusion_matrix-545"><span class="linenos">545</span></a>        <span class="c1"># red frame: incomplete, partially incorrect classification</span>
</span><span id="plot_confusion_matrix-546"><a href="#plot_confusion_matrix-546"><span class="linenos">546</span></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">true</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="p">)):</span>
</span><span id="plot_confusion_matrix-547"><a href="#plot_confusion_matrix-547"><span class="linenos">547</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;darkred&quot;</span>
</span><span id="plot_confusion_matrix-548"><a href="#plot_confusion_matrix-548"><span class="linenos">548</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="plot_confusion_matrix-549"><a href="#plot_confusion_matrix-549"><span class="linenos">549</span></a>            <span class="k">continue</span>
</span><span id="plot_confusion_matrix-550"><a href="#plot_confusion_matrix-550"><span class="linenos">550</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="plot_confusion_matrix-551"><a href="#plot_confusion_matrix-551"><span class="linenos">551</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="plot_confusion_matrix-552"><a href="#plot_confusion_matrix-552"><span class="linenos">552</span></a>                <span class="p">(</span><span class="n">true_idx</span><span class="p">,</span> <span class="n">pred_idx</span><span class="p">),</span>
</span><span id="plot_confusion_matrix-553"><a href="#plot_confusion_matrix-553"><span class="linenos">553</span></a>                <span class="mf">0.93</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-554"><a href="#plot_confusion_matrix-554"><span class="linenos">554</span></a>                <span class="mf">0.93</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-555"><a href="#plot_confusion_matrix-555"><span class="linenos">555</span></a>                <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-556"><a href="#plot_confusion_matrix-556"><span class="linenos">556</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-557"><a href="#plot_confusion_matrix-557"><span class="linenos">557</span></a>                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="plot_confusion_matrix-558"><a href="#plot_confusion_matrix-558"><span class="linenos">558</span></a>            <span class="p">)</span>
</span><span id="plot_confusion_matrix-559"><a href="#plot_confusion_matrix-559"><span class="linenos">559</span></a>        <span class="p">)</span>
</span><span id="plot_confusion_matrix-560"><a href="#plot_confusion_matrix-560"><span class="linenos">560</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;true labels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="plot_confusion_matrix-561"><a href="#plot_confusion_matrix-561"><span class="linenos">561</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;predicted labels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="plot_confusion_matrix-562"><a href="#plot_confusion_matrix-562"><span class="linenos">562</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="plot_confusion_matrix-563"><a href="#plot_confusion_matrix-563"><span class="linenos">563</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Confusion Matrix&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="plot_confusion_matrix-564"><a href="#plot_confusion_matrix-564"><span class="linenos">564</span></a>    <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Confusion_matrix&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plots the classification results as confusion matrix (predicted vs. true labels) using seaborn.
This reveals which labels were confused in model inference.
Squares are framed in different colors according to correctness and completeness of the classification:</p>

<ul>
<li>green frame: complete &amp; correct classification (for single-label and multi-label)</li>
<li>golden frame: incomplete, correct classification (only for multi-label)</li>
<li>orange frame: complete, partially incorrect classification (only for multi-label)</li>
<li>red frame: incomplete, partially incorrect classification (for single-label and multi-label)</li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data_te</strong>:  test dataset (list of dictionaries with each dict containing one spectrum and metadata)</li>
<li><strong>class_type</strong>:  can be 'single-label' (use only dominant/first label for each spectrum) or
'multi-label' (use all labels)</li>
<li><strong>save_plot</strong>:  option to save the plot</li>
</ul>
</div>


                </section>
                <section id="plot_misclassified_spectra">
                            <input id="plot_misclassified_spectra-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_misclassified_spectra</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>, </span><span class="param"><span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_misclassified_spectra-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_misclassified_spectra"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_misclassified_spectra-567"><a href="#plot_misclassified_spectra-567"><span class="linenos">567</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_misclassified_spectra</span><span class="p">(</span><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="plot_misclassified_spectra-568"><a href="#plot_misclassified_spectra-568"><span class="linenos">568</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_misclassified_spectra-569"><a href="#plot_misclassified_spectra-569"><span class="linenos">569</span></a><span class="sd">    Plots three misclassified spectra, each in one line, in two subplots.</span>
</span><span id="plot_misclassified_spectra-570"><a href="#plot_misclassified_spectra-570"><span class="linenos">570</span></a><span class="sd">    Left side: In addition to the original spectrum, the mean spectrum of the correct and predicted label</span>
</span><span id="plot_misclassified_spectra-571"><a href="#plot_misclassified_spectra-571"><span class="linenos">571</span></a><span class="sd">    are plotted (in green and red) and the scores of the correct and predicted label are printed.</span>
</span><span id="plot_misclassified_spectra-572"><a href="#plot_misclassified_spectra-572"><span class="linenos">572</span></a><span class="sd">    Right side: In addition to the original spectrum, the denoised spectrum is plotted and</span>
</span><span id="plot_misclassified_spectra-573"><a href="#plot_misclassified_spectra-573"><span class="linenos">573</span></a><span class="sd">    their cosine similarity is calculated.</span>
</span><span id="plot_misclassified_spectra-574"><a href="#plot_misclassified_spectra-574"><span class="linenos">574</span></a>
</span><span id="plot_misclassified_spectra-575"><a href="#plot_misclassified_spectra-575"><span class="linenos">575</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="plot_misclassified_spectra-576"><a href="#plot_misclassified_spectra-576"><span class="linenos">576</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="plot_misclassified_spectra-577"><a href="#plot_misclassified_spectra-577"><span class="linenos">577</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="plot_misclassified_spectra-578"><a href="#plot_misclassified_spectra-578"><span class="linenos">578</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="plot_misclassified_spectra-579"><a href="#plot_misclassified_spectra-579"><span class="linenos">579</span></a><span class="sd">    :type class_type: str</span>
</span><span id="plot_misclassified_spectra-580"><a href="#plot_misclassified_spectra-580"><span class="linenos">580</span></a><span class="sd">    :param save_plot: option to save the plot</span>
</span><span id="plot_misclassified_spectra-581"><a href="#plot_misclassified_spectra-581"><span class="linenos">581</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="plot_misclassified_spectra-582"><a href="#plot_misclassified_spectra-582"><span class="linenos">582</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_misclassified_spectra-583"><a href="#plot_misclassified_spectra-583"><span class="linenos">583</span></a>
</span><span id="plot_misclassified_spectra-584"><a href="#plot_misclassified_spectra-584"><span class="linenos">584</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;single-label&quot;</span><span class="p">,</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">]:</span>
</span><span id="plot_misclassified_spectra-585"><a href="#plot_misclassified_spectra-585"><span class="linenos">585</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-586"><a href="#plot_misclassified_spectra-586"><span class="linenos">586</span></a>            <span class="sa">f</span><span class="s1">&#39;Invalid class_type: </span><span class="si">{</span><span class="n">class_type</span><span class="si">}</span><span class="s1">. Must be either &quot;single-label&quot; or &quot;multi-label&quot;.&#39;</span>
</span><span id="plot_misclassified_spectra-587"><a href="#plot_misclassified_spectra-587"><span class="linenos">587</span></a>        <span class="p">)</span>
</span><span id="plot_misclassified_spectra-588"><a href="#plot_misclassified_spectra-588"><span class="linenos">588</span></a>
</span><span id="plot_misclassified_spectra-589"><a href="#plot_misclassified_spectra-589"><span class="linenos">589</span></a>    <span class="c1"># divide data into correct and erroneous predictions</span>
</span><span id="plot_misclassified_spectra-590"><a href="#plot_misclassified_spectra-590"><span class="linenos">590</span></a>    <span class="n">data_corr</span><span class="p">,</span> <span class="n">data_err</span> <span class="o">=</span> <span class="n">identify_misclassifications</span><span class="p">(</span><span class="n">data_te</span><span class="p">,</span> <span class="n">class_type</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-591"><a href="#plot_misclassified_spectra-591"><span class="linenos">591</span></a>
</span><span id="plot_misclassified_spectra-592"><a href="#plot_misclassified_spectra-592"><span class="linenos">592</span></a>    <span class="c1"># calculate error ratio over whole test dataset</span>
</span><span id="plot_misclassified_spectra-593"><a href="#plot_misclassified_spectra-593"><span class="linenos">593</span></a>    <span class="n">err_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_err</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_corr</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_err</span><span class="p">))</span>
</span><span id="plot_misclassified_spectra-594"><a href="#plot_misclassified_spectra-594"><span class="linenos">594</span></a>
</span><span id="plot_misclassified_spectra-595"><a href="#plot_misclassified_spectra-595"><span class="linenos">595</span></a>    <span class="c1"># Choose misclassified spectra to be shown</span>
</span><span id="plot_misclassified_spectra-596"><a href="#plot_misclassified_spectra-596"><span class="linenos">596</span></a>    <span class="n">n_show</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="plot_misclassified_spectra-597"><a href="#plot_misclassified_spectra-597"><span class="linenos">597</span></a>    <span class="n">data_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">data_err</span><span class="p">,</span> <span class="n">n_show</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-598"><a href="#plot_misclassified_spectra-598"><span class="linenos">598</span></a>
</span><span id="plot_misclassified_spectra-599"><a href="#plot_misclassified_spectra-599"><span class="linenos">599</span></a>    <span class="c1"># set up figure</span>
</span><span id="plot_misclassified_spectra-600"><a href="#plot_misclassified_spectra-600"><span class="linenos">600</span></a>    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">2.4</span> <span class="o">*</span> <span class="n">n_show</span><span class="p">))</span>
</span><span id="plot_misclassified_spectra-601"><a href="#plot_misclassified_spectra-601"><span class="linenos">601</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Misclassified spectra (</span><span class="si">{</span><span class="n">err_ratio</span><span class="si">:</span><span class="s2"> .2%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-602"><a href="#plot_misclassified_spectra-602"><span class="linenos">602</span></a>
</span><span id="plot_misclassified_spectra-603"><a href="#plot_misclassified_spectra-603"><span class="linenos">603</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_err</span><span class="p">):</span>
</span><span id="plot_misclassified_spectra-604"><a href="#plot_misclassified_spectra-604"><span class="linenos">604</span></a>        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">])</span>
</span><span id="plot_misclassified_spectra-605"><a href="#plot_misclassified_spectra-605"><span class="linenos">605</span></a>        <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-606"><a href="#plot_misclassified_spectra-606"><span class="linenos">606</span></a>        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">/</span> <span class="n">counts</span>  <span class="c1"># normalize spectrum</span>
</span><span id="plot_misclassified_spectra-607"><a href="#plot_misclassified_spectra-607"><span class="linenos">607</span></a>
</span><span id="plot_misclassified_spectra-608"><a href="#plot_misclassified_spectra-608"><span class="linenos">608</span></a>        <span class="c1"># extract scores and map to isotopes in a dictionary</span>
</span><span id="plot_misclassified_spectra-609"><a href="#plot_misclassified_spectra-609"><span class="linenos">609</span></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">])</span>
</span><span id="plot_misclassified_spectra-610"><a href="#plot_misclassified_spectra-610"><span class="linenos">610</span></a>        <span class="n">scores_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="plot_misclassified_spectra-611"><a href="#plot_misclassified_spectra-611"><span class="linenos">611</span></a>            <span class="n">iso</span><span class="p">:</span> <span class="n">score</span> <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-612"><a href="#plot_misclassified_spectra-612"><span class="linenos">612</span></a>        <span class="p">}</span>
</span><span id="plot_misclassified_spectra-613"><a href="#plot_misclassified_spectra-613"><span class="linenos">613</span></a>
</span><span id="plot_misclassified_spectra-614"><a href="#plot_misclassified_spectra-614"><span class="linenos">614</span></a>        <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;single-label&quot;</span><span class="p">:</span>
</span><span id="plot_misclassified_spectra-615"><a href="#plot_misclassified_spectra-615"><span class="linenos">615</span></a>            <span class="n">label_true</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># extract first true label</span>
</span><span id="plot_misclassified_spectra-616"><a href="#plot_misclassified_spectra-616"><span class="linenos">616</span></a>            <span class="n">label_pred</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span>
</span><span id="plot_misclassified_spectra-617"><a href="#plot_misclassified_spectra-617"><span class="linenos">617</span></a>                <span class="mi">0</span>
</span><span id="plot_misclassified_spectra-618"><a href="#plot_misclassified_spectra-618"><span class="linenos">618</span></a>            <span class="p">]</span>  <span class="c1"># extract dominant predicted label</span>
</span><span id="plot_misclassified_spectra-619"><a href="#plot_misclassified_spectra-619"><span class="linenos">619</span></a>
</span><span id="plot_misclassified_spectra-620"><a href="#plot_misclassified_spectra-620"><span class="linenos">620</span></a>        <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="plot_misclassified_spectra-621"><a href="#plot_misclassified_spectra-621"><span class="linenos">621</span></a>            <span class="n">label_true</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-622"><a href="#plot_misclassified_spectra-622"><span class="linenos">622</span></a>                <span class="nb">sorted</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span>
</span><span id="plot_misclassified_spectra-623"><a href="#plot_misclassified_spectra-623"><span class="linenos">623</span></a>            <span class="p">)</span>  <span class="c1"># converts [&#39;Am241&#39;, &#39;background&#39;] to &#39;Am241 background&#39;</span>
</span><span id="plot_misclassified_spectra-624"><a href="#plot_misclassified_spectra-624"><span class="linenos">624</span></a>            <span class="n">label_pred</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="plot_misclassified_spectra-625"><a href="#plot_misclassified_spectra-625"><span class="linenos">625</span></a>
</span><span id="plot_misclassified_spectra-626"><a href="#plot_misclassified_spectra-626"><span class="linenos">626</span></a>        <span class="c1"># left side: misclassified spectrum and means of true and predicted labels</span>
</span><span id="plot_misclassified_spectra-627"><a href="#plot_misclassified_spectra-627"><span class="linenos">627</span></a>        <span class="n">ax_left</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">n_show</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-628"><a href="#plot_misclassified_spectra-628"><span class="linenos">628</span></a>        <span class="n">labeltext_left</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;counts: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2"> detector: </span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2"> absorber thickness: </span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;absorber thickness&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_misclassified_spectra-629"><a href="#plot_misclassified_spectra-629"><span class="linenos">629</span></a>        <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-630"><a href="#plot_misclassified_spectra-630"><span class="linenos">630</span></a>            <span class="n">spectrum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labeltext_left</span>
</span><span id="plot_misclassified_spectra-631"><a href="#plot_misclassified_spectra-631"><span class="linenos">631</span></a>        <span class="p">)</span>  <span class="c1"># plot misclassified spectrum</span>
</span><span id="plot_misclassified_spectra-632"><a href="#plot_misclassified_spectra-632"><span class="linenos">632</span></a>        <span class="n">ax_left</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-633"><a href="#plot_misclassified_spectra-633"><span class="linenos">633</span></a>
</span><span id="plot_misclassified_spectra-634"><a href="#plot_misclassified_spectra-634"><span class="linenos">634</span></a>        <span class="c1"># set up dictionary to map isotopes to principal components (columns of loadings_tr)</span>
</span><span id="plot_misclassified_spectra-635"><a href="#plot_misclassified_spectra-635"><span class="linenos">635</span></a>        <span class="n">loadings_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="plot_misclassified_spectra-636"><a href="#plot_misclassified_spectra-636"><span class="linenos">636</span></a>            <span class="n">iso</span><span class="p">:</span> <span class="n">pc</span>
</span><span id="plot_misclassified_spectra-637"><a href="#plot_misclassified_spectra-637"><span class="linenos">637</span></a>            <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">pc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">loadings_tr</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-638"><a href="#plot_misclassified_spectra-638"><span class="linenos">638</span></a>        <span class="p">}</span>
</span><span id="plot_misclassified_spectra-639"><a href="#plot_misclassified_spectra-639"><span class="linenos">639</span></a>
</span><span id="plot_misclassified_spectra-640"><a href="#plot_misclassified_spectra-640"><span class="linenos">640</span></a>        <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;single-label&quot;</span><span class="p">:</span>
</span><span id="plot_misclassified_spectra-641"><a href="#plot_misclassified_spectra-641"><span class="linenos">641</span></a>            <span class="c1"># extract &amp; normalize mean of predicted isotope</span>
</span><span id="plot_misclassified_spectra-642"><a href="#plot_misclassified_spectra-642"><span class="linenos">642</span></a>            <span class="n">pc_predict</span> <span class="o">=</span> <span class="n">loadings_dict</span><span class="p">[</span><span class="n">label_pred</span><span class="p">]</span>  <span class="c1"># mean spectrum (predicted isotope)</span>
</span><span id="plot_misclassified_spectra-643"><a href="#plot_misclassified_spectra-643"><span class="linenos">643</span></a>            <span class="n">pc_predict</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">pc_predict</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-644"><a href="#plot_misclassified_spectra-644"><span class="linenos">644</span></a>
</span><span id="plot_misclassified_spectra-645"><a href="#plot_misclassified_spectra-645"><span class="linenos">645</span></a>            <span class="c1"># extract &amp; normalize mean of true isotope</span>
</span><span id="plot_misclassified_spectra-646"><a href="#plot_misclassified_spectra-646"><span class="linenos">646</span></a>            <span class="n">pc_true</span> <span class="o">=</span> <span class="n">loadings_dict</span><span class="p">[</span><span class="n">label_true</span><span class="p">]</span>  <span class="c1"># mean spectrum (true isotope)</span>
</span><span id="plot_misclassified_spectra-647"><a href="#plot_misclassified_spectra-647"><span class="linenos">647</span></a>            <span class="n">pc_true</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">pc_true</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-648"><a href="#plot_misclassified_spectra-648"><span class="linenos">648</span></a>
</span><span id="plot_misclassified_spectra-649"><a href="#plot_misclassified_spectra-649"><span class="linenos">649</span></a>            <span class="c1"># plot both means in left subplot</span>
</span><span id="plot_misclassified_spectra-650"><a href="#plot_misclassified_spectra-650"><span class="linenos">650</span></a>            <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-651"><a href="#plot_misclassified_spectra-651"><span class="linenos">651</span></a>                <span class="n">pc_predict</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;firebrick&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;predicted: </span><span class="si">{</span><span class="n">label_pred</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_misclassified_spectra-652"><a href="#plot_misclassified_spectra-652"><span class="linenos">652</span></a>            <span class="p">)</span>
</span><span id="plot_misclassified_spectra-653"><a href="#plot_misclassified_spectra-653"><span class="linenos">653</span></a>            <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-654"><a href="#plot_misclassified_spectra-654"><span class="linenos">654</span></a>                <span class="n">pc_true</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;correct label: </span><span class="si">{</span><span class="n">label_true</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_misclassified_spectra-655"><a href="#plot_misclassified_spectra-655"><span class="linenos">655</span></a>            <span class="p">)</span>
</span><span id="plot_misclassified_spectra-656"><a href="#plot_misclassified_spectra-656"><span class="linenos">656</span></a>
</span><span id="plot_misclassified_spectra-657"><a href="#plot_misclassified_spectra-657"><span class="linenos">657</span></a>            <span class="c1"># annotate predicted and true scores in left subplot</span>
</span><span id="plot_misclassified_spectra-658"><a href="#plot_misclassified_spectra-658"><span class="linenos">658</span></a>            <span class="n">annot_text_left0</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_misclassified_spectra-659"><a href="#plot_misclassified_spectra-659"><span class="linenos">659</span></a>                <span class="sa">f</span><span class="s2">&quot;scores predict (</span><span class="si">{</span><span class="n">label_pred</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">scores_dict</span><span class="p">[</span><span class="n">label_pred</span><span class="p">]</span><span class="si">:</span><span class="s2"> .3</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="plot_misclassified_spectra-660"><a href="#plot_misclassified_spectra-660"><span class="linenos">660</span></a>            <span class="p">)</span>
</span><span id="plot_misclassified_spectra-661"><a href="#plot_misclassified_spectra-661"><span class="linenos">661</span></a>            <span class="n">annot_text_left1</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_misclassified_spectra-662"><a href="#plot_misclassified_spectra-662"><span class="linenos">662</span></a>                <span class="sa">f</span><span class="s2">&quot;scores true (</span><span class="si">{</span><span class="n">label_true</span><span class="si">}</span><span class="s2">) : </span><span class="si">{</span><span class="n">scores_dict</span><span class="p">[</span><span class="n">label_true</span><span class="p">]</span><span class="si">:</span><span class="s2"> .3</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_misclassified_spectra-663"><a href="#plot_misclassified_spectra-663"><span class="linenos">663</span></a>            <span class="p">)</span>
</span><span id="plot_misclassified_spectra-664"><a href="#plot_misclassified_spectra-664"><span class="linenos">664</span></a>            <span class="n">annot_text_left</span> <span class="o">=</span> <span class="n">annot_text_left0</span> <span class="o">+</span> <span class="n">annot_text_left1</span>
</span><span id="plot_misclassified_spectra-665"><a href="#plot_misclassified_spectra-665"><span class="linenos">665</span></a>            <span class="n">ax_left</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">annot_text_left</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-666"><a href="#plot_misclassified_spectra-666"><span class="linenos">666</span></a>
</span><span id="plot_misclassified_spectra-667"><a href="#plot_misclassified_spectra-667"><span class="linenos">667</span></a>        <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="plot_misclassified_spectra-668"><a href="#plot_misclassified_spectra-668"><span class="linenos">668</span></a>            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="plot_misclassified_spectra-669"><a href="#plot_misclassified_spectra-669"><span class="linenos">669</span></a>                <span class="c1"># extract &amp; normalize means of predicted isotopes, plot them in left subplot</span>
</span><span id="plot_misclassified_spectra-670"><a href="#plot_misclassified_spectra-670"><span class="linenos">670</span></a>                <span class="n">pc_predict</span> <span class="o">=</span> <span class="n">loadings_dict</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span>
</span><span id="plot_misclassified_spectra-671"><a href="#plot_misclassified_spectra-671"><span class="linenos">671</span></a>                <span class="n">pc_predict</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">pc_predict</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-672"><a href="#plot_misclassified_spectra-672"><span class="linenos">672</span></a>                <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-673"><a href="#plot_misclassified_spectra-673"><span class="linenos">673</span></a>                    <span class="n">pc_predict</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;firebrick&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;predicted: </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_misclassified_spectra-674"><a href="#plot_misclassified_spectra-674"><span class="linenos">674</span></a>                <span class="p">)</span>
</span><span id="plot_misclassified_spectra-675"><a href="#plot_misclassified_spectra-675"><span class="linenos">675</span></a>
</span><span id="plot_misclassified_spectra-676"><a href="#plot_misclassified_spectra-676"><span class="linenos">676</span></a>            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]:</span>
</span><span id="plot_misclassified_spectra-677"><a href="#plot_misclassified_spectra-677"><span class="linenos">677</span></a>                <span class="k">if</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">loadings_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="plot_misclassified_spectra-678"><a href="#plot_misclassified_spectra-678"><span class="linenos">678</span></a>                    <span class="c1"># extract &amp; normalize means of true isotopes, plot them in left subplot</span>
</span><span id="plot_misclassified_spectra-679"><a href="#plot_misclassified_spectra-679"><span class="linenos">679</span></a>                    <span class="n">pc_true</span> <span class="o">=</span> <span class="n">loadings_dict</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span>
</span><span id="plot_misclassified_spectra-680"><a href="#plot_misclassified_spectra-680"><span class="linenos">680</span></a>                    <span class="n">pc_true</span> <span class="o">=</span> <span class="n">normalize_spectra</span><span class="p">(</span><span class="n">pc_true</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-681"><a href="#plot_misclassified_spectra-681"><span class="linenos">681</span></a>                    <span class="n">ax_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-682"><a href="#plot_misclassified_spectra-682"><span class="linenos">682</span></a>                        <span class="n">pc_true</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;correct label: </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_misclassified_spectra-683"><a href="#plot_misclassified_spectra-683"><span class="linenos">683</span></a>                    <span class="p">)</span>
</span><span id="plot_misclassified_spectra-684"><a href="#plot_misclassified_spectra-684"><span class="linenos">684</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="plot_misclassified_spectra-685"><a href="#plot_misclassified_spectra-685"><span class="linenos">685</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-686"><a href="#plot_misclassified_spectra-686"><span class="linenos">686</span></a>                        <span class="sa">f</span><span class="s2">&quot;ERROR: No principal component found for </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">. Maybe </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> was not included in model training?&quot;</span>
</span><span id="plot_misclassified_spectra-687"><a href="#plot_misclassified_spectra-687"><span class="linenos">687</span></a>                    <span class="p">)</span>
</span><span id="plot_misclassified_spectra-688"><a href="#plot_misclassified_spectra-688"><span class="linenos">688</span></a>
</span><span id="plot_misclassified_spectra-689"><a href="#plot_misclassified_spectra-689"><span class="linenos">689</span></a>            <span class="c1"># annotate predicted scores</span>
</span><span id="plot_misclassified_spectra-690"><a href="#plot_misclassified_spectra-690"><span class="linenos">690</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_true</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-691"><a href="#plot_misclassified_spectra-691"><span class="linenos">691</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;labels_pred_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-692"><a href="#plot_misclassified_spectra-692"><span class="linenos">692</span></a>            <span class="n">annot_text_right0</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="plot_misclassified_spectra-693"><a href="#plot_misclassified_spectra-693"><span class="linenos">693</span></a>                <span class="n">iso</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">sco</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">sco</span> <span class="ow">in</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="plot_misclassified_spectra-694"><a href="#plot_misclassified_spectra-694"><span class="linenos">694</span></a>            <span class="p">}</span>
</span><span id="plot_misclassified_spectra-695"><a href="#plot_misclassified_spectra-695"><span class="linenos">695</span></a>            <span class="k">if</span> <span class="n">label_true</span> <span class="ow">in</span> <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="plot_misclassified_spectra-696"><a href="#plot_misclassified_spectra-696"><span class="linenos">696</span></a>                <span class="n">annot_text_right1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;scores true (</span><span class="si">{</span><span class="n">label_true</span><span class="si">}</span><span class="s2">):  </span><span class="si">{</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;labels_pred_dict&#39;</span><span class="p">][</span><span class="n">label_true</span><span class="p">]</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="plot_misclassified_spectra-697"><a href="#plot_misclassified_spectra-697"><span class="linenos">697</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="plot_misclassified_spectra-698"><a href="#plot_misclassified_spectra-698"><span class="linenos">698</span></a>                <span class="n">annot_text_right1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="plot_misclassified_spectra-699"><a href="#plot_misclassified_spectra-699"><span class="linenos">699</span></a>
</span><span id="plot_misclassified_spectra-700"><a href="#plot_misclassified_spectra-700"><span class="linenos">700</span></a>            <span class="k">def</span><span class="w"> </span><span class="nf">wrap_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
</span><span id="plot_misclassified_spectra-701"><a href="#plot_misclassified_spectra-701"><span class="linenos">701</span></a>                <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-702"><a href="#plot_misclassified_spectra-702"><span class="linenos">702</span></a>                    <span class="p">[</span><span class="n">text</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">width</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">width</span><span class="p">)]</span>
</span><span id="plot_misclassified_spectra-703"><a href="#plot_misclassified_spectra-703"><span class="linenos">703</span></a>                <span class="p">)</span>
</span><span id="plot_misclassified_spectra-704"><a href="#plot_misclassified_spectra-704"><span class="linenos">704</span></a>
</span><span id="plot_misclassified_spectra-705"><a href="#plot_misclassified_spectra-705"><span class="linenos">705</span></a>            <span class="n">wrap_width</span> <span class="o">=</span> <span class="mi">45</span>  <span class="c1"># maximum width of annotation line</span>
</span><span id="plot_misclassified_spectra-706"><a href="#plot_misclassified_spectra-706"><span class="linenos">706</span></a>            <span class="n">annot_text_right</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_misclassified_spectra-707"><a href="#plot_misclassified_spectra-707"><span class="linenos">707</span></a>                <span class="sa">f</span><span class="s2">&quot;scores predict: </span><span class="si">{</span><span class="n">wrap_text</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">annot_text_right0</span><span class="p">),</span><span class="w"> </span><span class="n">wrap_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="plot_misclassified_spectra-708"><a href="#plot_misclassified_spectra-708"><span class="linenos">708</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wrap_text</span><span class="p">(</span><span class="n">annot_text_right1</span><span class="p">,</span><span class="w"> </span><span class="n">wrap_width</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_misclassified_spectra-709"><a href="#plot_misclassified_spectra-709"><span class="linenos">709</span></a>            <span class="p">)</span>
</span><span id="plot_misclassified_spectra-710"><a href="#plot_misclassified_spectra-710"><span class="linenos">710</span></a>
</span><span id="plot_misclassified_spectra-711"><a href="#plot_misclassified_spectra-711"><span class="linenos">711</span></a>            <span class="n">ax_left</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">annot_text_right</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-712"><a href="#plot_misclassified_spectra-712"><span class="linenos">712</span></a>
</span><span id="plot_misclassified_spectra-713"><a href="#plot_misclassified_spectra-713"><span class="linenos">713</span></a>        <span class="n">ax_left</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-714"><a href="#plot_misclassified_spectra-714"><span class="linenos">714</span></a>        <span class="n">ax_left</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="plot_misclassified_spectra-715"><a href="#plot_misclassified_spectra-715"><span class="linenos">715</span></a>
</span><span id="plot_misclassified_spectra-716"><a href="#plot_misclassified_spectra-716"><span class="linenos">716</span></a>        <span class="c1"># extract and normalize denoised spectrum</span>
</span><span id="plot_misclassified_spectra-717"><a href="#plot_misclassified_spectra-717"><span class="linenos">717</span></a>        <span class="n">denoised</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s2">&quot;denoised&quot;</span><span class="p">])</span>
</span><span id="plot_misclassified_spectra-718"><a href="#plot_misclassified_spectra-718"><span class="linenos">718</span></a>        <span class="n">denoised</span> <span class="o">=</span> <span class="n">denoised</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">denoised</span><span class="p">))</span>
</span><span id="plot_misclassified_spectra-719"><a href="#plot_misclassified_spectra-719"><span class="linenos">719</span></a>
</span><span id="plot_misclassified_spectra-720"><a href="#plot_misclassified_spectra-720"><span class="linenos">720</span></a>        <span class="c1"># calculate cosine similarity between origina</span>
</span><span id="plot_misclassified_spectra-721"><a href="#plot_misclassified_spectra-721"><span class="linenos">721</span></a>        <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">denoised</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-722"><a href="#plot_misclassified_spectra-722"><span class="linenos">722</span></a>
</span><span id="plot_misclassified_spectra-723"><a href="#plot_misclassified_spectra-723"><span class="linenos">723</span></a>        <span class="c1"># right subplot: original &amp; denoised spectrum</span>
</span><span id="plot_misclassified_spectra-724"><a href="#plot_misclassified_spectra-724"><span class="linenos">724</span></a>        <span class="n">ax_right</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">n_show</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-725"><a href="#plot_misclassified_spectra-725"><span class="linenos">725</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_true</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-726"><a href="#plot_misclassified_spectra-726"><span class="linenos">726</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">denoised</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;denoised spectrum&quot;</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-727"><a href="#plot_misclassified_spectra-727"><span class="linenos">727</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-728"><a href="#plot_misclassified_spectra-728"><span class="linenos">728</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="plot_misclassified_spectra-729"><a href="#plot_misclassified_spectra-729"><span class="linenos">729</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-730"><a href="#plot_misclassified_spectra-730"><span class="linenos">730</span></a>            <span class="sa">f</span><span class="s2">&quot;cosine similarity: </span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2"> .3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span>
</span><span id="plot_misclassified_spectra-731"><a href="#plot_misclassified_spectra-731"><span class="linenos">731</span></a>        <span class="p">)</span>
</span><span id="plot_misclassified_spectra-732"><a href="#plot_misclassified_spectra-732"><span class="linenos">732</span></a>        <span class="n">ax_right</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="plot_misclassified_spectra-733"><a href="#plot_misclassified_spectra-733"><span class="linenos">733</span></a>
</span><span id="plot_misclassified_spectra-734"><a href="#plot_misclassified_spectra-734"><span class="linenos">734</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_misclassified_spectra-735"><a href="#plot_misclassified_spectra-735"><span class="linenos">735</span></a>    <span class="n">saveplot</span><span class="p">(</span>
</span><span id="plot_misclassified_spectra-736"><a href="#plot_misclassified_spectra-736"><span class="linenos">736</span></a>        <span class="n">save_plot</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Misclassified_spectra&quot;</span>
</span><span id="plot_misclassified_spectra-737"><a href="#plot_misclassified_spectra-737"><span class="linenos">737</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plots three misclassified spectra, each in one line, in two subplots.
Left side: In addition to the original spectrum, the mean spectrum of the correct and predicted label
are plotted (in green and red) and the scores of the correct and predicted label are printed.
Right side: In addition to the original spectrum, the denoised spectrum is plotted and
their cosine similarity is calculated.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data_te</strong>:  test dataset (list of dictionaries with each dict containing one spectrum and metadata)</li>
<li><strong>class_type</strong>:  can be 'single-label' (use only dominant/first label for each spectrum) or
'multi-label' (use all labels)</li>
<li><strong>save_plot</strong>:  option to save the plot</li>
</ul>
</div>


                </section>
                <section id="plot_denoised_spectrum_example">
                            <input id="plot_denoised_spectrum_example-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_denoised_spectrum_example</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_denoised_spectrum_example-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_denoised_spectrum_example"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_denoised_spectrum_example-740"><a href="#plot_denoised_spectrum_example-740"><span class="linenos">740</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_denoised_spectrum_example</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
</span><span id="plot_denoised_spectrum_example-741"><a href="#plot_denoised_spectrum_example-741"><span class="linenos">741</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_denoised_spectrum_example-742"><a href="#plot_denoised_spectrum_example-742"><span class="linenos">742</span></a><span class="sd">    The original and denoised spectrum are plotted for a random example spectrum and their cosine similarity is printed.</span>
</span><span id="plot_denoised_spectrum_example-743"><a href="#plot_denoised_spectrum_example-743"><span class="linenos">743</span></a>
</span><span id="plot_denoised_spectrum_example-744"><a href="#plot_denoised_spectrum_example-744"><span class="linenos">744</span></a><span class="sd">    :param data: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="plot_denoised_spectrum_example-745"><a href="#plot_denoised_spectrum_example-745"><span class="linenos">745</span></a><span class="sd">    :type data: List[dict]</span>
</span><span id="plot_denoised_spectrum_example-746"><a href="#plot_denoised_spectrum_example-746"><span class="linenos">746</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_denoised_spectrum_example-747"><a href="#plot_denoised_spectrum_example-747"><span class="linenos">747</span></a>    <span class="n">cherry_picking</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="plot_denoised_spectrum_example-748"><a href="#plot_denoised_spectrum_example-748"><span class="linenos">748</span></a>    <span class="k">if</span> <span class="n">cherry_picking</span><span class="p">:</span>
</span><span id="plot_denoised_spectrum_example-749"><a href="#plot_denoised_spectrum_example-749"><span class="linenos">749</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="s2">&quot;Cs137&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]]</span>
</span><span id="plot_denoised_spectrum_example-750"><a href="#plot_denoised_spectrum_example-750"><span class="linenos">750</span></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="plot_denoised_spectrum_example-751"><a href="#plot_denoised_spectrum_example-751"><span class="linenos">751</span></a>            <span class="n">exp_var</span> <span class="o">=</span> <span class="n">explained_variance_score</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;denoised&quot;</span><span class="p">])</span>
</span><span id="plot_denoised_spectrum_example-752"><a href="#plot_denoised_spectrum_example-752"><span class="linenos">752</span></a>            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;exp_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_var</span>
</span><span id="plot_denoised_spectrum_example-753"><a href="#plot_denoised_spectrum_example-753"><span class="linenos">753</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;exp_var&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.98</span><span class="p">]</span>
</span><span id="plot_denoised_spectrum_example-754"><a href="#plot_denoised_spectrum_example-754"><span class="linenos">754</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="plot_denoised_spectrum_example-755"><a href="#plot_denoised_spectrum_example-755"><span class="linenos">755</span></a>            <span class="n">x</span>
</span><span id="plot_denoised_spectrum_example-756"><a href="#plot_denoised_spectrum_example-756"><span class="linenos">756</span></a>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span>
</span><span id="plot_denoised_spectrum_example-757"><a href="#plot_denoised_spectrum_example-757"><span class="linenos">757</span></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">label</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span>
</span><span id="plot_denoised_spectrum_example-758"><a href="#plot_denoised_spectrum_example-758"><span class="linenos">758</span></a>        <span class="p">]</span>
</span><span id="plot_denoised_spectrum_example-759"><a href="#plot_denoised_spectrum_example-759"><span class="linenos">759</span></a>
</span><span id="plot_denoised_spectrum_example-760"><a href="#plot_denoised_spectrum_example-760"><span class="linenos">760</span></a>    <span class="c1"># pick a random spectrum and extract original, denoised spectrum, true and predicted labels</span>
</span><span id="plot_denoised_spectrum_example-761"><a href="#plot_denoised_spectrum_example-761"><span class="linenos">761</span></a>    <span class="n">n_spectra</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-762"><a href="#plot_denoised_spectrum_example-762"><span class="linenos">762</span></a>    <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_spectra</span><span class="p">))</span>
</span><span id="plot_denoised_spectrum_example-763"><a href="#plot_denoised_spectrum_example-763"><span class="linenos">763</span></a>    <span class="n">original_spectrum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">]</span>
</span><span id="plot_denoised_spectrum_example-764"><a href="#plot_denoised_spectrum_example-764"><span class="linenos">764</span></a>    <span class="n">denoised_spectrum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s2">&quot;denoised&quot;</span><span class="p">]</span>
</span><span id="plot_denoised_spectrum_example-765"><a href="#plot_denoised_spectrum_example-765"><span class="linenos">765</span></a>
</span><span id="plot_denoised_spectrum_example-766"><a href="#plot_denoised_spectrum_example-766"><span class="linenos">766</span></a>    <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
</span><span id="plot_denoised_spectrum_example-767"><a href="#plot_denoised_spectrum_example-767"><span class="linenos">767</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="plot_denoised_spectrum_example-768"><a href="#plot_denoised_spectrum_example-768"><span class="linenos">768</span></a>        <span class="n">title_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Denoised spectrum (true label: </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="plot_denoised_spectrum_example-769"><a href="#plot_denoised_spectrum_example-769"><span class="linenos">769</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="plot_denoised_spectrum_example-770"><a href="#plot_denoised_spectrum_example-770"><span class="linenos">770</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="plot_denoised_spectrum_example-771"><a href="#plot_denoised_spectrum_example-771"><span class="linenos">771</span></a>        <span class="n">title_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Denoised spectrum (true labels: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="plot_denoised_spectrum_example-772"><a href="#plot_denoised_spectrum_example-772"><span class="linenos">772</span></a>    <span class="c1"># labels = labels[0] if len(labels) == 1 else labels  # convert [&#39;Am241&#39;] to &#39;Am241&#39;</span>
</span><span id="plot_denoised_spectrum_example-773"><a href="#plot_denoised_spectrum_example-773"><span class="linenos">773</span></a>
</span><span id="plot_denoised_spectrum_example-774"><a href="#plot_denoised_spectrum_example-774"><span class="linenos">774</span></a>    <span class="n">labels_pred_dict</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span>
</span><span id="plot_denoised_spectrum_example-775"><a href="#plot_denoised_spectrum_example-775"><span class="linenos">775</span></a>    <span class="n">labels_pred_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="plot_denoised_spectrum_example-776"><a href="#plot_denoised_spectrum_example-776"><span class="linenos">776</span></a>        <span class="n">iso</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">sco</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">sco</span> <span class="ow">in</span> <span class="n">labels_pred_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="plot_denoised_spectrum_example-777"><a href="#plot_denoised_spectrum_example-777"><span class="linenos">777</span></a>    <span class="p">}</span>  <span class="c1"># round scores</span>
</span><span id="plot_denoised_spectrum_example-778"><a href="#plot_denoised_spectrum_example-778"><span class="linenos">778</span></a>    <span class="n">annot_text</span> <span class="o">=</span> <span class="s2">&quot;Predicted isotopes: &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="plot_denoised_spectrum_example-779"><a href="#plot_denoised_spectrum_example-779"><span class="linenos">779</span></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">,&quot;</span> <span class="k">for</span> <span class="n">iso</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">labels_pred_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="plot_denoised_spectrum_example-780"><a href="#plot_denoised_spectrum_example-780"><span class="linenos">780</span></a>    <span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-781"><a href="#plot_denoised_spectrum_example-781"><span class="linenos">781</span></a>    <span class="n">annot_text</span> <span class="o">=</span> <span class="n">annot_text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="plot_denoised_spectrum_example-782"><a href="#plot_denoised_spectrum_example-782"><span class="linenos">782</span></a>    <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">original_spectrum</span><span class="p">,</span> <span class="n">denoised_spectrum</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-783"><a href="#plot_denoised_spectrum_example-783"><span class="linenos">783</span></a>    <span class="n">exp_var</span> <span class="o">=</span> <span class="n">explained_variance_score</span><span class="p">(</span><span class="n">original_spectrum</span><span class="p">,</span> <span class="n">denoised_spectrum</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-784"><a href="#plot_denoised_spectrum_example-784"><span class="linenos">784</span></a>
</span><span id="plot_denoised_spectrum_example-785"><a href="#plot_denoised_spectrum_example-785"><span class="linenos">785</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="plot_denoised_spectrum_example-786"><a href="#plot_denoised_spectrum_example-786"><span class="linenos">786</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title_text</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-787"><a href="#plot_denoised_spectrum_example-787"><span class="linenos">787</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">original_spectrum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;original spectrum&quot;</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-788"><a href="#plot_denoised_spectrum_example-788"><span class="linenos">788</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">denoised_spectrum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;denoised spectrum&quot;</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-789"><a href="#plot_denoised_spectrum_example-789"><span class="linenos">789</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="plot_denoised_spectrum_example-790"><a href="#plot_denoised_spectrum_example-790"><span class="linenos">790</span></a>        <span class="n">annot_text</span><span class="p">,</span>
</span><span id="plot_denoised_spectrum_example-791"><a href="#plot_denoised_spectrum_example-791"><span class="linenos">791</span></a>        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">),</span>
</span><span id="plot_denoised_spectrum_example-792"><a href="#plot_denoised_spectrum_example-792"><span class="linenos">792</span></a>        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="plot_denoised_spectrum_example-793"><a href="#plot_denoised_spectrum_example-793"><span class="linenos">793</span></a>    <span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-794"><a href="#plot_denoised_spectrum_example-794"><span class="linenos">794</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="plot_denoised_spectrum_example-795"><a href="#plot_denoised_spectrum_example-795"><span class="linenos">795</span></a>        <span class="sa">f</span><span class="s2">&quot;cosine similarity: </span><span class="si">{</span><span class="n">cos_sim</span><span class="si">:</span><span class="s2"> .2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span>
</span><span id="plot_denoised_spectrum_example-796"><a href="#plot_denoised_spectrum_example-796"><span class="linenos">796</span></a>    <span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-797"><a href="#plot_denoised_spectrum_example-797"><span class="linenos">797</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
</span><span id="plot_denoised_spectrum_example-798"><a href="#plot_denoised_spectrum_example-798"><span class="linenos">798</span></a>        <span class="sa">f</span><span class="s2">&quot;explained variance ratio: </span><span class="si">{</span><span class="n">exp_var</span><span class="si">:</span><span class="s2"> .2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="plot_denoised_spectrum_example-799"><a href="#plot_denoised_spectrum_example-799"><span class="linenos">799</span></a>        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.82</span><span class="p">),</span>
</span><span id="plot_denoised_spectrum_example-800"><a href="#plot_denoised_spectrum_example-800"><span class="linenos">800</span></a>        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="plot_denoised_spectrum_example-801"><a href="#plot_denoised_spectrum_example-801"><span class="linenos">801</span></a>    <span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-802"><a href="#plot_denoised_spectrum_example-802"><span class="linenos">802</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-803"><a href="#plot_denoised_spectrum_example-803"><span class="linenos">803</span></a>    <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">original_spectrum</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">denoised_spectrum</span><span class="p">)])</span>
</span><span id="plot_denoised_spectrum_example-804"><a href="#plot_denoised_spectrum_example-804"><span class="linenos">804</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">1.3</span> <span class="o">*</span> <span class="n">y_max</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-805"><a href="#plot_denoised_spectrum_example-805"><span class="linenos">805</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;energy channels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-806"><a href="#plot_denoised_spectrum_example-806"><span class="linenos">806</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-807"><a href="#plot_denoised_spectrum_example-807"><span class="linenos">807</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="plot_denoised_spectrum_example-808"><a href="#plot_denoised_spectrum_example-808"><span class="linenos">808</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>The original and denoised spectrum are plotted for a random example spectrum and their cosine similarity is printed.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong>:  test dataset (list of dictionaries with each dict containing one spectrum and metadata)</li>
</ul>
</div>


                </section>
                <section id="plot_misclassification_statistics">
                            <input id="plot_misclassification_statistics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_misclassification_statistics</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>, </span><span class="param"><span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_misclassification_statistics-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_misclassification_statistics"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_misclassification_statistics-811"><a href="#plot_misclassification_statistics-811"><span class="linenos">811</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_misclassification_statistics</span><span class="p">(</span><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="plot_misclassification_statistics-812"><a href="#plot_misclassification_statistics-812"><span class="linenos">812</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_misclassification_statistics-813"><a href="#plot_misclassification_statistics-813"><span class="linenos">813</span></a><span class="sd">    Plots histograms of correct (green) and wrong (red) classifications versus different quantities:</span>
</span><span id="plot_misclassification_statistics-814"><a href="#plot_misclassification_statistics-814"><span class="linenos">814</span></a>
</span><span id="plot_misclassification_statistics-815"><a href="#plot_misclassification_statistics-815"><span class="linenos">815</span></a><span class="sd">    - explained variance ratio (measure for the explained variance between original &amp; denoised spectrum)</span>
</span><span id="plot_misclassification_statistics-816"><a href="#plot_misclassification_statistics-816"><span class="linenos">816</span></a><span class="sd">    - cosine similarity (measure for the similarity between original &amp; denoised spectrum)</span>
</span><span id="plot_misclassification_statistics-817"><a href="#plot_misclassification_statistics-817"><span class="linenos">817</span></a><span class="sd">    - integral of the spectrum (number of counts), e.g. to reveal if spectra with too few counts are more likely to be misclassified</span>
</span><span id="plot_misclassification_statistics-818"><a href="#plot_misclassification_statistics-818"><span class="linenos">818</span></a>
</span><span id="plot_misclassification_statistics-819"><a href="#plot_misclassification_statistics-819"><span class="linenos">819</span></a><span class="sd">    In addition, a threshold can be adjusted for each subplot. It can serve as a decision boundary in a measurement and</span>
</span><span id="plot_misclassification_statistics-820"><a href="#plot_misclassification_statistics-820"><span class="linenos">820</span></a><span class="sd">    classification routine, deciding whether to trust a prediction or not. They can be altered below.</span>
</span><span id="plot_misclassification_statistics-821"><a href="#plot_misclassification_statistics-821"><span class="linenos">821</span></a>
</span><span id="plot_misclassification_statistics-822"><a href="#plot_misclassification_statistics-822"><span class="linenos">822</span></a><span class="sd">    As an example, if the accuracy improves significantly when only predictions with `cosine similarity &gt; 0.85` are considered,</span>
</span><span id="plot_misclassification_statistics-823"><a href="#plot_misclassification_statistics-823"><span class="linenos">823</span></a><span class="sd">    this rule can be applied in the measurement routine.</span>
</span><span id="plot_misclassification_statistics-824"><a href="#plot_misclassification_statistics-824"><span class="linenos">824</span></a>
</span><span id="plot_misclassification_statistics-825"><a href="#plot_misclassification_statistics-825"><span class="linenos">825</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="plot_misclassification_statistics-826"><a href="#plot_misclassification_statistics-826"><span class="linenos">826</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="plot_misclassification_statistics-827"><a href="#plot_misclassification_statistics-827"><span class="linenos">827</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="plot_misclassification_statistics-828"><a href="#plot_misclassification_statistics-828"><span class="linenos">828</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="plot_misclassification_statistics-829"><a href="#plot_misclassification_statistics-829"><span class="linenos">829</span></a><span class="sd">    :type class_type: str</span>
</span><span id="plot_misclassification_statistics-830"><a href="#plot_misclassification_statistics-830"><span class="linenos">830</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_misclassification_statistics-831"><a href="#plot_misclassification_statistics-831"><span class="linenos">831</span></a>
</span><span id="plot_misclassification_statistics-832"><a href="#plot_misclassification_statistics-832"><span class="linenos">832</span></a>    <span class="c1"># divide data into correct and erroneous predictions</span>
</span><span id="plot_misclassification_statistics-833"><a href="#plot_misclassification_statistics-833"><span class="linenos">833</span></a>    <span class="n">data_corr</span><span class="p">,</span> <span class="n">data_err</span> <span class="o">=</span> <span class="n">identify_misclassifications</span><span class="p">(</span><span class="n">data_te</span><span class="p">,</span> <span class="n">class_type</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-834"><a href="#plot_misclassification_statistics-834"><span class="linenos">834</span></a>
</span><span id="plot_misclassification_statistics-835"><a href="#plot_misclassification_statistics-835"><span class="linenos">835</span></a>    <span class="c1"># set up empty arrays for all quantities (they will be filled in the loop below)</span>
</span><span id="plot_misclassification_statistics-836"><a href="#plot_misclassification_statistics-836"><span class="linenos">836</span></a>    <span class="n">exp_var_corr</span><span class="p">,</span> <span class="n">exp_var_err</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="plot_misclassification_statistics-837"><a href="#plot_misclassification_statistics-837"><span class="linenos">837</span></a>    <span class="n">exp_var_both</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_var_corr</span><span class="p">,</span> <span class="n">exp_var_err</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-838"><a href="#plot_misclassification_statistics-838"><span class="linenos">838</span></a>
</span><span id="plot_misclassification_statistics-839"><a href="#plot_misclassification_statistics-839"><span class="linenos">839</span></a>    <span class="n">cos_sim_corr</span><span class="p">,</span> <span class="n">cos_sim_err</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="plot_misclassification_statistics-840"><a href="#plot_misclassification_statistics-840"><span class="linenos">840</span></a>    <span class="n">cos_sim_both</span> <span class="o">=</span> <span class="p">[</span><span class="n">cos_sim_corr</span><span class="p">,</span> <span class="n">cos_sim_err</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-841"><a href="#plot_misclassification_statistics-841"><span class="linenos">841</span></a>
</span><span id="plot_misclassification_statistics-842"><a href="#plot_misclassification_statistics-842"><span class="linenos">842</span></a>    <span class="n">abs_corr</span><span class="p">,</span> <span class="n">abs_err</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="plot_misclassification_statistics-843"><a href="#plot_misclassification_statistics-843"><span class="linenos">843</span></a>    <span class="n">abs_both</span> <span class="o">=</span> <span class="p">[</span><span class="n">abs_corr</span><span class="p">,</span> <span class="n">abs_err</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-844"><a href="#plot_misclassification_statistics-844"><span class="linenos">844</span></a>
</span><span id="plot_misclassification_statistics-845"><a href="#plot_misclassification_statistics-845"><span class="linenos">845</span></a>    <span class="n">int_corr</span><span class="p">,</span> <span class="n">int_err</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="plot_misclassification_statistics-846"><a href="#plot_misclassification_statistics-846"><span class="linenos">846</span></a>    <span class="n">int_both</span> <span class="o">=</span> <span class="p">[</span><span class="n">int_corr</span><span class="p">,</span> <span class="n">int_err</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-847"><a href="#plot_misclassification_statistics-847"><span class="linenos">847</span></a>
</span><span id="plot_misclassification_statistics-848"><a href="#plot_misclassification_statistics-848"><span class="linenos">848</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
</span><span id="plot_misclassification_statistics-849"><a href="#plot_misclassification_statistics-849"><span class="linenos">849</span></a>        <span class="p">[</span><span class="n">data_corr</span><span class="p">,</span> <span class="n">data_err</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-850"><a href="#plot_misclassification_statistics-850"><span class="linenos">850</span></a>    <span class="p">):</span>  <span class="c1"># iterate over correct/incorrect data</span>
</span><span id="plot_misclassification_statistics-851"><a href="#plot_misclassification_statistics-851"><span class="linenos">851</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span id="plot_misclassification_statistics-852"><a href="#plot_misclassification_statistics-852"><span class="linenos">852</span></a>            <span class="k">continue</span>  <span class="c1"># skip loop if list is empty</span>
</span><span id="plot_misclassification_statistics-853"><a href="#plot_misclassification_statistics-853"><span class="linenos">853</span></a>
</span><span id="plot_misclassification_statistics-854"><a href="#plot_misclassification_statistics-854"><span class="linenos">854</span></a>        <span class="c1"># extract original and denoised spectra</span>
</span><span id="plot_misclassification_statistics-855"><a href="#plot_misclassification_statistics-855"><span class="linenos">855</span></a>        <span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-856"><a href="#plot_misclassification_statistics-856"><span class="linenos">856</span></a>        <span class="n">denoised_spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;denoised&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-857"><a href="#plot_misclassification_statistics-857"><span class="linenos">857</span></a>
</span><span id="plot_misclassification_statistics-858"><a href="#plot_misclassification_statistics-858"><span class="linenos">858</span></a>        <span class="c1"># calculate explained variance between original and denoised spectra, save to lists</span>
</span><span id="plot_misclassification_statistics-859"><a href="#plot_misclassification_statistics-859"><span class="linenos">859</span></a>        <span class="n">exp_var_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="plot_misclassification_statistics-860"><a href="#plot_misclassification_statistics-860"><span class="linenos">860</span></a>        <span class="k">for</span> <span class="n">ori</span><span class="p">,</span> <span class="n">denoised</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">denoised_spectra</span><span class="p">):</span>
</span><span id="plot_misclassification_statistics-861"><a href="#plot_misclassification_statistics-861"><span class="linenos">861</span></a>            <span class="n">exp_var</span> <span class="o">=</span> <span class="n">calculate_explained_variance</span><span class="p">(</span><span class="n">ori</span><span class="p">,</span> <span class="n">denoised</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-862"><a href="#plot_misclassification_statistics-862"><span class="linenos">862</span></a>            <span class="n">exp_var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp_var</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-863"><a href="#plot_misclassification_statistics-863"><span class="linenos">863</span></a>        <span class="n">exp_var_both</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">exp_var_list</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-864"><a href="#plot_misclassification_statistics-864"><span class="linenos">864</span></a>
</span><span id="plot_misclassification_statistics-865"><a href="#plot_misclassification_statistics-865"><span class="linenos">865</span></a>        <span class="c1"># calculate cosine similarity between original and denoised spectra, save to lists</span>
</span><span id="plot_misclassification_statistics-866"><a href="#plot_misclassification_statistics-866"><span class="linenos">866</span></a>        <span class="n">cos_sim_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="plot_misclassification_statistics-867"><a href="#plot_misclassification_statistics-867"><span class="linenos">867</span></a>            <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">denoised_spectra</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-868"><a href="#plot_misclassification_statistics-868"><span class="linenos">868</span></a>        <span class="p">]</span>
</span><span id="plot_misclassification_statistics-869"><a href="#plot_misclassification_statistics-869"><span class="linenos">869</span></a>        <span class="n">cos_sim_both</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cos_sim_list</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-870"><a href="#plot_misclassification_statistics-870"><span class="linenos">870</span></a>
</span><span id="plot_misclassification_statistics-871"><a href="#plot_misclassification_statistics-871"><span class="linenos">871</span></a>        <span class="c1"># calculate length of scores vector, save to lists</span>
</span><span id="plot_misclassification_statistics-872"><a href="#plot_misclassification_statistics-872"><span class="linenos">872</span></a>        <span class="n">absolute_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-873"><a href="#plot_misclassification_statistics-873"><span class="linenos">873</span></a>        <span class="n">abs_both</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">absolute_values</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-874"><a href="#plot_misclassification_statistics-874"><span class="linenos">874</span></a>
</span><span id="plot_misclassification_statistics-875"><a href="#plot_misclassification_statistics-875"><span class="linenos">875</span></a>        <span class="c1"># calculate integrals of spectra, save to lists</span>
</span><span id="plot_misclassification_statistics-876"><a href="#plot_misclassification_statistics-876"><span class="linenos">876</span></a>        <span class="n">integrals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectra</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-877"><a href="#plot_misclassification_statistics-877"><span class="linenos">877</span></a>        <span class="n">int_both</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">integrals</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-878"><a href="#plot_misclassification_statistics-878"><span class="linenos">878</span></a>
</span><span id="plot_misclassification_statistics-879"><a href="#plot_misclassification_statistics-879"><span class="linenos">879</span></a>    <span class="c1"># define thresholds / decision boundaries (can be altered)</span>
</span><span id="plot_misclassification_statistics-880"><a href="#plot_misclassification_statistics-880"><span class="linenos">880</span></a>    <span class="n">thresh_expvar</span> <span class="o">=</span> <span class="mf">0.95</span>
</span><span id="plot_misclassification_statistics-881"><a href="#plot_misclassification_statistics-881"><span class="linenos">881</span></a>    <span class="n">thresh_cos</span> <span class="o">=</span> <span class="mf">0.95</span>
</span><span id="plot_misclassification_statistics-882"><a href="#plot_misclassification_statistics-882"><span class="linenos">882</span></a>    <span class="n">thresh_int</span> <span class="o">=</span> <span class="mi">2500</span>
</span><span id="plot_misclassification_statistics-883"><a href="#plot_misclassification_statistics-883"><span class="linenos">883</span></a>    <span class="n">thresh_abs</span> <span class="o">=</span> <span class="mf">0.9</span>
</span><span id="plot_misclassification_statistics-884"><a href="#plot_misclassification_statistics-884"><span class="linenos">884</span></a>
</span><span id="plot_misclassification_statistics-885"><a href="#plot_misclassification_statistics-885"><span class="linenos">885</span></a>    <span class="c1"># rearrange lists for plotting</span>
</span><span id="plot_misclassification_statistics-886"><a href="#plot_misclassification_statistics-886"><span class="linenos">886</span></a>    <span class="n">quantities_corr</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_var_corr</span><span class="p">,</span> <span class="n">cos_sim_corr</span><span class="p">,</span> <span class="n">abs_corr</span><span class="p">,</span> <span class="n">int_corr</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-887"><a href="#plot_misclassification_statistics-887"><span class="linenos">887</span></a>    <span class="n">quantities_err</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_var_err</span><span class="p">,</span> <span class="n">cos_sim_err</span><span class="p">,</span> <span class="n">abs_err</span><span class="p">,</span> <span class="n">int_err</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-888"><a href="#plot_misclassification_statistics-888"><span class="linenos">888</span></a>    <span class="n">threshs</span> <span class="o">=</span> <span class="p">[</span><span class="n">thresh_expvar</span><span class="p">,</span> <span class="n">thresh_cos</span><span class="p">,</span> <span class="n">thresh_abs</span><span class="p">,</span> <span class="n">thresh_int</span><span class="p">]</span>
</span><span id="plot_misclassification_statistics-889"><a href="#plot_misclassification_statistics-889"><span class="linenos">889</span></a>
</span><span id="plot_misclassification_statistics-890"><a href="#plot_misclassification_statistics-890"><span class="linenos">890</span></a>    <span class="c1"># set up figure with 3 subplots</span>
</span><span id="plot_misclassification_statistics-891"><a href="#plot_misclassification_statistics-891"><span class="linenos">891</span></a>    <span class="n">n_subplots</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="plot_misclassification_statistics-892"><a href="#plot_misclassification_statistics-892"><span class="linenos">892</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_subplots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_subplots</span><span class="p">))</span>
</span><span id="plot_misclassification_statistics-893"><a href="#plot_misclassification_statistics-893"><span class="linenos">893</span></a>    <span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="plot_misclassification_statistics-894"><a href="#plot_misclassification_statistics-894"><span class="linenos">894</span></a>        <span class="s2">&quot;explained variance ratio between denoised &amp; original spectrum)&quot;</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-895"><a href="#plot_misclassification_statistics-895"><span class="linenos">895</span></a>        <span class="s2">&quot;cosine similarity between denoised &amp; original spectrum&quot;</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-896"><a href="#plot_misclassification_statistics-896"><span class="linenos">896</span></a>        <span class="s2">&quot;absolute value / length of scores vector&quot;</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-897"><a href="#plot_misclassification_statistics-897"><span class="linenos">897</span></a>        <span class="s2">&quot;integral of spectrum (total number of counts)&quot;</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-898"><a href="#plot_misclassification_statistics-898"><span class="linenos">898</span></a>    <span class="p">]</span>
</span><span id="plot_misclassification_statistics-899"><a href="#plot_misclassification_statistics-899"><span class="linenos">899</span></a>
</span><span id="plot_misclassification_statistics-900"><a href="#plot_misclassification_statistics-900"><span class="linenos">900</span></a>    <span class="c1"># iterate over correct / incorrect predictions</span>
</span><span id="plot_misclassification_statistics-901"><a href="#plot_misclassification_statistics-901"><span class="linenos">901</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q_corr</span><span class="p">,</span> <span class="n">q_err</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">quantities_corr</span><span class="p">,</span> <span class="n">quantities_err</span><span class="p">)):</span>
</span><span id="plot_misclassification_statistics-902"><a href="#plot_misclassification_statistics-902"><span class="linenos">902</span></a>        <span class="n">fig2</span><span class="p">,</span> <span class="n">axes2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># set up dummy figure to extract histogram data</span>
</span><span id="plot_misclassification_statistics-903"><a href="#plot_misclassification_statistics-903"><span class="linenos">903</span></a>        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">q_corr</span> <span class="o">+</span> <span class="n">q_err</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">q_corr</span> <span class="o">+</span> <span class="n">q_err</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-904"><a href="#plot_misclassification_statistics-904"><span class="linenos">904</span></a>        <span class="n">n_corr</span><span class="p">,</span> <span class="n">bins_corr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">axes2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="plot_misclassification_statistics-905"><a href="#plot_misclassification_statistics-905"><span class="linenos">905</span></a>            <span class="n">q_corr</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
</span><span id="plot_misclassification_statistics-906"><a href="#plot_misclassification_statistics-906"><span class="linenos">906</span></a>        <span class="p">)</span>  <span class="c1"># histogram data for correct predictions</span>
</span><span id="plot_misclassification_statistics-907"><a href="#plot_misclassification_statistics-907"><span class="linenos">907</span></a>        <span class="n">n_err</span><span class="p">,</span> <span class="n">bins_err</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">axes2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
</span><span id="plot_misclassification_statistics-908"><a href="#plot_misclassification_statistics-908"><span class="linenos">908</span></a>            <span class="n">q_err</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
</span><span id="plot_misclassification_statistics-909"><a href="#plot_misclassification_statistics-909"><span class="linenos">909</span></a>        <span class="p">)</span>  <span class="c1"># histogram data for incorrect predictions</span>
</span><span id="plot_misclassification_statistics-910"><a href="#plot_misclassification_statistics-910"><span class="linenos">910</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>  <span class="c1"># deletes current figure</span>
</span><span id="plot_misclassification_statistics-911"><a href="#plot_misclassification_statistics-911"><span class="linenos">911</span></a>
</span><span id="plot_misclassification_statistics-912"><a href="#plot_misclassification_statistics-912"><span class="linenos">912</span></a>        <span class="c1"># set color for bins below and above threshold</span>
</span><span id="plot_misclassification_statistics-913"><a href="#plot_misclassification_statistics-913"><span class="linenos">913</span></a>        <span class="n">c_corr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lightgrey&quot;</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;green&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">bins_corr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="plot_misclassification_statistics-914"><a href="#plot_misclassification_statistics-914"><span class="linenos">914</span></a>        <span class="n">c_err</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lightgrey&quot;</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">bins_err</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="plot_misclassification_statistics-915"><a href="#plot_misclassification_statistics-915"><span class="linenos">915</span></a>
</span><span id="plot_misclassification_statistics-916"><a href="#plot_misclassification_statistics-916"><span class="linenos">916</span></a>        <span class="c1"># calculate number of correct &amp; incorrect predictions above threshold</span>
</span><span id="plot_misclassification_statistics-917"><a href="#plot_misclassification_statistics-917"><span class="linenos">917</span></a>        <span class="n">n_corr_thresh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">q_corr</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="plot_misclassification_statistics-918"><a href="#plot_misclassification_statistics-918"><span class="linenos">918</span></a>        <span class="n">n_err_thresh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">q_err</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="plot_misclassification_statistics-919"><a href="#plot_misclassification_statistics-919"><span class="linenos">919</span></a>
</span><span id="plot_misclassification_statistics-920"><a href="#plot_misclassification_statistics-920"><span class="linenos">920</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># first three subplots</span>
</span><span id="plot_misclassification_statistics-921"><a href="#plot_misclassification_statistics-921"><span class="linenos">921</span></a>            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># cos sim and exp. var. are normalized values</span>
</span><span id="plot_misclassification_statistics-922"><a href="#plot_misclassification_statistics-922"><span class="linenos">922</span></a>
</span><span id="plot_misclassification_statistics-923"><a href="#plot_misclassification_statistics-923"><span class="linenos">923</span></a>        <span class="k">if</span> <span class="n">n_corr_thresh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_err_thresh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="plot_misclassification_statistics-924"><a href="#plot_misclassification_statistics-924"><span class="linenos">924</span></a>            <span class="n">acc_thresh</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="plot_misclassification_statistics-925"><a href="#plot_misclassification_statistics-925"><span class="linenos">925</span></a>
</span><span id="plot_misclassification_statistics-926"><a href="#plot_misclassification_statistics-926"><span class="linenos">926</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># calculate accuracy in relevant part of histogram (above/below threshold)</span>
</span><span id="plot_misclassification_statistics-927"><a href="#plot_misclassification_statistics-927"><span class="linenos">927</span></a>            <span class="n">acc_thresh</span> <span class="o">=</span> <span class="n">n_corr_thresh</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_corr_thresh</span> <span class="o">+</span> <span class="n">n_err_thresh</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-928"><a href="#plot_misclassification_statistics-928"><span class="linenos">928</span></a>        <span class="n">ratio_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_corr_thresh</span> <span class="o">+</span> <span class="n">n_err_thresh</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_te</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-929"><a href="#plot_misclassification_statistics-929"><span class="linenos">929</span></a>
</span><span id="plot_misclassification_statistics-930"><a href="#plot_misclassification_statistics-930"><span class="linenos">930</span></a>        <span class="c1"># plot histogram</span>
</span><span id="plot_misclassification_statistics-931"><a href="#plot_misclassification_statistics-931"><span class="linenos">931</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="plot_misclassification_statistics-932"><a href="#plot_misclassification_statistics-932"><span class="linenos">932</span></a>            <span class="n">bins_corr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="plot_misclassification_statistics-933"><a href="#plot_misclassification_statistics-933"><span class="linenos">933</span></a>            <span class="n">n_corr</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-934"><a href="#plot_misclassification_statistics-934"><span class="linenos">934</span></a>            <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="n">bins_corr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins_corr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="plot_misclassification_statistics-935"><a href="#plot_misclassification_statistics-935"><span class="linenos">935</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">c_corr</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-936"><a href="#plot_misclassification_statistics-936"><span class="linenos">936</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-937"><a href="#plot_misclassification_statistics-937"><span class="linenos">937</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-938"><a href="#plot_misclassification_statistics-938"><span class="linenos">938</span></a>        <span class="p">)</span>
</span><span id="plot_misclassification_statistics-939"><a href="#plot_misclassification_statistics-939"><span class="linenos">939</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="plot_misclassification_statistics-940"><a href="#plot_misclassification_statistics-940"><span class="linenos">940</span></a>            <span class="n">bins_err</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="plot_misclassification_statistics-941"><a href="#plot_misclassification_statistics-941"><span class="linenos">941</span></a>            <span class="o">-</span><span class="n">n_err</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-942"><a href="#plot_misclassification_statistics-942"><span class="linenos">942</span></a>            <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="n">bins_err</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins_err</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="plot_misclassification_statistics-943"><a href="#plot_misclassification_statistics-943"><span class="linenos">943</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">c_err</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-944"><a href="#plot_misclassification_statistics-944"><span class="linenos">944</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-945"><a href="#plot_misclassification_statistics-945"><span class="linenos">945</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="plot_misclassification_statistics-946"><a href="#plot_misclassification_statistics-946"><span class="linenos">946</span></a>        <span class="p">)</span>
</span><span id="plot_misclassification_statistics-947"><a href="#plot_misclassification_statistics-947"><span class="linenos">947</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-948"><a href="#plot_misclassification_statistics-948"><span class="linenos">948</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-949"><a href="#plot_misclassification_statistics-949"><span class="linenos">949</span></a>
</span><span id="plot_misclassification_statistics-950"><a href="#plot_misclassification_statistics-950"><span class="linenos">950</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>  <span class="c1"># horizontal line at y = 0</span>
</span><span id="plot_misclassification_statistics-951"><a href="#plot_misclassification_statistics-951"><span class="linenos">951</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
</span><span id="plot_misclassification_statistics-952"><a href="#plot_misclassification_statistics-952"><span class="linenos">952</span></a>            <span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span>
</span><span id="plot_misclassification_statistics-953"><a href="#plot_misclassification_statistics-953"><span class="linenos">953</span></a>        <span class="p">)</span>  <span class="c1"># vertical line for threshold</span>
</span><span id="plot_misclassification_statistics-954"><a href="#plot_misclassification_statistics-954"><span class="linenos">954</span></a>        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For threshold </span><span class="si">{</span><span class="n">threshs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="se">\n</span><span class="si">{</span><span class="n">ratio_thresh</span><span class="si">:</span><span class="s2"> .1%</span><span class="si">}</span><span class="s2"> of the data can be classified with accuracy </span><span class="si">{</span><span class="n">acc_thresh</span><span class="si">:</span><span class="s2"> .1%</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_misclassification_statistics-955"><a href="#plot_misclassification_statistics-955"><span class="linenos">955</span></a>        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-956"><a href="#plot_misclassification_statistics-956"><span class="linenos">956</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Misclassification statistics&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="plot_misclassification_statistics-957"><a href="#plot_misclassification_statistics-957"><span class="linenos">957</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plots histograms of correct (green) and wrong (red) classifications versus different quantities:</p>

<ul>
<li>explained variance ratio (measure for the explained variance between original &amp; denoised spectrum)</li>
<li>cosine similarity (measure for the similarity between original &amp; denoised spectrum)</li>
<li>integral of the spectrum (number of counts), e.g. to reveal if spectra with too few counts are more likely to be misclassified</li>
</ul>

<p>In addition, a threshold can be adjusted for each subplot. It can serve as a decision boundary in a measurement and
classification routine, deciding whether to trust a prediction or not. They can be altered below.</p>

<p>As an example, if the accuracy improves significantly when only predictions with <code>cosine similarity &gt; 0.85</code> are considered,
this rule can be applied in the measurement routine.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data_te</strong>:  test dataset (list of dictionaries with each dict containing one spectrum and metadata)</li>
<li><strong>class_type</strong>:  can be 'single-label' (use only dominant/first label for each spectrum) or
'multi-label' (use all labels)</li>
</ul>
</div>


                </section>
                <section id="plot_scores_scatter_matrix">
                            <input id="plot_scores_scatter_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_scores_scatter_matrix</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data_tr</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>,</span><span class="param">	<span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>,</span><span class="param">	<span class="n">class_type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>,</span><span class="param">	<span class="n">n_dim_max</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">only_errs</span><span class="p">:</span> <span class="nb">bool</span>,</span><span class="param">	<span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_scores_scatter_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_scores_scatter_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_scores_scatter_matrix-960"><a href="#plot_scores_scatter_matrix-960"><span class="linenos"> 960</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_scores_scatter_matrix</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-961"><a href="#plot_scores_scatter_matrix-961"><span class="linenos"> 961</span></a>    <span class="n">data_tr</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
</span><span id="plot_scores_scatter_matrix-962"><a href="#plot_scores_scatter_matrix-962"><span class="linenos"> 962</span></a>    <span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
</span><span id="plot_scores_scatter_matrix-963"><a href="#plot_scores_scatter_matrix-963"><span class="linenos"> 963</span></a>    <span class="n">class_type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
</span><span id="plot_scores_scatter_matrix-964"><a href="#plot_scores_scatter_matrix-964"><span class="linenos"> 964</span></a>    <span class="n">n_dim_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-965"><a href="#plot_scores_scatter_matrix-965"><span class="linenos"> 965</span></a>    <span class="n">only_errs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-966"><a href="#plot_scores_scatter_matrix-966"><span class="linenos"> 966</span></a>    <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-967"><a href="#plot_scores_scatter_matrix-967"><span class="linenos"> 967</span></a><span class="p">):</span>
</span><span id="plot_scores_scatter_matrix-968"><a href="#plot_scores_scatter_matrix-968"><span class="linenos"> 968</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_scores_scatter_matrix-969"><a href="#plot_scores_scatter_matrix-969"><span class="linenos"> 969</span></a><span class="sd">    Plots n-dimensional scores as scatter matrix, in each subplot opposing two dimensions / principal components.</span>
</span><span id="plot_scores_scatter_matrix-970"><a href="#plot_scores_scatter_matrix-970"><span class="linenos"> 970</span></a><span class="sd">    Each training spectrum is displayed as scatter point, colored by its true label.</span>
</span><span id="plot_scores_scatter_matrix-971"><a href="#plot_scores_scatter_matrix-971"><span class="linenos"> 971</span></a><span class="sd">    Test data are framed in black and colored by their predicted label.</span>
</span><span id="plot_scores_scatter_matrix-972"><a href="#plot_scores_scatter_matrix-972"><span class="linenos"> 972</span></a><span class="sd">    Optionally, only misclassified test data can be displayed (for only_errs = True).</span>
</span><span id="plot_scores_scatter_matrix-973"><a href="#plot_scores_scatter_matrix-973"><span class="linenos"> 973</span></a>
</span><span id="plot_scores_scatter_matrix-974"><a href="#plot_scores_scatter_matrix-974"><span class="linenos"> 974</span></a><span class="sd">    :param data_tr:  training dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="plot_scores_scatter_matrix-975"><a href="#plot_scores_scatter_matrix-975"><span class="linenos"> 975</span></a><span class="sd">    :type data_tr: List[Dict]</span>
</span><span id="plot_scores_scatter_matrix-976"><a href="#plot_scores_scatter_matrix-976"><span class="linenos"> 976</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="plot_scores_scatter_matrix-977"><a href="#plot_scores_scatter_matrix-977"><span class="linenos"> 977</span></a><span class="sd">    :type data_te: List[dict]</span>
</span><span id="plot_scores_scatter_matrix-978"><a href="#plot_scores_scatter_matrix-978"><span class="linenos"> 978</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="plot_scores_scatter_matrix-979"><a href="#plot_scores_scatter_matrix-979"><span class="linenos"> 979</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="plot_scores_scatter_matrix-980"><a href="#plot_scores_scatter_matrix-980"><span class="linenos"> 980</span></a><span class="sd">    :type class_type: List[dict]</span>
</span><span id="plot_scores_scatter_matrix-981"><a href="#plot_scores_scatter_matrix-981"><span class="linenos"> 981</span></a><span class="sd">    :param n_dim_max: maximum number of dimension to be plotted. Default: n_dim = 6</span>
</span><span id="plot_scores_scatter_matrix-982"><a href="#plot_scores_scatter_matrix-982"><span class="linenos"> 982</span></a><span class="sd">    :type n_dim_max: int</span>
</span><span id="plot_scores_scatter_matrix-983"><a href="#plot_scores_scatter_matrix-983"><span class="linenos"> 983</span></a><span class="sd">    :param only_errs: option to plot only misclassified test data. Default: only_errs = True</span>
</span><span id="plot_scores_scatter_matrix-984"><a href="#plot_scores_scatter_matrix-984"><span class="linenos"> 984</span></a><span class="sd">    :type only_errs: bool</span>
</span><span id="plot_scores_scatter_matrix-985"><a href="#plot_scores_scatter_matrix-985"><span class="linenos"> 985</span></a><span class="sd">    :param save_plot: option to save the plot</span>
</span><span id="plot_scores_scatter_matrix-986"><a href="#plot_scores_scatter_matrix-986"><span class="linenos"> 986</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="plot_scores_scatter_matrix-987"><a href="#plot_scores_scatter_matrix-987"><span class="linenos"> 987</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_scores_scatter_matrix-988"><a href="#plot_scores_scatter_matrix-988"><span class="linenos"> 988</span></a>
</span><span id="plot_scores_scatter_matrix-989"><a href="#plot_scores_scatter_matrix-989"><span class="linenos"> 989</span></a>    <span class="k">if</span> <span class="n">only_errs</span><span class="p">:</span>  <span class="c1"># option to show only misclassified test data</span>
</span><span id="plot_scores_scatter_matrix-990"><a href="#plot_scores_scatter_matrix-990"><span class="linenos"> 990</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">data_te</span> <span class="o">=</span> <span class="n">identify_misclassifications</span><span class="p">(</span><span class="n">data_te</span><span class="p">,</span> <span class="n">class_type</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-991"><a href="#plot_scores_scatter_matrix-991"><span class="linenos"> 991</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-992"><a href="#plot_scores_scatter_matrix-992"><span class="linenos"> 992</span></a>            <span class="s2">&quot;In plot_scores_scatter_matrix, only misclassified test data are displayed.&quot;</span>
</span><span id="plot_scores_scatter_matrix-993"><a href="#plot_scores_scatter_matrix-993"><span class="linenos"> 993</span></a>        <span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-994"><a href="#plot_scores_scatter_matrix-994"><span class="linenos"> 994</span></a>
</span><span id="plot_scores_scatter_matrix-995"><a href="#plot_scores_scatter_matrix-995"><span class="linenos"> 995</span></a>    <span class="c1"># Choose which random training and test data are displayed</span>
</span><span id="plot_scores_scatter_matrix-996"><a href="#plot_scores_scatter_matrix-996"><span class="linenos"> 996</span></a>    <span class="n">n_spectra_tr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_tr</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-997"><a href="#plot_scores_scatter_matrix-997"><span class="linenos"> 997</span></a>    <span class="n">n_spectra_te</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_te</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-998"><a href="#plot_scores_scatter_matrix-998"><span class="linenos"> 998</span></a>    <span class="n">ind_tr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-999"><a href="#plot_scores_scatter_matrix-999"><span class="linenos"> 999</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_spectra_tr</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_spectra_tr</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>
</span><span id="plot_scores_scatter_matrix-1000"><a href="#plot_scores_scatter_matrix-1000"><span class="linenos">1000</span></a>    <span class="p">)</span>  <span class="c1"># limit displayed training data</span>
</span><span id="plot_scores_scatter_matrix-1001"><a href="#plot_scores_scatter_matrix-1001"><span class="linenos">1001</span></a>    <span class="n">ind_te</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1002"><a href="#plot_scores_scatter_matrix-1002"><span class="linenos">1002</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_spectra_te</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_spectra_te</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
</span><span id="plot_scores_scatter_matrix-1003"><a href="#plot_scores_scatter_matrix-1003"><span class="linenos">1003</span></a>    <span class="p">)</span>  <span class="c1"># limit displayed test data</span>
</span><span id="plot_scores_scatter_matrix-1004"><a href="#plot_scores_scatter_matrix-1004"><span class="linenos">1004</span></a>    <span class="n">data_tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_tr</span><span class="p">]</span>
</span><span id="plot_scores_scatter_matrix-1005"><a href="#plot_scores_scatter_matrix-1005"><span class="linenos">1005</span></a>    <span class="n">data_te</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_te</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_te</span><span class="p">]</span>
</span><span id="plot_scores_scatter_matrix-1006"><a href="#plot_scores_scatter_matrix-1006"><span class="linenos">1006</span></a>
</span><span id="plot_scores_scatter_matrix-1007"><a href="#plot_scores_scatter_matrix-1007"><span class="linenos">1007</span></a>    <span class="c1"># extract scores of training and test data</span>
</span><span id="plot_scores_scatter_matrix-1008"><a href="#plot_scores_scatter_matrix-1008"><span class="linenos">1008</span></a>    <span class="n">scores_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_tr</span><span class="p">])</span>
</span><span id="plot_scores_scatter_matrix-1009"><a href="#plot_scores_scatter_matrix-1009"><span class="linenos">1009</span></a>    <span class="n">scores_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span><span class="p">])</span>
</span><span id="plot_scores_scatter_matrix-1010"><a href="#plot_scores_scatter_matrix-1010"><span class="linenos">1010</span></a>
</span><span id="plot_scores_scatter_matrix-1011"><a href="#plot_scores_scatter_matrix-1011"><span class="linenos">1011</span></a>    <span class="c1"># extract labels from training and test data, assign to colors</span>
</span><span id="plot_scores_scatter_matrix-1012"><a href="#plot_scores_scatter_matrix-1012"><span class="linenos">1012</span></a>    <span class="n">labels_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_tr</span><span class="p">])</span>
</span><span id="plot_scores_scatter_matrix-1013"><a href="#plot_scores_scatter_matrix-1013"><span class="linenos">1013</span></a>    <span class="n">labels_pred</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span><span class="p">]</span>
</span><span id="plot_scores_scatter_matrix-1014"><a href="#plot_scores_scatter_matrix-1014"><span class="linenos">1014</span></a>    <span class="n">c_tr</span><span class="p">,</span> <span class="n">color_dict</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">labels_tr</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1015"><a href="#plot_scores_scatter_matrix-1015"><span class="linenos">1015</span></a>    <span class="n">c_pr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">labels_pred</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1016"><a href="#plot_scores_scatter_matrix-1016"><span class="linenos">1016</span></a>
</span><span id="plot_scores_scatter_matrix-1017"><a href="#plot_scores_scatter_matrix-1017"><span class="linenos">1017</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="plot_scores_scatter_matrix-1018"><a href="#plot_scores_scatter_matrix-1018"><span class="linenos">1018</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1019"><a href="#plot_scores_scatter_matrix-1019"><span class="linenos">1019</span></a>            <span class="s2">&quot;CAUTION: for the scores scatter matrix, colors only reflect the dominant component of multi-label spectra!&quot;</span>
</span><span id="plot_scores_scatter_matrix-1020"><a href="#plot_scores_scatter_matrix-1020"><span class="linenos">1020</span></a>        <span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1021"><a href="#plot_scores_scatter_matrix-1021"><span class="linenos">1021</span></a>
</span><span id="plot_scores_scatter_matrix-1022"><a href="#plot_scores_scatter_matrix-1022"><span class="linenos">1022</span></a>    <span class="c1"># determine number of subplots and set up figure</span>
</span><span id="plot_scores_scatter_matrix-1023"><a href="#plot_scores_scatter_matrix-1023"><span class="linenos">1023</span></a>    <span class="n">n_dim_real</span> <span class="o">=</span> <span class="n">scores_tr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="plot_scores_scatter_matrix-1024"><a href="#plot_scores_scatter_matrix-1024"><span class="linenos">1024</span></a>    <span class="n">n_rows</span> <span class="o">=</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1025"><a href="#plot_scores_scatter_matrix-1025"><span class="linenos">1025</span></a>        <span class="n">n_dim_real</span><span class="p">,</span> <span class="n">n_dim_max</span>
</span><span id="plot_scores_scatter_matrix-1026"><a href="#plot_scores_scatter_matrix-1026"><span class="linenos">1026</span></a>    <span class="p">)</span>  <span class="c1"># limit number of displayed principal components</span>
</span><span id="plot_scores_scatter_matrix-1027"><a href="#plot_scores_scatter_matrix-1027"><span class="linenos">1027</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1028"><a href="#plot_scores_scatter_matrix-1028"><span class="linenos">1028</span></a>        <span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="plot_scores_scatter_matrix-1029"><a href="#plot_scores_scatter_matrix-1029"><span class="linenos">1029</span></a>    <span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1030"><a href="#plot_scores_scatter_matrix-1030"><span class="linenos">1030</span></a>
</span><span id="plot_scores_scatter_matrix-1031"><a href="#plot_scores_scatter_matrix-1031"><span class="linenos">1031</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">):</span>  <span class="c1"># iterates over rows (dimensions in latent space)</span>
</span><span id="plot_scores_scatter_matrix-1032"><a href="#plot_scores_scatter_matrix-1032"><span class="linenos">1032</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1033"><a href="#plot_scores_scatter_matrix-1033"><span class="linenos">1033</span></a>            <span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="plot_scores_scatter_matrix-1034"><a href="#plot_scores_scatter_matrix-1034"><span class="linenos">1034</span></a>        <span class="p">):</span>  <span class="c1"># iterates over columns (dimensions in latent space)</span>
</span><span id="plot_scores_scatter_matrix-1035"><a href="#plot_scores_scatter_matrix-1035"><span class="linenos">1035</span></a>            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">k</span><span class="p">:</span>  <span class="c1"># row &lt;= column</span>
</span><span id="plot_scores_scatter_matrix-1036"><a href="#plot_scores_scatter_matrix-1036"><span class="linenos">1036</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1037"><a href="#plot_scores_scatter_matrix-1037"><span class="linenos">1037</span></a>                    <span class="s2">&quot;off&quot;</span>
</span><span id="plot_scores_scatter_matrix-1038"><a href="#plot_scores_scatter_matrix-1038"><span class="linenos">1038</span></a>                <span class="p">)</span>  <span class="c1"># show only lower left triangle of the figure</span>
</span><span id="plot_scores_scatter_matrix-1039"><a href="#plot_scores_scatter_matrix-1039"><span class="linenos">1039</span></a>
</span><span id="plot_scores_scatter_matrix-1040"><a href="#plot_scores_scatter_matrix-1040"><span class="linenos">1040</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># row &gt; column (lower left triangle): oppose dimension j and dimension k</span>
</span><span id="plot_scores_scatter_matrix-1041"><a href="#plot_scores_scatter_matrix-1041"><span class="linenos">1041</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1042"><a href="#plot_scores_scatter_matrix-1042"><span class="linenos">1042</span></a>                    <span class="n">scores_tr</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">scores_tr</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_tr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labels_tr</span>
</span><span id="plot_scores_scatter_matrix-1043"><a href="#plot_scores_scatter_matrix-1043"><span class="linenos">1043</span></a>                <span class="p">)</span>  <span class="c1"># plot training data</span>
</span><span id="plot_scores_scatter_matrix-1044"><a href="#plot_scores_scatter_matrix-1044"><span class="linenos">1044</span></a>
</span><span id="plot_scores_scatter_matrix-1045"><a href="#plot_scores_scatter_matrix-1045"><span class="linenos">1045</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores_te</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># plot test data</span>
</span><span id="plot_scores_scatter_matrix-1046"><a href="#plot_scores_scatter_matrix-1046"><span class="linenos">1046</span></a>                    <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1047"><a href="#plot_scores_scatter_matrix-1047"><span class="linenos">1047</span></a>                        <span class="n">scores_te</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span>
</span><span id="plot_scores_scatter_matrix-1048"><a href="#plot_scores_scatter_matrix-1048"><span class="linenos">1048</span></a>                        <span class="n">scores_te</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span>
</span><span id="plot_scores_scatter_matrix-1049"><a href="#plot_scores_scatter_matrix-1049"><span class="linenos">1049</span></a>                        <span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1050"><a href="#plot_scores_scatter_matrix-1050"><span class="linenos">1050</span></a>                        <span class="n">color</span><span class="o">=</span><span class="n">c_pr</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1051"><a href="#plot_scores_scatter_matrix-1051"><span class="linenos">1051</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1052"><a href="#plot_scores_scatter_matrix-1052"><span class="linenos">1052</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1053"><a href="#plot_scores_scatter_matrix-1053"><span class="linenos">1053</span></a>                    <span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1054"><a href="#plot_scores_scatter_matrix-1054"><span class="linenos">1054</span></a>
</span><span id="plot_scores_scatter_matrix-1055"><a href="#plot_scores_scatter_matrix-1055"><span class="linenos">1055</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># remove  legend</span>
</span><span id="plot_scores_scatter_matrix-1056"><a href="#plot_scores_scatter_matrix-1056"><span class="linenos">1056</span></a>
</span><span id="plot_scores_scatter_matrix-1057"><a href="#plot_scores_scatter_matrix-1057"><span class="linenos">1057</span></a>            <span class="c1"># set ticks and ticklabels of subplots</span>
</span><span id="plot_scores_scatter_matrix-1058"><a href="#plot_scores_scatter_matrix-1058"><span class="linenos">1058</span></a>            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="plot_scores_scatter_matrix-1059"><a href="#plot_scores_scatter_matrix-1059"><span class="linenos">1059</span></a>
</span><span id="plot_scores_scatter_matrix-1060"><a href="#plot_scores_scatter_matrix-1060"><span class="linenos">1060</span></a>            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># turn off ticks for all rows but the last one</span>
</span><span id="plot_scores_scatter_matrix-1061"><a href="#plot_scores_scatter_matrix-1061"><span class="linenos">1061</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
</span><span id="plot_scores_scatter_matrix-1062"><a href="#plot_scores_scatter_matrix-1062"><span class="linenos">1062</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1063"><a href="#plot_scores_scatter_matrix-1063"><span class="linenos">1063</span></a>
</span><span id="plot_scores_scatter_matrix-1064"><a href="#plot_scores_scatter_matrix-1064"><span class="linenos">1064</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># labels &amp; ticklabels of last row</span>
</span><span id="plot_scores_scatter_matrix-1065"><a href="#plot_scores_scatter_matrix-1065"><span class="linenos">1065</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1066"><a href="#plot_scores_scatter_matrix-1066"><span class="linenos">1066</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1067"><a href="#plot_scores_scatter_matrix-1067"><span class="linenos">1067</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1068"><a href="#plot_scores_scatter_matrix-1068"><span class="linenos">1068</span></a>
</span><span id="plot_scores_scatter_matrix-1069"><a href="#plot_scores_scatter_matrix-1069"><span class="linenos">1069</span></a>            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># turn off ticks for all columns but the first one</span>
</span><span id="plot_scores_scatter_matrix-1070"><a href="#plot_scores_scatter_matrix-1070"><span class="linenos">1070</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</span><span id="plot_scores_scatter_matrix-1071"><a href="#plot_scores_scatter_matrix-1071"><span class="linenos">1071</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1072"><a href="#plot_scores_scatter_matrix-1072"><span class="linenos">1072</span></a>
</span><span id="plot_scores_scatter_matrix-1073"><a href="#plot_scores_scatter_matrix-1073"><span class="linenos">1073</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># labels &amp; ticklabels of first column</span>
</span><span id="plot_scores_scatter_matrix-1074"><a href="#plot_scores_scatter_matrix-1074"><span class="linenos">1074</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1075"><a href="#plot_scores_scatter_matrix-1075"><span class="linenos">1075</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1076"><a href="#plot_scores_scatter_matrix-1076"><span class="linenos">1076</span></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1077"><a href="#plot_scores_scatter_matrix-1077"><span class="linenos">1077</span></a>
</span><span id="plot_scores_scatter_matrix-1078"><a href="#plot_scores_scatter_matrix-1078"><span class="linenos">1078</span></a>    <span class="c1"># set up legend</span>
</span><span id="plot_scores_scatter_matrix-1079"><a href="#plot_scores_scatter_matrix-1079"><span class="linenos">1079</span></a>    <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">color_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="plot_scores_scatter_matrix-1080"><a href="#plot_scores_scatter_matrix-1080"><span class="linenos">1080</span></a>    <span class="n">tr_marker</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1081"><a href="#plot_scores_scatter_matrix-1081"><span class="linenos">1081</span></a>        <span class="p">[],</span>
</span><span id="plot_scores_scatter_matrix-1082"><a href="#plot_scores_scatter_matrix-1082"><span class="linenos">1082</span></a>        <span class="p">[],</span>
</span><span id="plot_scores_scatter_matrix-1083"><a href="#plot_scores_scatter_matrix-1083"><span class="linenos">1083</span></a>        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1084"><a href="#plot_scores_scatter_matrix-1084"><span class="linenos">1084</span></a>        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1085"><a href="#plot_scores_scatter_matrix-1085"><span class="linenos">1085</span></a>        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1086"><a href="#plot_scores_scatter_matrix-1086"><span class="linenos">1086</span></a>        <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1087"><a href="#plot_scores_scatter_matrix-1087"><span class="linenos">1087</span></a>        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training data&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1088"><a href="#plot_scores_scatter_matrix-1088"><span class="linenos">1088</span></a>    <span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1089"><a href="#plot_scores_scatter_matrix-1089"><span class="linenos">1089</span></a>    <span class="n">te_marker</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1090"><a href="#plot_scores_scatter_matrix-1090"><span class="linenos">1090</span></a>        <span class="p">[],</span>
</span><span id="plot_scores_scatter_matrix-1091"><a href="#plot_scores_scatter_matrix-1091"><span class="linenos">1091</span></a>        <span class="p">[],</span>
</span><span id="plot_scores_scatter_matrix-1092"><a href="#plot_scores_scatter_matrix-1092"><span class="linenos">1092</span></a>        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1093"><a href="#plot_scores_scatter_matrix-1093"><span class="linenos">1093</span></a>        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1094"><a href="#plot_scores_scatter_matrix-1094"><span class="linenos">1094</span></a>        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1095"><a href="#plot_scores_scatter_matrix-1095"><span class="linenos">1095</span></a>        <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1096"><a href="#plot_scores_scatter_matrix-1096"><span class="linenos">1096</span></a>        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1097"><a href="#plot_scores_scatter_matrix-1097"><span class="linenos">1097</span></a>        <span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1098"><a href="#plot_scores_scatter_matrix-1098"><span class="linenos">1098</span></a>        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test data&quot;</span><span class="p">,</span>
</span><span id="plot_scores_scatter_matrix-1099"><a href="#plot_scores_scatter_matrix-1099"><span class="linenos">1099</span></a>    <span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1100"><a href="#plot_scores_scatter_matrix-1100"><span class="linenos">1100</span></a>
</span><span id="plot_scores_scatter_matrix-1101"><a href="#plot_scores_scatter_matrix-1101"><span class="linenos">1101</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1102"><a href="#plot_scores_scatter_matrix-1102"><span class="linenos">1102</span></a>        <span class="n">handles</span><span class="o">=</span><span class="n">patches</span> <span class="o">+</span> <span class="p">[</span><span class="n">tr_marker</span><span class="p">,</span> <span class="n">te_marker</span><span class="p">],</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span>
</span><span id="plot_scores_scatter_matrix-1103"><a href="#plot_scores_scatter_matrix-1103"><span class="linenos">1103</span></a>    <span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1104"><a href="#plot_scores_scatter_matrix-1104"><span class="linenos">1104</span></a>
</span><span id="plot_scores_scatter_matrix-1105"><a href="#plot_scores_scatter_matrix-1105"><span class="linenos">1105</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Spectra in latent space: Scores as scatter matrix&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1106"><a href="#plot_scores_scatter_matrix-1106"><span class="linenos">1106</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="plot_scores_scatter_matrix-1107"><a href="#plot_scores_scatter_matrix-1107"><span class="linenos">1107</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="plot_scores_scatter_matrix-1108"><a href="#plot_scores_scatter_matrix-1108"><span class="linenos">1108</span></a>
</span><span id="plot_scores_scatter_matrix-1109"><a href="#plot_scores_scatter_matrix-1109"><span class="linenos">1109</span></a>    <span class="c1"># optionally: save plot to folder</span>
</span><span id="plot_scores_scatter_matrix-1110"><a href="#plot_scores_scatter_matrix-1110"><span class="linenos">1110</span></a>    <span class="n">concatname</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="plot_scores_scatter_matrix-1111"><a href="#plot_scores_scatter_matrix-1111"><span class="linenos">1111</span></a>        <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span>
</span><span id="plot_scores_scatter_matrix-1112"><a href="#plot_scores_scatter_matrix-1112"><span class="linenos">1112</span></a>    <span class="p">)</span>  <span class="c1"># concatenate isotopes to one string as filename</span>
</span><span id="plot_scores_scatter_matrix-1113"><a href="#plot_scores_scatter_matrix-1113"><span class="linenos">1113</span></a>    <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="n">concatname</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Scores_in_scatter_matrix&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plots n-dimensional scores as scatter matrix, in each subplot opposing two dimensions / principal components.
Each training spectrum is displayed as scatter point, colored by its true label.
Test data are framed in black and colored by their predicted label.
Optionally, only misclassified test data can be displayed (for only_errs = True).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data_tr</strong>:   training dataset (list of dictionaries with each dict containing one spectrum and metadata)</li>
<li><strong>data_te</strong>:  test dataset (list of dictionaries with each dict containing one spectrum and metadata)</li>
<li><strong>class_type</strong>:  can be 'single-label' (use only dominant/first label for each spectrum) or
'multi-label' (use all labels)</li>
<li><strong>n_dim_max: maximum number of dimension to be plotted. Default</strong>:  n_dim = 6</li>
<li><strong>only_errs: option to plot only misclassified test data. Default</strong>:  only_errs = True</li>
<li><strong>save_plot</strong>:  option to save the plot</li>
</ul>
</div>


                </section>
                <section id="plot_mean_scores_barplot">
                            <input id="plot_mean_scores_barplot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_mean_scores_barplot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>, </span><span class="param"><span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_mean_scores_barplot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_mean_scores_barplot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_mean_scores_barplot-1116"><a href="#plot_mean_scores_barplot-1116"><span class="linenos">1116</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_mean_scores_barplot</span><span class="p">(</span><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="plot_mean_scores_barplot-1117"><a href="#plot_mean_scores_barplot-1117"><span class="linenos">1117</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_mean_scores_barplot-1118"><a href="#plot_mean_scores_barplot-1118"><span class="linenos">1118</span></a><span class="sd">    Plots the mean of the predicted scores of each isotope as bar plot (x axes: isotopes_tr).</span>
</span><span id="plot_mean_scores_barplot-1119"><a href="#plot_mean_scores_barplot-1119"><span class="linenos">1119</span></a><span class="sd">    For multi-label data containing more than one isotope are ignored, only the first label is taken into account.</span>
</span><span id="plot_mean_scores_barplot-1120"><a href="#plot_mean_scores_barplot-1120"><span class="linenos">1120</span></a><span class="sd">    Only single-label data (not containing background, e.g. simulated spectra) or the combination of one isotope + background are considered.</span>
</span><span id="plot_mean_scores_barplot-1121"><a href="#plot_mean_scores_barplot-1121"><span class="linenos">1121</span></a>
</span><span id="plot_mean_scores_barplot-1122"><a href="#plot_mean_scores_barplot-1122"><span class="linenos">1122</span></a><span class="sd">    For single-label classification of spectral data not containing background, this should lead to distinct bars,</span>
</span><span id="plot_mean_scores_barplot-1123"><a href="#plot_mean_scores_barplot-1123"><span class="linenos">1123</span></a><span class="sd">    each isotope having values close to 1 for its corresponding isotope axis in latent space.</span>
</span><span id="plot_mean_scores_barplot-1124"><a href="#plot_mean_scores_barplot-1124"><span class="linenos">1124</span></a>
</span><span id="plot_mean_scores_barplot-1125"><a href="#plot_mean_scores_barplot-1125"><span class="linenos">1125</span></a><span class="sd">    Reveals if the dimensionality reduction succeeds to map single-label spectra mainly to the correct isotope axis</span>
</span><span id="plot_mean_scores_barplot-1126"><a href="#plot_mean_scores_barplot-1126"><span class="linenos">1126</span></a><span class="sd">    in latent space. This helps to identify which isotopes can be clearly distinguished and which may be mistaken.</span>
</span><span id="plot_mean_scores_barplot-1127"><a href="#plot_mean_scores_barplot-1127"><span class="linenos">1127</span></a>
</span><span id="plot_mean_scores_barplot-1128"><a href="#plot_mean_scores_barplot-1128"><span class="linenos">1128</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="plot_mean_scores_barplot-1129"><a href="#plot_mean_scores_barplot-1129"><span class="linenos">1129</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="plot_mean_scores_barplot-1130"><a href="#plot_mean_scores_barplot-1130"><span class="linenos">1130</span></a><span class="sd">    :param class_type: classification type (can be &#39;single-label&#39; or &#39;multi-label&#39;)</span>
</span><span id="plot_mean_scores_barplot-1131"><a href="#plot_mean_scores_barplot-1131"><span class="linenos">1131</span></a><span class="sd">    :type class_type: str</span>
</span><span id="plot_mean_scores_barplot-1132"><a href="#plot_mean_scores_barplot-1132"><span class="linenos">1132</span></a><span class="sd">    :param save_plot: option to save the plot</span>
</span><span id="plot_mean_scores_barplot-1133"><a href="#plot_mean_scores_barplot-1133"><span class="linenos">1133</span></a><span class="sd">    :type save_plot: bool</span>
</span><span id="plot_mean_scores_barplot-1134"><a href="#plot_mean_scores_barplot-1134"><span class="linenos">1134</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_mean_scores_barplot-1135"><a href="#plot_mean_scores_barplot-1135"><span class="linenos">1135</span></a>
</span><span id="plot_mean_scores_barplot-1136"><a href="#plot_mean_scores_barplot-1136"><span class="linenos">1136</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="plot_mean_scores_barplot-1137"><a href="#plot_mean_scores_barplot-1137"><span class="linenos">1137</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean scores cannot be visualized as bar plot for </span><span class="si">{</span><span class="n">class_type</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1138"><a href="#plot_mean_scores_barplot-1138"><span class="linenos">1138</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="plot_mean_scores_barplot-1139"><a href="#plot_mean_scores_barplot-1139"><span class="linenos">1139</span></a>        <span class="c1"># extract scores and true labels of test data, assign colors</span>
</span><span id="plot_mean_scores_barplot-1140"><a href="#plot_mean_scores_barplot-1140"><span class="linenos">1140</span></a>        <span class="n">scores_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;scores_norm&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span><span class="p">])</span>
</span><span id="plot_mean_scores_barplot-1141"><a href="#plot_mean_scores_barplot-1141"><span class="linenos">1141</span></a>        <span class="n">labels_te</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_te</span><span class="p">]</span>
</span><span id="plot_mean_scores_barplot-1142"><a href="#plot_mean_scores_barplot-1142"><span class="linenos">1142</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">color_dict</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">labels_te</span><span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1143"><a href="#plot_mean_scores_barplot-1143"><span class="linenos">1143</span></a>
</span><span id="plot_mean_scores_barplot-1144"><a href="#plot_mean_scores_barplot-1144"><span class="linenos">1144</span></a>        <span class="c1"># set up figure</span>
</span><span id="plot_mean_scores_barplot-1145"><a href="#plot_mean_scores_barplot-1145"><span class="linenos">1145</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="plot_mean_scores_barplot-1146"><a href="#plot_mean_scores_barplot-1146"><span class="linenos">1146</span></a>        <span class="n">n_iso_tr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="plot_mean_scores_barplot-1147"><a href="#plot_mean_scores_barplot-1147"><span class="linenos">1147</span></a>            <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span>
</span><span id="plot_mean_scores_barplot-1148"><a href="#plot_mean_scores_barplot-1148"><span class="linenos">1148</span></a>        <span class="p">)</span>  <span class="c1"># number of isotopes used in model training</span>
</span><span id="plot_mean_scores_barplot-1149"><a href="#plot_mean_scores_barplot-1149"><span class="linenos">1149</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_iso_tr</span><span class="p">)</span>  <span class="c1"># set up x axis</span>
</span><span id="plot_mean_scores_barplot-1150"><a href="#plot_mean_scores_barplot-1150"><span class="linenos">1150</span></a>        <span class="n">width</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_iso_tr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># calculate width for each x tick</span>
</span><span id="plot_mean_scores_barplot-1151"><a href="#plot_mean_scores_barplot-1151"><span class="linenos">1151</span></a>
</span><span id="plot_mean_scores_barplot-1152"><a href="#plot_mean_scores_barplot-1152"><span class="linenos">1152</span></a>        <span class="k">for</span> <span class="n">ll</span><span class="p">,</span> <span class="n">iso</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
</span><span id="plot_mean_scores_barplot-1153"><a href="#plot_mean_scores_barplot-1153"><span class="linenos">1153</span></a>            <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span>
</span><span id="plot_mean_scores_barplot-1154"><a href="#plot_mean_scores_barplot-1154"><span class="linenos">1154</span></a>        <span class="p">):</span>  <span class="c1"># iterates over isotopes used in model training</span>
</span><span id="plot_mean_scores_barplot-1155"><a href="#plot_mean_scores_barplot-1155"><span class="linenos">1155</span></a>            <span class="c1"># find all scores labelled as iso or iso + background</span>
</span><span id="plot_mean_scores_barplot-1156"><a href="#plot_mean_scores_barplot-1156"><span class="linenos">1156</span></a>            <span class="n">ind_iso</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="plot_mean_scores_barplot-1157"><a href="#plot_mean_scores_barplot-1157"><span class="linenos">1157</span></a>                <span class="n">ii</span>
</span><span id="plot_mean_scores_barplot-1158"><a href="#plot_mean_scores_barplot-1158"><span class="linenos">1158</span></a>                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels_te</span><span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1159"><a href="#plot_mean_scores_barplot-1159"><span class="linenos">1159</span></a>                <span class="k">if</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">lab</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">({</span><span class="n">iso</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">})</span>
</span><span id="plot_mean_scores_barplot-1160"><a href="#plot_mean_scores_barplot-1160"><span class="linenos">1160</span></a>            <span class="p">]</span>
</span><span id="plot_mean_scores_barplot-1161"><a href="#plot_mean_scores_barplot-1161"><span class="linenos">1161</span></a>            <span class="n">ind_iso</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels_te</span><span class="p">)</span> <span class="k">if</span> <span class="n">lab</span> <span class="o">==</span> <span class="n">iso</span><span class="p">]</span>
</span><span id="plot_mean_scores_barplot-1162"><a href="#plot_mean_scores_barplot-1162"><span class="linenos">1162</span></a>            <span class="n">scores_iso</span> <span class="o">=</span> <span class="n">scores_te</span><span class="p">[</span><span class="n">ind_iso</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="plot_mean_scores_barplot-1163"><a href="#plot_mean_scores_barplot-1163"><span class="linenos">1163</span></a>
</span><span id="plot_mean_scores_barplot-1164"><a href="#plot_mean_scores_barplot-1164"><span class="linenos">1164</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores_iso</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># test if any scores are found for isotope iso</span>
</span><span id="plot_mean_scores_barplot-1165"><a href="#plot_mean_scores_barplot-1165"><span class="linenos">1165</span></a>                <span class="n">mean_score_iso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores_iso</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># calculate mean</span>
</span><span id="plot_mean_scores_barplot-1166"><a href="#plot_mean_scores_barplot-1166"><span class="linenos">1166</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="plot_mean_scores_barplot-1167"><a href="#plot_mean_scores_barplot-1167"><span class="linenos">1167</span></a>                    <span class="sa">f</span><span class="s2">&quot;ratio of mean </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> scores on </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> axis: </span><span class="si">{</span><span class="n">mean_score_iso</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="plot_mean_scores_barplot-1168"><a href="#plot_mean_scores_barplot-1168"><span class="linenos">1168</span></a>                <span class="p">)</span>  <span class="c1"># print score of the correct axis</span>
</span><span id="plot_mean_scores_barplot-1169"><a href="#plot_mean_scores_barplot-1169"><span class="linenos">1169</span></a>
</span><span id="plot_mean_scores_barplot-1170"><a href="#plot_mean_scores_barplot-1170"><span class="linenos">1170</span></a>                <span class="c1"># normalize mean scores and standard deviation</span>
</span><span id="plot_mean_scores_barplot-1171"><a href="#plot_mean_scores_barplot-1171"><span class="linenos">1171</span></a>                <span class="n">int_mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_score_iso</span><span class="p">))</span>
</span><span id="plot_mean_scores_barplot-1172"><a href="#plot_mean_scores_barplot-1172"><span class="linenos">1172</span></a>                <span class="n">mean_score_iso</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_mean_scores_barplot-1173"><a href="#plot_mean_scores_barplot-1173"><span class="linenos">1173</span></a>                    <span class="n">mean_score_iso</span> <span class="o">/</span> <span class="n">int_mean_score</span>
</span><span id="plot_mean_scores_barplot-1174"><a href="#plot_mean_scores_barplot-1174"><span class="linenos">1174</span></a>                <span class="p">)</span>  <span class="c1"># normalize mean scores</span>
</span><span id="plot_mean_scores_barplot-1175"><a href="#plot_mean_scores_barplot-1175"><span class="linenos">1175</span></a>                <span class="n">std_score_iso</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="plot_mean_scores_barplot-1176"><a href="#plot_mean_scores_barplot-1176"><span class="linenos">1176</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scores_iso</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">int_mean_score</span>
</span><span id="plot_mean_scores_barplot-1177"><a href="#plot_mean_scores_barplot-1177"><span class="linenos">1177</span></a>                <span class="p">)</span>  <span class="c1"># normalize standard deviation</span>
</span><span id="plot_mean_scores_barplot-1178"><a href="#plot_mean_scores_barplot-1178"><span class="linenos">1178</span></a>
</span><span id="plot_mean_scores_barplot-1179"><a href="#plot_mean_scores_barplot-1179"><span class="linenos">1179</span></a>                <span class="c1"># plot as bar plot, including error bars</span>
</span><span id="plot_mean_scores_barplot-1180"><a href="#plot_mean_scores_barplot-1180"><span class="linenos">1180</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
</span><span id="plot_mean_scores_barplot-1181"><a href="#plot_mean_scores_barplot-1181"><span class="linenos">1181</span></a>                    <span class="n">x</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span>
</span><span id="plot_mean_scores_barplot-1182"><a href="#plot_mean_scores_barplot-1182"><span class="linenos">1182</span></a>                    <span class="n">mean_score_iso</span><span class="p">,</span>
</span><span id="plot_mean_scores_barplot-1183"><a href="#plot_mean_scores_barplot-1183"><span class="linenos">1183</span></a>                    <span class="n">yerr</span><span class="o">=</span><span class="n">std_score_iso</span><span class="p">,</span>
</span><span id="plot_mean_scores_barplot-1184"><a href="#plot_mean_scores_barplot-1184"><span class="linenos">1184</span></a>                    <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="plot_mean_scores_barplot-1185"><a href="#plot_mean_scores_barplot-1185"><span class="linenos">1185</span></a>                    <span class="n">capsize</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
</span><span id="plot_mean_scores_barplot-1186"><a href="#plot_mean_scores_barplot-1186"><span class="linenos">1186</span></a>                    <span class="n">color</span><span class="o">=</span><span class="n">color_dict</span><span class="p">[</span><span class="n">iso</span><span class="p">],</span>
</span><span id="plot_mean_scores_barplot-1187"><a href="#plot_mean_scores_barplot-1187"><span class="linenos">1187</span></a>                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> spectra&quot;</span><span class="p">,</span>
</span><span id="plot_mean_scores_barplot-1188"><a href="#plot_mean_scores_barplot-1188"><span class="linenos">1188</span></a>                <span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1189"><a href="#plot_mean_scores_barplot-1189"><span class="linenos">1189</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1190"><a href="#plot_mean_scores_barplot-1190"><span class="linenos">1190</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span>
</span><span id="plot_mean_scores_barplot-1191"><a href="#plot_mean_scores_barplot-1191"><span class="linenos">1191</span></a>                    <span class="s2">&quot;axis in latent space, corresponding to isotope&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span>
</span><span id="plot_mean_scores_barplot-1192"><a href="#plot_mean_scores_barplot-1192"><span class="linenos">1192</span></a>                <span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1193"><a href="#plot_mean_scores_barplot-1193"><span class="linenos">1193</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;share of scores&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1194"><a href="#plot_mean_scores_barplot-1194"><span class="linenos">1194</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
</span><span id="plot_mean_scores_barplot-1195"><a href="#plot_mean_scores_barplot-1195"><span class="linenos">1195</span></a>                    <span class="sa">f</span><span class="s2">&quot;Share of scores (mean value, aggregated by true labels)&quot;</span><span class="p">,</span>
</span><span id="plot_mean_scores_barplot-1196"><a href="#plot_mean_scores_barplot-1196"><span class="linenos">1196</span></a>                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span><span id="plot_mean_scores_barplot-1197"><a href="#plot_mean_scores_barplot-1197"><span class="linenos">1197</span></a>                <span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1198"><a href="#plot_mean_scores_barplot-1198"><span class="linenos">1198</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.13</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1199"><a href="#plot_mean_scores_barplot-1199"><span class="linenos">1199</span></a>
</span><span id="plot_mean_scores_barplot-1200"><a href="#plot_mean_scores_barplot-1200"><span class="linenos">1200</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="plot_mean_scores_barplot-1201"><a href="#plot_mean_scores_barplot-1201"><span class="linenos">1201</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No spectra found labelled as </span><span class="si">{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1202"><a href="#plot_mean_scores_barplot-1202"><span class="linenos">1202</span></a>
</span><span id="plot_mean_scores_barplot-1203"><a href="#plot_mean_scores_barplot-1203"><span class="linenos">1203</span></a>        <span class="n">concatname</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GlobalVariables</span><span class="o">.</span><span class="n">isotopes_tr</span><span class="p">)</span>
</span><span id="plot_mean_scores_barplot-1204"><a href="#plot_mean_scores_barplot-1204"><span class="linenos">1204</span></a>        <span class="n">saveplot</span><span class="p">(</span><span class="n">save_plot</span><span class="p">,</span> <span class="n">concatname</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;mean_scores_barplot&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plots the mean of the predicted scores of each isotope as bar plot (x axes: isotopes_tr).
For multi-label data containing more than one isotope are ignored, only the first label is taken into account.
Only single-label data (not containing background, e.g. simulated spectra) or the combination of one isotope + background are considered.</p>

<p>For single-label classification of spectral data not containing background, this should lead to distinct bars,
each isotope having values close to 1 for its corresponding isotope axis in latent space.</p>

<p>Reveals if the dimensionality reduction succeeds to map single-label spectra mainly to the correct isotope axis
in latent space. This helps to identify which isotopes can be clearly distinguished and which may be mistaken.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data_te</strong>:  test dataset (list of dictionaries with each dict containing one spectrum and metadata)</li>
<li><strong>class_type</strong>:  classification type (can be 'single-label' or 'multi-label')</li>
<li><strong>save_plot</strong>:  option to save the plot</li>
</ul>
</div>


                </section>
                <section id="identify_misclassifications">
                            <input id="identify_misclassifications-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">identify_misclassifications</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>, </span><span class="param"><span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="identify_misclassifications-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#identify_misclassifications"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="identify_misclassifications-1207"><a href="#identify_misclassifications-1207"><span class="linenos">1207</span></a><span class="k">def</span><span class="w"> </span><span class="nf">identify_misclassifications</span><span class="p">(</span>
</span><span id="identify_misclassifications-1208"><a href="#identify_misclassifications-1208"><span class="linenos">1208</span></a>    <span class="n">data_te</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="identify_misclassifications-1209"><a href="#identify_misclassifications-1209"><span class="linenos">1209</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
</span><span id="identify_misclassifications-1210"><a href="#identify_misclassifications-1210"><span class="linenos">1210</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="identify_misclassifications-1211"><a href="#identify_misclassifications-1211"><span class="linenos">1211</span></a><span class="sd">    Divides test data into datasets with correct / incorrect predictions.</span>
</span><span id="identify_misclassifications-1212"><a href="#identify_misclassifications-1212"><span class="linenos">1212</span></a><span class="sd">    For class_type = &#39;single-label&#39;, only the first label is considered and background is ignored in labels containing</span>
</span><span id="identify_misclassifications-1213"><a href="#identify_misclassifications-1213"><span class="linenos">1213</span></a><span class="sd">    one isotope + background.</span>
</span><span id="identify_misclassifications-1214"><a href="#identify_misclassifications-1214"><span class="linenos">1214</span></a><span class="sd">    For class_type = &#39;multi-label&#39;, all labels are considered and any difference between true and predicted</span>
</span><span id="identify_misclassifications-1215"><a href="#identify_misclassifications-1215"><span class="linenos">1215</span></a><span class="sd">    labels is counted as error.</span>
</span><span id="identify_misclassifications-1216"><a href="#identify_misclassifications-1216"><span class="linenos">1216</span></a>
</span><span id="identify_misclassifications-1217"><a href="#identify_misclassifications-1217"><span class="linenos">1217</span></a><span class="sd">    :param data_te: test dataset (list of dictionaries with each dict containing one spectrum and metadata)</span>
</span><span id="identify_misclassifications-1218"><a href="#identify_misclassifications-1218"><span class="linenos">1218</span></a><span class="sd">    :type data_te: List[Dict]</span>
</span><span id="identify_misclassifications-1219"><a href="#identify_misclassifications-1219"><span class="linenos">1219</span></a><span class="sd">    :param class_type: can be &#39;single-label&#39; (use only dominant/first label for each spectrum) or</span>
</span><span id="identify_misclassifications-1220"><a href="#identify_misclassifications-1220"><span class="linenos">1220</span></a><span class="sd">    &#39;multi-label&#39; (use all labels)</span>
</span><span id="identify_misclassifications-1221"><a href="#identify_misclassifications-1221"><span class="linenos">1221</span></a><span class="sd">    :type class_type: str</span>
</span><span id="identify_misclassifications-1222"><a href="#identify_misclassifications-1222"><span class="linenos">1222</span></a>
</span><span id="identify_misclassifications-1223"><a href="#identify_misclassifications-1223"><span class="linenos">1223</span></a><span class="sd">    :return: data_corr: subset of data_te with correct predictions,</span>
</span><span id="identify_misclassifications-1224"><a href="#identify_misclassifications-1224"><span class="linenos">1224</span></a><span class="sd">            data_err: subset of data_te with incorrect predictions</span>
</span><span id="identify_misclassifications-1225"><a href="#identify_misclassifications-1225"><span class="linenos">1225</span></a><span class="sd">    :rtype: Tuple[List[Dict], List[Dict]]</span>
</span><span id="identify_misclassifications-1226"><a href="#identify_misclassifications-1226"><span class="linenos">1226</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="identify_misclassifications-1227"><a href="#identify_misclassifications-1227"><span class="linenos">1227</span></a>
</span><span id="identify_misclassifications-1228"><a href="#identify_misclassifications-1228"><span class="linenos">1228</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;single-label&quot;</span><span class="p">,</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">]:</span>
</span><span id="identify_misclassifications-1229"><a href="#identify_misclassifications-1229"><span class="linenos">1229</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="identify_misclassifications-1230"><a href="#identify_misclassifications-1230"><span class="linenos">1230</span></a>            <span class="sa">f</span><span class="s1">&#39;Invalid class_type: </span><span class="si">{</span><span class="n">class_type</span><span class="si">}</span><span class="s1">. Must be either &quot;single-label&quot; or &quot;multi-label&quot;.&#39;</span>
</span><span id="identify_misclassifications-1231"><a href="#identify_misclassifications-1231"><span class="linenos">1231</span></a>        <span class="p">)</span>
</span><span id="identify_misclassifications-1232"><a href="#identify_misclassifications-1232"><span class="linenos">1232</span></a>
</span><span id="identify_misclassifications-1233"><a href="#identify_misclassifications-1233"><span class="linenos">1233</span></a>    <span class="c1"># copy data_te (for safe alterations of the variable without affecting it outside of the function)</span>
</span><span id="identify_misclassifications-1234"><a href="#identify_misclassifications-1234"><span class="linenos">1234</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data_te</span><span class="p">)</span>
</span><span id="identify_misclassifications-1235"><a href="#identify_misclassifications-1235"><span class="linenos">1235</span></a>
</span><span id="identify_misclassifications-1236"><a href="#identify_misclassifications-1236"><span class="linenos">1236</span></a>    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;single-label&quot;</span><span class="p">:</span>
</span><span id="identify_misclassifications-1237"><a href="#identify_misclassifications-1237"><span class="linenos">1237</span></a>        <span class="n">labels_te</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>  <span class="c1"># extract true labels of test data</span>
</span><span id="identify_misclassifications-1238"><a href="#identify_misclassifications-1238"><span class="linenos">1238</span></a>
</span><span id="identify_misclassifications-1239"><a href="#identify_misclassifications-1239"><span class="linenos">1239</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
</span><span id="identify_misclassifications-1240"><a href="#identify_misclassifications-1240"><span class="linenos">1240</span></a>            <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">labels_te</span><span class="p">]</span>
</span><span id="identify_misclassifications-1241"><a href="#identify_misclassifications-1241"><span class="linenos">1241</span></a>        <span class="p">):</span>  <span class="c1"># check if data_te contains multi-label data</span>
</span><span id="identify_misclassifications-1242"><a href="#identify_misclassifications-1242"><span class="linenos">1242</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="identify_misclassifications-1243"><a href="#identify_misclassifications-1243"><span class="linenos">1243</span></a>                <span class="sa">f</span><span class="s2">&quot;You chose </span><span class="si">{</span><span class="n">class_type</span><span class="si">=}</span><span class="s2"> but your test data contain multi-label spectra!&quot;</span>
</span><span id="identify_misclassifications-1244"><a href="#identify_misclassifications-1244"><span class="linenos">1244</span></a>            <span class="p">)</span>
</span><span id="identify_misclassifications-1245"><a href="#identify_misclassifications-1245"><span class="linenos">1245</span></a>
</span><span id="identify_misclassifications-1246"><a href="#identify_misclassifications-1246"><span class="linenos">1246</span></a>        <span class="c1"># filter out background from isotope spectra (convert [&#39;Am241&#39;, &#39;background&#39;] to [&#39;Am241&#39;])</span>
</span><span id="identify_misclassifications-1247"><a href="#identify_misclassifications-1247"><span class="linenos">1247</span></a>        <span class="n">labels_te_without_bg</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="identify_misclassifications-1248"><a href="#identify_misclassifications-1248"><span class="linenos">1248</span></a>            <span class="n">l</span> <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
</span><span id="identify_misclassifications-1249"><a href="#identify_misclassifications-1249"><span class="linenos">1249</span></a>            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels_te</span>
</span><span id="identify_misclassifications-1250"><a href="#identify_misclassifications-1250"><span class="linenos">1250</span></a>        <span class="p">]</span>
</span><span id="identify_misclassifications-1251"><a href="#identify_misclassifications-1251"><span class="linenos">1251</span></a>
</span><span id="identify_misclassifications-1252"><a href="#identify_misclassifications-1252"><span class="linenos">1252</span></a>        <span class="c1"># overwrite property &#39;labels&#39; in data with background-filtered labels</span>
</span><span id="identify_misclassifications-1253"><a href="#identify_misclassifications-1253"><span class="linenos">1253</span></a>        <span class="k">for</span> <span class="n">da</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_te_without_bg</span><span class="p">):</span>
</span><span id="identify_misclassifications-1254"><a href="#identify_misclassifications-1254"><span class="linenos">1254</span></a>            <span class="n">da</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lab</span>
</span><span id="identify_misclassifications-1255"><a href="#identify_misclassifications-1255"><span class="linenos">1255</span></a>
</span><span id="identify_misclassifications-1256"><a href="#identify_misclassifications-1256"><span class="linenos">1256</span></a>        <span class="c1"># subdivide data into datasets with correct / incorrect predictions (only first label counts)</span>
</span><span id="identify_misclassifications-1257"><a href="#identify_misclassifications-1257"><span class="linenos">1257</span></a>        <span class="n">data_corr</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="identify_misclassifications-1258"><a href="#identify_misclassifications-1258"><span class="linenos">1258</span></a>            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="identify_misclassifications-1259"><a href="#identify_misclassifications-1259"><span class="linenos">1259</span></a>        <span class="p">]</span>
</span><span id="identify_misclassifications-1260"><a href="#identify_misclassifications-1260"><span class="linenos">1260</span></a>        <span class="n">data_err</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="identify_misclassifications-1261"><a href="#identify_misclassifications-1261"><span class="linenos">1261</span></a>            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="identify_misclassifications-1262"><a href="#identify_misclassifications-1262"><span class="linenos">1262</span></a>        <span class="p">]</span>
</span><span id="identify_misclassifications-1263"><a href="#identify_misclassifications-1263"><span class="linenos">1263</span></a>
</span><span id="identify_misclassifications-1264"><a href="#identify_misclassifications-1264"><span class="linenos">1264</span></a>    <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s2">&quot;multi-label&quot;</span><span class="p">:</span>
</span><span id="identify_misclassifications-1265"><a href="#identify_misclassifications-1265"><span class="linenos">1265</span></a>        <span class="c1"># concatenate list of true and predicted labels for each spectrum: [&#39;Am241&#39;, &#39;Co60&#39;] -&gt; &#39;Am241 Co60&#39;</span>
</span><span id="identify_misclassifications-1266"><a href="#identify_misclassifications-1266"><span class="linenos">1266</span></a>        <span class="n">labels_te</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="identify_misclassifications-1267"><a href="#identify_misclassifications-1267"><span class="linenos">1267</span></a>        <span class="n">labels_pred</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;labels_pred_dict&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><span id="identify_misclassifications-1268"><a href="#identify_misclassifications-1268"><span class="linenos">1268</span></a>
</span><span id="identify_misclassifications-1269"><a href="#identify_misclassifications-1269"><span class="linenos">1269</span></a>        <span class="c1"># subdivide data into datasets with only-correct / incorrect predictions</span>
</span><span id="identify_misclassifications-1270"><a href="#identify_misclassifications-1270"><span class="linenos">1270</span></a>        <span class="n">data_corr</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="identify_misclassifications-1271"><a href="#identify_misclassifications-1271"><span class="linenos">1271</span></a>            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_te</span><span class="p">,</span> <span class="n">labels_pred</span><span class="p">)</span> <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">true</span>
</span><span id="identify_misclassifications-1272"><a href="#identify_misclassifications-1272"><span class="linenos">1272</span></a>        <span class="p">]</span>
</span><span id="identify_misclassifications-1273"><a href="#identify_misclassifications-1273"><span class="linenos">1273</span></a>        <span class="n">data_err</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="identify_misclassifications-1274"><a href="#identify_misclassifications-1274"><span class="linenos">1274</span></a>            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_te</span><span class="p">,</span> <span class="n">labels_pred</span><span class="p">)</span> <span class="k">if</span> <span class="n">pred</span> <span class="o">!=</span> <span class="n">true</span>
</span><span id="identify_misclassifications-1275"><a href="#identify_misclassifications-1275"><span class="linenos">1275</span></a>        <span class="p">]</span>
</span><span id="identify_misclassifications-1276"><a href="#identify_misclassifications-1276"><span class="linenos">1276</span></a>
</span><span id="identify_misclassifications-1277"><a href="#identify_misclassifications-1277"><span class="linenos">1277</span></a>    <span class="k">return</span> <span class="n">data_corr</span><span class="p">,</span> <span class="n">data_err</span>
</span></pre></div>


            <div class="docstring"><p>Divides test data into datasets with correct / incorrect predictions.
For class_type = 'single-label', only the first label is considered and background is ignored in labels containing
one isotope + background.
For class_type = 'multi-label', all labels are considered and any difference between true and predicted
labels is counted as error.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data_te</strong>:  test dataset (list of dictionaries with each dict containing one spectrum and metadata)</li>
<li><strong>class_type</strong>:  can be 'single-label' (use only dominant/first label for each spectrum) or
'multi-label' (use all labels)</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>data_corr: subset of data_te with correct predictions,
          data_err: subset of data_te with incorrect predictions</p>
</blockquote>
</div>


                </section>
                <section id="plot_outlier_confusion">
                            <input id="plot_outlier_confusion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_outlier_confusion</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">test_targets</span>, </span><span class="param"><span class="n">prediction</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_outlier_confusion-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_outlier_confusion"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_outlier_confusion-1280"><a href="#plot_outlier_confusion-1280"><span class="linenos">1280</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_outlier_confusion</span><span class="p">(</span><span class="n">test_targets</span><span class="p">,</span> <span class="n">prediction</span><span class="p">):</span>
</span><span id="plot_outlier_confusion-1281"><a href="#plot_outlier_confusion-1281"><span class="linenos">1281</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_outlier_confusion-1282"><a href="#plot_outlier_confusion-1282"><span class="linenos">1282</span></a><span class="sd">    Plot a confusion matrix to compare actual vs predicted outlier labels.</span>
</span><span id="plot_outlier_confusion-1283"><a href="#plot_outlier_confusion-1283"><span class="linenos">1283</span></a>
</span><span id="plot_outlier_confusion-1284"><a href="#plot_outlier_confusion-1284"><span class="linenos">1284</span></a><span class="sd">    Parameters:</span>
</span><span id="plot_outlier_confusion-1285"><a href="#plot_outlier_confusion-1285"><span class="linenos">1285</span></a><span class="sd">    - test_targets (array-like): True labels of test data (0 for known, 1 for unknown).</span>
</span><span id="plot_outlier_confusion-1286"><a href="#plot_outlier_confusion-1286"><span class="linenos">1286</span></a><span class="sd">    - prediction (array-like): Predicted labels from the model (0 for known, 1 for unknown).</span>
</span><span id="plot_outlier_confusion-1287"><a href="#plot_outlier_confusion-1287"><span class="linenos">1287</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_outlier_confusion-1288"><a href="#plot_outlier_confusion-1288"><span class="linenos">1288</span></a>    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">test_targets</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>
</span><span id="plot_outlier_confusion-1289"><a href="#plot_outlier_confusion-1289"><span class="linenos">1289</span></a>
</span><span id="plot_outlier_confusion-1290"><a href="#plot_outlier_confusion-1290"><span class="linenos">1290</span></a>    <span class="c1"># Plot the confusion matrix using seaborn heatmap</span>
</span><span id="plot_outlier_confusion-1291"><a href="#plot_outlier_confusion-1291"><span class="linenos">1291</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
</span><span id="plot_outlier_confusion-1292"><a href="#plot_outlier_confusion-1292"><span class="linenos">1292</span></a>    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
</span><span id="plot_outlier_confusion-1293"><a href="#plot_outlier_confusion-1293"><span class="linenos">1293</span></a>        <span class="n">cm</span><span class="p">,</span>
</span><span id="plot_outlier_confusion-1294"><a href="#plot_outlier_confusion-1294"><span class="linenos">1294</span></a>        <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="plot_outlier_confusion-1295"><a href="#plot_outlier_confusion-1295"><span class="linenos">1295</span></a>        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span>
</span><span id="plot_outlier_confusion-1296"><a href="#plot_outlier_confusion-1296"><span class="linenos">1296</span></a>        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
</span><span id="plot_outlier_confusion-1297"><a href="#plot_outlier_confusion-1297"><span class="linenos">1297</span></a>        <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="plot_outlier_confusion-1298"><a href="#plot_outlier_confusion-1298"><span class="linenos">1298</span></a>        <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Known </span><span class="se">\n</span><span class="s2">isotope&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown </span><span class="se">\n</span><span class="s2">isotope&quot;</span><span class="p">],</span>
</span><span id="plot_outlier_confusion-1299"><a href="#plot_outlier_confusion-1299"><span class="linenos">1299</span></a>        <span class="n">yticklabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Known </span><span class="se">\n</span><span class="s2">isotope&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown </span><span class="se">\n</span><span class="s2">isotope&quot;</span><span class="p">],</span>
</span><span id="plot_outlier_confusion-1300"><a href="#plot_outlier_confusion-1300"><span class="linenos">1300</span></a>    <span class="p">)</span>
</span><span id="plot_outlier_confusion-1301"><a href="#plot_outlier_confusion-1301"><span class="linenos">1301</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Predicted Labels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="plot_outlier_confusion-1302"><a href="#plot_outlier_confusion-1302"><span class="linenos">1302</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Actual Labels&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="plot_outlier_confusion-1303"><a href="#plot_outlier_confusion-1303"><span class="linenos">1303</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Confusion Matrix&quot;</span><span class="p">)</span>
</span><span id="plot_outlier_confusion-1304"><a href="#plot_outlier_confusion-1304"><span class="linenos">1304</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot a confusion matrix to compare actual vs predicted outlier labels.</p>

<p>Parameters:</p>

<ul>
<li>test_targets (array-like): True labels of test data (0 for known, 1 for unknown).</li>
<li>prediction (array-like): Predicted labels from the model (0 for known, 1 for unknown).</li>
</ul>
</div>


                </section>
                <section id="plot_feature_importance">
                            <input id="plot_feature_importance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_feature_importance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">feature_names</span>, </span><span class="param"><span class="n">y</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_feature_importance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_feature_importance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_feature_importance-1307"><a href="#plot_feature_importance-1307"><span class="linenos">1307</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_feature_importance</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="plot_feature_importance-1308"><a href="#plot_feature_importance-1308"><span class="linenos">1308</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_feature_importance-1309"><a href="#plot_feature_importance-1309"><span class="linenos">1309</span></a><span class="sd">    Visualize feature importance using a scatter plot.</span>
</span><span id="plot_feature_importance-1310"><a href="#plot_feature_importance-1310"><span class="linenos">1310</span></a>
</span><span id="plot_feature_importance-1311"><a href="#plot_feature_importance-1311"><span class="linenos">1311</span></a><span class="sd">    Parameters:</span>
</span><span id="plot_feature_importance-1312"><a href="#plot_feature_importance-1312"><span class="linenos">1312</span></a><span class="sd">    - feature_names (list of str): Names of the features used in the model.</span>
</span><span id="plot_feature_importance-1313"><a href="#plot_feature_importance-1313"><span class="linenos">1313</span></a><span class="sd">    - y (array-like): Importance scores for each feature.</span>
</span><span id="plot_feature_importance-1314"><a href="#plot_feature_importance-1314"><span class="linenos">1314</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_feature_importance-1315"><a href="#plot_feature_importance-1315"><span class="linenos">1315</span></a>    <span class="n">fig_featureimportance</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="plot_feature_importance-1316"><a href="#plot_feature_importance-1316"><span class="linenos">1316</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="plot_feature_importance-1317"><a href="#plot_feature_importance-1317"><span class="linenos">1317</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</span><span id="plot_feature_importance-1318"><a href="#plot_feature_importance-1318"><span class="linenos">1318</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;feature importance / a.u.&quot;</span><span class="p">)</span>
</span><span id="plot_feature_importance-1319"><a href="#plot_feature_importance-1319"><span class="linenos">1319</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Visualize feature importance using a scatter plot.</p>

<p>Parameters:</p>

<ul>
<li>feature_names (list of str): Names of the features used in the model.</li>
<li>y (array-like): Importance scores for each feature.</li>
</ul>
</div>


                </section>
                <section id="plot_fitted_sigmoid">
                            <input id="plot_fitted_sigmoid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_fitted_sigmoid</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">x_data</span>, </span><span class="param"><span class="n">y_data</span>, </span><span class="param"><span class="n">x_fit</span>, </span><span class="param"><span class="n">y_fit</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_fitted_sigmoid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_fitted_sigmoid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_fitted_sigmoid-1322"><a href="#plot_fitted_sigmoid-1322"><span class="linenos">1322</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_fitted_sigmoid</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">x_fit</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">):</span>
</span><span id="plot_fitted_sigmoid-1323"><a href="#plot_fitted_sigmoid-1323"><span class="linenos">1323</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_fitted_sigmoid-1324"><a href="#plot_fitted_sigmoid-1324"><span class="linenos">1324</span></a><span class="sd">    Plot the data points and fitted sigmoid curve for logistic regression on cosine similarity.</span>
</span><span id="plot_fitted_sigmoid-1325"><a href="#plot_fitted_sigmoid-1325"><span class="linenos">1325</span></a>
</span><span id="plot_fitted_sigmoid-1326"><a href="#plot_fitted_sigmoid-1326"><span class="linenos">1326</span></a><span class="sd">    Parameters:</span>
</span><span id="plot_fitted_sigmoid-1327"><a href="#plot_fitted_sigmoid-1327"><span class="linenos">1327</span></a><span class="sd">    - x_data (array-like): X-axis data points (cosine similarity scores).</span>
</span><span id="plot_fitted_sigmoid-1328"><a href="#plot_fitted_sigmoid-1328"><span class="linenos">1328</span></a><span class="sd">    - y_data (array-like): Y-axis data points (outlier labels).</span>
</span><span id="plot_fitted_sigmoid-1329"><a href="#plot_fitted_sigmoid-1329"><span class="linenos">1329</span></a><span class="sd">    - x_fit (array-like): X values for the fitted sigmoid curve.</span>
</span><span id="plot_fitted_sigmoid-1330"><a href="#plot_fitted_sigmoid-1330"><span class="linenos">1330</span></a><span class="sd">    - y_fit (array-like): Y values for the fitted sigmoid curve.</span>
</span><span id="plot_fitted_sigmoid-1331"><a href="#plot_fitted_sigmoid-1331"><span class="linenos">1331</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_fitted_sigmoid-1332"><a href="#plot_fitted_sigmoid-1332"><span class="linenos">1332</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="plot_fitted_sigmoid-1333"><a href="#plot_fitted_sigmoid-1333"><span class="linenos">1333</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Data Points&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="plot_fitted_sigmoid-1334"><a href="#plot_fitted_sigmoid-1334"><span class="linenos">1334</span></a>
</span><span id="plot_fitted_sigmoid-1335"><a href="#plot_fitted_sigmoid-1335"><span class="linenos">1335</span></a>    <span class="c1"># Plot the fitted sigmoid curve (bounded between 0 and 1)</span>
</span><span id="plot_fitted_sigmoid-1336"><a href="#plot_fitted_sigmoid-1336"><span class="linenos">1336</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fitted Sigmoid Curve&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
</span><span id="plot_fitted_sigmoid-1337"><a href="#plot_fitted_sigmoid-1337"><span class="linenos">1337</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Cosine Similarity&quot;</span><span class="p">)</span>
</span><span id="plot_fitted_sigmoid-1338"><a href="#plot_fitted_sigmoid-1338"><span class="linenos">1338</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Outlier Score&quot;</span><span class="p">)</span>
</span><span id="plot_fitted_sigmoid-1339"><a href="#plot_fitted_sigmoid-1339"><span class="linenos">1339</span></a>
</span><span id="plot_fitted_sigmoid-1340"><a href="#plot_fitted_sigmoid-1340"><span class="linenos">1340</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot the data points and fitted sigmoid curve for logistic regression on cosine similarity.</p>

<p>Parameters:</p>

<ul>
<li>x_data (array-like): X-axis data points (cosine similarity scores).</li>
<li>y_data (array-like): Y-axis data points (outlier labels).</li>
<li>x_fit (array-like): X values for the fitted sigmoid curve.</li>
<li>y_fit (array-like): Y values for the fitted sigmoid curve.</li>
</ul>
</div>


                </section>
                <section id="plot_metrics_vs_threshold">
                            <input id="plot_metrics_vs_threshold-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_metrics_vs_threshold</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">thresholds</span>, </span><span class="param"><span class="n">accuracies</span>, </span><span class="param"><span class="n">precisions</span>, </span><span class="param"><span class="n">recalls</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_metrics_vs_threshold-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_metrics_vs_threshold"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_metrics_vs_threshold-1343"><a href="#plot_metrics_vs_threshold-1343"><span class="linenos">1343</span></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_metrics_vs_threshold</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">):</span>
</span><span id="plot_metrics_vs_threshold-1344"><a href="#plot_metrics_vs_threshold-1344"><span class="linenos">1344</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_metrics_vs_threshold-1345"><a href="#plot_metrics_vs_threshold-1345"><span class="linenos">1345</span></a><span class="sd">    Plot accuracy, precision, and recall scores as a function of cosine similarity threshold.</span>
</span><span id="plot_metrics_vs_threshold-1346"><a href="#plot_metrics_vs_threshold-1346"><span class="linenos">1346</span></a>
</span><span id="plot_metrics_vs_threshold-1347"><a href="#plot_metrics_vs_threshold-1347"><span class="linenos">1347</span></a><span class="sd">    Parameters:</span>
</span><span id="plot_metrics_vs_threshold-1348"><a href="#plot_metrics_vs_threshold-1348"><span class="linenos">1348</span></a><span class="sd">    - cuts (array-like): Threshold values for cosine similarity.</span>
</span><span id="plot_metrics_vs_threshold-1349"><a href="#plot_metrics_vs_threshold-1349"><span class="linenos">1349</span></a><span class="sd">    - accuracies (array-like): Accuracy scores for each threshold.</span>
</span><span id="plot_metrics_vs_threshold-1350"><a href="#plot_metrics_vs_threshold-1350"><span class="linenos">1350</span></a><span class="sd">    - precisions (array-like): Precision scores for each threshold.</span>
</span><span id="plot_metrics_vs_threshold-1351"><a href="#plot_metrics_vs_threshold-1351"><span class="linenos">1351</span></a><span class="sd">    - recalls (array-like): Recall scores for each threshold.</span>
</span><span id="plot_metrics_vs_threshold-1352"><a href="#plot_metrics_vs_threshold-1352"><span class="linenos">1352</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_metrics_vs_threshold-1353"><a href="#plot_metrics_vs_threshold-1353"><span class="linenos">1353</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="plot_metrics_vs_threshold-1354"><a href="#plot_metrics_vs_threshold-1354"><span class="linenos">1354</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">)</span>
</span><span id="plot_metrics_vs_threshold-1355"><a href="#plot_metrics_vs_threshold-1355"><span class="linenos">1355</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Precision&quot;</span><span class="p">)</span>
</span><span id="plot_metrics_vs_threshold-1356"><a href="#plot_metrics_vs_threshold-1356"><span class="linenos">1356</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Recall&quot;</span><span class="p">)</span>
</span><span id="plot_metrics_vs_threshold-1357"><a href="#plot_metrics_vs_threshold-1357"><span class="linenos">1357</span></a>
</span><span id="plot_metrics_vs_threshold-1358"><a href="#plot_metrics_vs_threshold-1358"><span class="linenos">1358</span></a>    <span class="c1"># Adding labels and title</span>
</span><span id="plot_metrics_vs_threshold-1359"><a href="#plot_metrics_vs_threshold-1359"><span class="linenos">1359</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;threshold for cosine similarity&quot;</span><span class="p">)</span>
</span><span id="plot_metrics_vs_threshold-1360"><a href="#plot_metrics_vs_threshold-1360"><span class="linenos">1360</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Score&quot;</span><span class="p">)</span>
</span><span id="plot_metrics_vs_threshold-1361"><a href="#plot_metrics_vs_threshold-1361"><span class="linenos">1361</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Choose the desired threshold (here for 10% Outliers in training)&quot;</span><span class="p">)</span>
</span><span id="plot_metrics_vs_threshold-1362"><a href="#plot_metrics_vs_threshold-1362"><span class="linenos">1362</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">thresholds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">thresholds</span><span class="p">))</span>
</span><span id="plot_metrics_vs_threshold-1363"><a href="#plot_metrics_vs_threshold-1363"><span class="linenos">1363</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
</span><span id="plot_metrics_vs_threshold-1364"><a href="#plot_metrics_vs_threshold-1364"><span class="linenos">1364</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="plot_metrics_vs_threshold-1365"><a href="#plot_metrics_vs_threshold-1365"><span class="linenos">1365</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot accuracy, precision, and recall scores as a function of cosine similarity threshold.</p>

<p>Parameters:</p>

<ul>
<li>cuts (array-like): Threshold values for cosine similarity.</li>
<li>accuracies (array-like): Accuracy scores for each threshold.</li>
<li>precisions (array-like): Precision scores for each threshold.</li>
<li>recalls (array-like): Recall scores for each threshold.</li>
</ul>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>